!function(){"use strict";try{if("undefined"!=typeof document){var t=document.createElement("style");t.appendChild(document.createTextNode(':root,:host{--chat-font-family: "Rubik", sans-serif;--chat-font-size-xsmall: 11px;--chat-font-size-small: 13px;--chat-font-size-base: 14px;--chat-font-size-large: 16px;--chat-font-size-header: 16px;--chat-font-weight-regular: 400;--chat-font-weight-medium: 500;--chat-font-weight-semibold: 600;--chat-font-weight-bold: 700;--chat-line-height: 1.5;--chat-primary-color: #111827;--chat-secondary-color: #4B5563;--chat-text-color: #1F2937;--chat-text-secondary-color: #6B7280;--chat-background: #FFFFFF;--chat-background-chat: #F9FAFB;--chat-white: #FFFFFF;--chat-user-message-bg: #FEF3C7;--chat-user-message-text: #92400E;--chat-agent-message-bg: #F3F4F6;--chat-agent-message-text: #1F2937;--chat-border-color: #E5E7EB;--chat-hover-color: #D1D5DB;--chat-accent-color: #4F46E5;--chat-time-color: #9CA3AF;--chat-icon-color: #6B7280;--chat-send-button: #4F46E5;--chat-send-button-hover: #ffffff;--chat-input-background: #FFFFFF;--chat-input-placeholder: #E5E7EB;--chat-light-gray: #f5f5f5;--chat-lighter-gray: #F9FAFB;--chat-border-radius: 16px;--chat-message-border-radius: 12px;--chat-button-border-radius: 50%;--chat-container-padding: 16px;--chat-message-padding: 12px 16px;--chat-message-gap: 12px;--chat-shadow-sm: 0 1px 2px rgba(0, 0, 0, .05);--chat-shadow-md: 0 4px 12px rgba(0, 0, 0, .1);--chat-shadow-lg: 0 4px 20px rgba(0, 0, 0, .1);--poll-bg: #f5f5f5;--question-color: inherit;--option-bg: white;--option-hover-bg: #eee;--radio-border: #ccc;--radio-selected: #007bff;--stats-color: #666;--audio-bg: #f5f5f5;--button-bg: #007bff;--button-hover-bg: #0056b3;--progress-bg: #ddd;--progress-color: #007bff;--time-color: #666}.dark-mode{--chat-primary-color: #4F46E5;--chat-secondary-color: #9CA3AF;--chat-text-color: #E5E7EB;--chat-text-secondary-color: #9CA3AF;--chat-background: #1F2937;--chat-background-chat: #111827;--chat-white: #1F2937;--chat-user-message-bg: #4F46E5;--chat-user-message-text: #FFFFFF;--chat-agent-message-bg: #374151;--chat-agent-message-text: #E5E7EB;--chat-border-color: #374151;--chat-hover-color: #4B5563;--chat-accent-color: #6366F1;--chat-time-color: #9CA3AF;--chat-icon-color: #9CA3AF;--chat-send-button: #4F46E5;--chat-send-button-hover: #6366F1;--chat-input-background: #374151;--chat-input-placeholder: #6B7280;--chat-light-gray: #1F2937;--chat-lighter-gray: #111827;--chat-shadow-sm: 0 1px 2px rgba(0, 0, 0, .3);--chat-shadow-md: 0 4px 12px rgba(0, 0, 0, .4);--chat-shadow-lg: 0 4px 20px rgba(0, 0, 0, .5);--poll-bg: #1F2937;--question-color: #E5E7EB;--option-bg: #111827;--option-hover-bg: #374151;--radio-border: #4B5563;--radio-selected: #4F46E5;--stats-color: #9CA3AF;--audio-bg: #1F2937;--button-bg: #4F46E5;--button-hover-bg: #6366F1;--progress-bg: #4B5563;--progress-color: #4F46E5;--time-color: #9CA3AF}.chat-button,.chat-widget-container,.chat-widget-container *{font-family:var(--chat-font-family);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}.chat-button,.chat-widget-button{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background-color:var(--chat-white);color:var(--chat-text-color);display:flex;justify-content:center;align-items:center;cursor:pointer;box-shadow:var(--chat-shadow-md);z-index:9998;transition:all .3s ease;border:none;padding:0;margin:0;outline:none;text-decoration:none;font-size:inherit;line-height:1;min-width:50px;min-height:50px;max-width:50px;max-height:50px}.chat-widget-button .icon-wrapper{display:flex;align-items:center;justify-content:center;width:25px;height:25px;transition:opacity .15s ease,transform .15s ease;will-change:opacity,transform}.chat-widget-button .icon-wrapper:has(.chat-icon-open){margin-left:-4px}.chat-widget-button .icon-wrapper .chat-icon-open{width:25px;height:25px;display:block}.chat-widget-button .icon-wrapper svg{width:25px;height:25px;display:block}.chat-widget-button .icon-wrapper.icon-exit{opacity:0;transform:rotate(-90deg) scale(.8) translateZ(0)}.chat-widget-button .icon-wrapper.icon-enter{animation:iconEnter .2s ease forwards}@keyframes iconEnter{0%{opacity:0;transform:rotate(90deg) scale(.8) translateZ(0)}to{opacity:1;transform:rotate(0) scale(1) translateZ(0)}}.chat-widget-button.hidden{opacity:0;visibility:hidden;pointer-events:none}.chat-button:hover,.chat-widget-button:hover{transform:scale(1.05)}.notification-badge{position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;background-color:#ef4444;color:var(--chat-white);font-size:12px;display:flex;justify-content:center;align-items:center}.chat-widget-container{position:fixed;bottom:85px;right:20px;width:450px;height:700px;background-color:var(--chat-white);border-radius:16px;box-shadow:var(--chat-shadow-lg);display:flex;flex-direction:column;overflow:hidden;z-index:9999;opacity:0;transform:translateY(20px) scale(.9);pointer-events:none;transition:all .3s ease}.chat-widget-container.visible{opacity:1;transform:translateY(0) scale(1);pointer-events:all}.chat-widget-container.expanded{width:500px;height:800px}.chat-header{display:flex;align-items:center;padding:14px;background-color:var(--chat-white);color:var(--chat-text-color);border-bottom:1px solid var(--chat-border-color)}chat-header{display:flex;width:100%;min-width:0;align-items:center;gap:2px}.header-title{display:flex;align-items:center;gap:5px;flex:1;min-width:0}.back-button{display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;padding:4px;margin-right:4px;color:var(--chat-secondary-color);flex-shrink:0;width:32px;height:32px}.back-button:hover{opacity:.7}.back-button svg{width:20px;height:20px;display:block}.clear-button{display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;padding:6px;color:var(--chat-secondary-color);flex-shrink:0;width:32px;height:32px;border-radius:6px;transition:all .2s ease}.clear-button:hover{background-color:var(--chat-hover-color);color:#ef4444}.clear-button svg{width:18px;height:18px;display:block}.resize-button{display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;padding:6px;color:var(--chat-secondary-color);flex-shrink:0;width:32px;height:32px;border-radius:6px;transition:all .2s ease}.resize-button:hover{background-color:var(--chat-hover-color);color:var(--chat-accent-color)}.resize-button svg{width:18px;height:18px;display:block}.meeting-info{display:flex;flex-direction:column;min-width:0;flex:1;overflow:hidden}.meeting-name{font-size:16px;font-weight:500;margin:0;color:var(--chat-text-color)}.truncate-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}.meeting-subtitle{font-size:12px;font-weight:400;margin:2px 0 0;color:var(--chat-secondary-color)}.truncate-subtitle{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}.connection-status{display:flex;align-items:center;flex-shrink:0}.status-indicator{width:8px;height:8px;border-radius:50%;position:relative;transition:all .3s ease}.status-indicator.connected{background-color:#28a745;box-shadow:0 0 8px #28a745;animation:pulse-green 2s infinite}.status-indicator.disconnected{background-color:#dc3545;box-shadow:0 0 8px #dc3545;animation:pulse-red 2s infinite}@keyframes pulse-green{0%{box-shadow:0 0 #28a745b3}70%{box-shadow:0 0 0 6px #28a74500}to{box-shadow:0 0 #28a74500}}@keyframes pulse-red{0%{box-shadow:0 0 #dc3545b3}70%{box-shadow:0 0 0 6px #dc354500}to{box-shadow:0 0 #dc354500}}.more-options{display:flex;align-items:center;justify-content:center;background:none;border:none;padding:4px;margin-left:4px;cursor:pointer;color:var(--chat-secondary-color);width:28px;height:28px;min-width:28px;flex-shrink:0}.more-options:hover{opacity:.7}.more-options svg{width:20px;height:20px;display:block}.chat-messages{flex:1;overflow-y:auto;padding:16px;background-color:var(--chat-white);display:flex;flex-direction:column;position:relative;scrollbar-width:thin;scrollbar-color:var(--chat-border-color) transparent}.chat-messages::-webkit-scrollbar{width:6px}.chat-messages::-webkit-scrollbar-track{background:transparent}.chat-messages::-webkit-scrollbar-thumb{background-color:var(--chat-border-color);border-radius:6px}.chat-messages::-webkit-scrollbar-thumb:hover{background-color:var(--chat-secondary-color)}.dark-mode .chat-messages{scrollbar-color:var(--chat-secondary-color) rgba(0,0,0,.2)}.dark-mode .chat-messages::-webkit-scrollbar-thumb{background-color:var(--chat-secondary-color)}.dark-mode .chat-messages::-webkit-scrollbar-track{background-color:#0003}.dark-mode .chat-messages::-webkit-scrollbar-thumb:hover{background-color:var(--chat-accent-color)}.messages-container{display:flex;flex-direction:column;gap:3px}.timestamp{align-self:center;font-size:12px;font-weight:400;color:var(--chat-time-color);background-color:var(--chat-white);padding:4px 12px;border-radius:12px;margin:8px 0;box-shadow:var(--chat-shadow-sm)}.message-wrapper{display:flex;max-width:100%;margin-bottom:0;border-radius:16px}.message-wrapper.user{align-self:flex-end;flex-direction:row-reverse}.message-wrapper.agent{align-self:flex-start;display:grid}.avatar-container{width:32px;height:32px;margin:0;flex-shrink:0}.participant-avatar{width:100%;height:100%;border-radius:50%;background-color:var(--chat-light-gray);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600;color:var(--chat-secondary-color)}.message-content{display:flex;flex-direction:column;gap:5px;min-width:0}.message-timestamp{display:flex;align-items:center;gap:6px;font-size:.7rem;color:var(--chat-time-color);margin-top:4px;padding:0 4px;min-width:0}.message-author{font-weight:500;color:var(--chat-secondary-color);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:1;min-width:0}.message-time-separator{color:var(--chat-time-color);font-weight:300;flex-shrink:0}.message-time{color:var(--chat-time-color);font-weight:400;flex-shrink:0}.message-wrapper.user .message-timestamp{justify-content:flex-end}.message-wrapper.agent .message-timestamp{justify-content:flex-start}.message-bubble{padding:10px 14px;border-radius:18px;font-optical-sizing:auto;font-size:.85rem;line-height:1.4;word-break:break-word;font-weight:400;position:relative}.message-bubble p,.message-bubble ul,.message-bubble ol{margin:0;padding:0;list-style:none}.message-bubble.user{background-color:var(--chat-user-message-bg);color:var(--chat-primary-color);border-bottom-right-radius:4px;margin-right:0}.dark-mode .message-bubble.user{color:#f3f4f6}.message-bubble.agent{background-color:var(--chat-light-gray);color:var(--chat-text-color);margin-left:0;width:-moz-fit-content;width:fit-content}.message-wrapper.agent:has(+.message-wrapper.agent) .message-bubble.agent{border-bottom-left-radius:0}.message-wrapper.agent+.message-wrapper.agent .message-bubble.agent{border-top-left-radius:0}.message-status{display:flex;align-items:center;justify-content:flex-end;margin-top:4px}.status-icon{width:16px;height:16px;color:var(--chat-secondary-color)}.typing-indicator{display:flex;align-items:center;margin:0}.typing-indicator .message-bubble.typing{min-width:40px;display:flex;align-items:center;justify-content:center;padding:8px 12px}.typing-indicator .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:var(--chat-secondary-color);margin:0 2px;animation:typing-dot 1.4s infinite ease-in-out both}.typing-indicator .dot:nth-child(1){animation-delay:0s}.typing-indicator .dot:nth-child(2){animation-delay:.2s}.typing-indicator .dot:nth-child(3){animation-delay:.4s}@keyframes typing-dot{0%,80%,to{transform:scale(.8);opacity:.6}40%{transform:scale(1.2);opacity:1}}.chat-input{padding:12px 16px;background-color:var(--chat-white);border-top:1px solid var(--chat-border-color)}.input-container{display:flex;align-items:flex-end;gap:2px;border-radius:28px;padding:5px;transition:background-color .2s ease}.dark-mode .input-container{background-color:#111827;border:1px solid var(--chat-border-color)}.dark-mode .input-container:focus-within{background-color:#1f2937}.input-actions{display:flex;align-items:center;gap:4px;padding-right:4px}.action-button{background:none;border:none;color:var(--chat-secondary-color);cursor:pointer;padding:6px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s ease;width:30px;height:30px;flex-shrink:0}.action-button:hover{background-color:var(--chat-light-gray)}.dark-mode .action-button:hover{background-color:var(--chat-border-color)}.selector-btn{position:relative;transition:all .2s ease}.selector-btn.active{color:#4caf50;background-color:#4caf501a;animation:pulse-selector 2s ease-in-out infinite}.selector-btn.active svg{transform:rotate(15deg)}@keyframes pulse-selector{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}.selector-btn.active:after{content:"";position:absolute;top:4px;right:4px;width:8px;height:8px;background-color:#4caf50;border-radius:50%;animation:blink-dot 1s ease-in-out infinite}.mic-btn{position:relative}.mic-btn.mic-idle{color:var(--chat-secondary-color)}.mic-btn.mic-listening{color:#ef4444;animation:pulse-microphone 1.5s ease-in-out infinite}.mic-btn.mic-error{color:#ef4444}@keyframes pulse-microphone{0%,to{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.8}}.mic-btn.mic-listening:after{content:"";position:absolute;top:4px;right:4px;width:8px;height:8px;background-color:#ef4444;border-radius:50%;animation:blink-dot 1s ease-in-out infinite}@keyframes blink-dot{0%,to{opacity:1}50%{opacity:.3}}.chat-input-notification{position:absolute;bottom:100%;left:0;right:0;margin-bottom:8px;padding:12px 16px;border-radius:8px;font-size:14px;line-height:1.4;box-shadow:var(--chat-shadow-md);animation:slide-up .3s ease-out;z-index:1000}.notification-info{background-color:#dbeafe;color:#1e40af;border-left:4px solid #3B82F6}.notification-error{background-color:#fee2e2;color:#991b1b;border-left:4px solid #EF4444}.dark-mode .notification-info{background-color:#1e3a8a;color:#bfdbfe;border-left-color:#60a5fa}.dark-mode .notification-error{background-color:#7f1d1d;color:#fecaca;border-left-color:#f87171}@keyframes slide-up{0%{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}.input-actions-container{display:flex;align-items:center;gap:4px;justify-content:space-between}.input-field{flex:1;border:none;background:none;padding:0;font-size:14px;color:var(--chat-text-color);outline:none;font-weight:400;min-width:0;resize:none;font-family:var(--chat-font-family);line-height:1.5;min-height:24px;max-height:120px;overflow-y:hidden;box-sizing:border-box}.input-field::-moz-placeholder{color:var(--chat-input-placeholder);font-weight:400}.input-field::placeholder{color:var(--chat-input-placeholder);font-weight:400}.send-button{background-color:var(--chat-primary-color);color:var(--chat-white);border:none;border-radius:50%;width:40px;height:40px;min-width:40px;min-height:40px;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:all .2s ease;flex-shrink:0}.send-button:hover:not(:disabled){transform:scale(1.05)}.send-button:active:not(:disabled){transform:scale(.95)}.send-button:disabled{background-color:var(--chat-time-color);opacity:.15;cursor:not-allowed}.dark-mode .send-button{background-color:var(--chat-accent-color)}.dark-mode .send-button:hover:not(:disabled){background-color:#6366f1}.faq-questions-container{padding:0;display:none;margin-top:auto;margin-bottom:0}.faq-title{font-size:15px;font-weight:600;color:var(--chat-text-color);margin-bottom:16px}.faq-buttons{display:flex;flex-direction:row;gap:12px;flex-wrap:wrap;justify-content:flex-start}.faq-button{background-color:var(--chat-white);color:var(--chat-text-color);border:none;border-radius:50px;padding:12px 20px;font-size:14px;font-weight:400;text-align:center;cursor:pointer;transition:all .2s ease;box-shadow:0 1px 2px #0000000d;white-space:nowrap}.faq-button:hover{background-color:var(--chat-white);box-shadow:0 2px 4px #00000014}.faq-button:active{transform:scale(.98)}.dark-mode .faq-button{background-color:var(--chat-white);color:var(--chat-primary-color)}.dark-mode .faq-button:hover{background-color:var(--chat-white);box-shadow:0 2px 4px #00000026}.typewriter-cursor{display:inline-block;color:var(--chat-primary-color);margin-left:2px;animation:blink-cursor 1s step-end infinite;font-weight:400}@keyframes blink-cursor{0%,50%{opacity:1}51%,to{opacity:0}}.dark-mode .typewriter-cursor{color:var(--chat-white)}.emoji-picker{background-color:var(--chat-white);border:1px solid var(--chat-border-color);border-radius:12px;box-shadow:var(--chat-shadow-lg);padding:12px;max-width:280px;max-height:300px;overflow-y:auto;overflow-x:hidden}.dark-mode .emoji-picker{background-color:var(--chat-lighter-gray);border-color:var(--chat-border-color)}.emoji-picker-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;width:100%}.emoji-picker-item{background:none;border:none;cursor:pointer;font-size:24px;padding:4px;border-radius:6px;transition:all .2s ease;display:flex;align-items:center;justify-content:center;width:32px;height:32px;line-height:1}.emoji-picker-item:hover{background-color:var(--chat-light-gray);transform:scale(1.2)}.dark-mode .emoji-picker-item:hover{background-color:var(--chat-border-color)}.emoji-picker-item:active{transform:scale(1.1)}.emoji-picker::-webkit-scrollbar{width:6px}.emoji-picker::-webkit-scrollbar-track{background:transparent}.emoji-picker::-webkit-scrollbar-thumb{background-color:var(--chat-border-color);border-radius:3px}.emoji-picker::-webkit-scrollbar-thumb:hover{background-color:var(--chat-secondary-color)}.bb-notification-container,.bb-notification,.bb-notification-content{font-family:var(--chat-font-family);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.bb-notification-close{font-family:var(--chat-font-family)}@media (max-width: 480px){.chat-widget-container{width:100%;height:100%;bottom:0;right:0;border-radius:0}.chat-header{border-radius:0}}')),document.head.appendChild(t)}}catch(o){console.error("vite-plugin-css-injected-by-js",o)}}();
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).BuilderBotChat={})}(this,(function(e){"use strict";var t,n,i,s=Object.defineProperty,o=e=>{throw TypeError(e)},r=(e,t,n)=>((e,t,n)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n),a=(e,t,n)=>(((e,t,n)=>{t.has(e)||o("Cannot "+n)})(e,t,"access private method"),n);function c(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}let l={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};function h(e){l=e}const d=/[&<>"']/,u=new RegExp(d.source,"g"),p=/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,m=new RegExp(p.source,"g"),g={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},f=e=>g[e];function b(e,t){if(t){if(d.test(e))return e.replace(u,f)}else if(p.test(e))return e.replace(m,f);return e}const y=/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi;const v=/(^|[^\[])\^/g;function w(e,t){let n="string"==typeof e?e:e.source;t=t||"";const i={replace:(e,t)=>{let s="string"==typeof t?t:t.source;return s=s.replace(v,"$1"),n=n.replace(e,s),i},getRegex:()=>new RegExp(n,t)};return i}function k(e){try{e=encodeURI(e).replace(/%25/g,"%")}catch(t){return null}return e}const x={exec:()=>null};function E(e,t){const n=e.replace(/\|/g,((e,t,n)=>{let i=!1,s=t;for(;--s>=0&&"\\"===n[s];)i=!i;return i?"|":" |"})).split(/ \|/);let i=0;if(n[0].trim()||n.shift(),n.length>0&&!n[n.length-1].trim()&&n.pop(),t)if(n.length>t)n.splice(t);else for(;n.length<t;)n.push("");for(;i<n.length;i++)n[i]=n[i].trim().replace(/\\\|/g,"|");return n}function S(e,t,n){const i=e.length;if(0===i)return"";let s=0;for(;s<i;){if(e.charAt(i-s-1)!==t)break;s++}return e.slice(0,i-s)}function C(e,t,n,i){const s=t.href,o=t.title?b(t.title):null,r=e[1].replace(/\\([\[\]])/g,"$1");if("!"!==e[0].charAt(0)){i.state.inLink=!0;const e={type:"link",raw:n,href:s,title:o,text:r,tokens:i.inlineTokens(r)};return i.state.inLink=!1,e}return{type:"image",raw:n,href:s,title:o,text:b(r)}}class T{constructor(e){r(this,"options"),r(this,"rules"),r(this,"lexer"),this.options=e||l}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(/^ {1,4}/gm,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:S(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],n=function(e,t){const n=e.match(/^(\s+)(?:```)/);if(null===n)return t;const i=n[1];return t.split("\n").map((e=>{const t=e.match(/^\s+/);if(null===t)return e;const[n]=t;return n.length>=i.length?e.slice(i.length):e})).join("\n")}(e,t[3]||"");return{type:"code",raw:e,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(/#$/.test(e)){const t=S(e,"#");this.options.pedantic?e=t.trim():t&&!/ $/.test(t)||(e=t.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:this.lexer.inline(e)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:t[0]}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){const e=S(t[0].replace(/^ *>[ \t]?/gm,""),"\n"),n=this.lexer.state.top;this.lexer.state.top=!0;const i=this.lexer.blockTokens(e);return this.lexer.state.top=n,{type:"blockquote",raw:t[0],tokens:i,text:e}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim();const i=n.length>1,s={type:"list",raw:"",ordered:i,start:i?+n.slice(0,-1):"",loose:!1,items:[]};n=i?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=i?n:"[*+-]");const o=new RegExp(`^( {0,3}${n})((?:[\t ][^\\n]*)?(?:\\n|$))`);let r="",a="",c=!1;for(;e;){let n=!1;if(!(t=o.exec(e)))break;if(this.rules.block.hr.test(e))break;r=t[0],e=e.substring(r.length);let i=t[2].split("\n",1)[0].replace(/^\t+/,(e=>" ".repeat(3*e.length))),l=e.split("\n",1)[0],h=0;this.options.pedantic?(h=2,a=i.trimStart()):(h=t[2].search(/[^ ]/),h=h>4?1:h,a=i.slice(h),h+=t[1].length);let d=!1;if(!i&&/^ *$/.test(l)&&(r+=l+"\n",e=e.substring(l.length+1),n=!0),!n){const t=new RegExp(`^ {0,${Math.min(3,h-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ \t][^\\n]*)?(?:\\n|$))`),n=new RegExp(`^ {0,${Math.min(3,h-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),s=new RegExp(`^ {0,${Math.min(3,h-1)}}(?:\`\`\`|~~~)`),o=new RegExp(`^ {0,${Math.min(3,h-1)}}#`);for(;e;){const c=e.split("\n",1)[0];if(l=c,this.options.pedantic&&(l=l.replace(/^ {1,4}(?=( {4})*[^ ])/g,"  ")),s.test(l))break;if(o.test(l))break;if(t.test(l))break;if(n.test(e))break;if(l.search(/[^ ]/)>=h||!l.trim())a+="\n"+l.slice(h);else{if(d)break;if(i.search(/[^ ]/)>=4)break;if(s.test(i))break;if(o.test(i))break;if(n.test(i))break;a+="\n"+l}d||l.trim()||(d=!0),r+=c+"\n",e=e.substring(c.length+1),i=l.slice(h)}}s.loose||(c?s.loose=!0:/\n *\n *$/.test(r)&&(c=!0));let u,p=null;this.options.gfm&&(p=/^\[[ xX]\] /.exec(a),p&&(u="[ ] "!==p[0],a=a.replace(/^\[[ xX]\] +/,""))),s.items.push({type:"list_item",raw:r,task:!!p,checked:u,loose:!1,text:a,tokens:[]}),s.raw+=r}s.items[s.items.length-1].raw=r.trimEnd(),s.items[s.items.length-1].text=a.trimEnd(),s.raw=s.raw.trimEnd();for(let e=0;e<s.items.length;e++)if(this.lexer.state.top=!1,s.items[e].tokens=this.lexer.blockTokens(s.items[e].text,[]),!s.loose){const t=s.items[e].tokens.filter((e=>"space"===e.type)),n=t.length>0&&t.some((e=>/\n.*\n/.test(e.raw)));s.loose=n}if(s.loose)for(let e=0;e<s.items.length;e++)s.items[e].loose=!0;return s}}html(e){const t=this.rules.block.html.exec(e);if(t){return{type:"html",block:!0,raw:t[0],pre:"pre"===t[1]||"script"===t[1]||"style"===t[1],text:t[0]}}}def(e){const t=this.rules.block.def.exec(e);if(t){const e=t[1].toLowerCase().replace(/\s+/g," "),n=t[2]?t[2].replace(/^<(.*)>$/,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",i=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:e,raw:t[0],href:n,title:i}}}table(e){const t=this.rules.block.table.exec(e);if(!t)return;if(!/[:|]/.test(t[2]))return;const n=E(t[1]),i=t[2].replace(/^\||\| *$/g,"").split("|"),s=t[3]&&t[3].trim()?t[3].replace(/\n[ \t]*$/,"").split("\n"):[],o={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===i.length){for(const e of i)/^ *-+: *$/.test(e)?o.align.push("right"):/^ *:-+: *$/.test(e)?o.align.push("center"):/^ *:-+ *$/.test(e)?o.align.push("left"):o.align.push(null);for(const e of n)o.header.push({text:e,tokens:this.lexer.inline(e)});for(const e of s)o.rows.push(E(e,o.header.length).map((e=>({text:e,tokens:this.lexer.inline(e)}))));return o}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e="\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:e,tokens:this.lexer.inline(e)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:b(t[1])}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&/^<a /i.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&/^<\/a>/i.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&/^</.test(e)){if(!/>$/.test(e))return;const t=S(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;let n=0;for(let i=0;i<e.length;i++)if("\\"===e[i])i++;else if(e[i]===t[0])n++;else if(e[i]===t[1]&&(n--,n<0))return i;return-1}(t[2],"()");if(e>-1){const n=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,n).trim(),t[3]=""}}let n=t[2],i="";if(this.options.pedantic){const e=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(n);e&&(n=e[1],i=e[3])}else i=t[3]?t[3].slice(1,-1):"";return n=n.trim(),/^</.test(n)&&(n=this.options.pedantic&&!/>$/.test(e)?n.slice(1):n.slice(1,-1)),C(t,{href:n?n.replace(this.rules.inline.anyPunctuation,"$1"):n,title:i?i.replace(this.rules.inline.anyPunctuation,"$1"):i},t[0],this.lexer)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){const e=t[(n[2]||n[1]).replace(/\s+/g," ").toLowerCase()];if(!e){const e=n[0].charAt(0);return{type:"text",raw:e,text:e}}return C(n,e,n[0],this.lexer)}}emStrong(e,t,n=""){let i=this.rules.inline.emStrongLDelim.exec(e);if(!i)return;if(i[3]&&n.match(/[\p{L}\p{N}]/u))return;if(!(i[1]||i[2]||"")||!n||this.rules.inline.punctuation.exec(n)){const n=[...i[0]].length-1;let s,o,r=n,a=0;const c="*"===i[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,t=t.slice(-1*e.length+n);null!=(i=c.exec(t));){if(s=i[1]||i[2]||i[3]||i[4]||i[5]||i[6],!s)continue;if(o=[...s].length,i[3]||i[4]){r+=o;continue}if((i[5]||i[6])&&n%3&&!((n+o)%3)){a+=o;continue}if(r-=o,r>0)continue;o=Math.min(o,o+r+a);const t=[...i[0]][0].length,c=e.slice(0,n+i.index+t+o);if(Math.min(n,o)%2){const e=c.slice(1,-1);return{type:"em",raw:c,text:e,tokens:this.lexer.inlineTokens(e)}}const l=c.slice(2,-2);return{type:"strong",raw:c,text:l,tokens:this.lexer.inlineTokens(l)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(/\n/g," ");const n=/[^ ]/.test(e),i=/^ /.test(e)&&/ $/.test(e);return n&&i&&(e=e.substring(1,e.length-1)),e=b(e,!0),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){const t=this.rules.inline.autolink.exec(e);if(t){let e,n;return"@"===t[2]?(e=b(t[1]),n="mailto:"+e):(e=b(t[1]),n=e),{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let e,n;if("@"===t[2])e=b(t[0]),n="mailto:"+e;else{let i;do{i=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??""}while(i!==t[0]);e=b(t[0]),n="www."===t[1]?"http://"+t[0]:t[0]}return{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e){const t=this.rules.inline.text.exec(e);if(t){let e;return e=this.lexer.state.inRawBlock?t[0]:b(t[0]),{type:"text",raw:t[0],text:e}}}}const A=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,M=/(?:[*+-]|\d{1,9}[.)])/,R=w(/^(?!bull )((?:.|\n(?!\s*?\n|bull ))+?)\n {0,3}(=+|-+) *(?:\n+|$)/).replace(/bull/g,M).getRegex(),B=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,_=/(?!\s*\])(?:\\.|[^\[\]\\])+/,L=w(/^ {0,3}\[(label)\]: *(?:\n *)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n *)?| *\n *)(title))? *(?:\n+|$)/).replace("label",_).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),O=w(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,M).getRegex(),I="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",F=/<!--(?!-?>)[\s\S]*?(?:-->|$)/,N=w("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n *)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$))","i").replace("comment",F).replace("tag",I).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),j=w(B).replace("hr",A).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",I).getRegex(),D={blockquote:w(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",j).getRegex(),code:/^( {4}[^\n]+(?:\n(?: *(?:\n|$))*)?)+/,def:L,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:A,html:N,lheading:R,list:O,newline:/^(?: *(?:\n|$))+/,paragraph:j,table:x,text:/^[^\n]+/},H=w("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",A).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",I).getRegex(),P={...D,table:H,paragraph:w(B).replace("hr",A).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",H).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",I).getRegex()},$={...D,html:w("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",F).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:x,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:w(B).replace("hr",A).replace("heading"," *#{1,6} *[^\n]").replace("lheading",R).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},z=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,q=/^( {2,}|\\)\n(?!\s*$)/,U="\\p{P}$+<=>`^|~",W=w(/^((?![*_])[\spunctuation])/,"u").replace(/punctuation/g,U).getRegex(),V=w(/^(?:\*+(?:((?!\*)[punct])|[^\s*]))|^_+(?:((?!_)[punct])|([^\s_]))/,"u").replace(/punct/g,U).getRegex(),Q=w("^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)[punct](\\*+)(?=[\\s]|$)|[^punct\\s](\\*+)(?!\\*)(?=[punct\\s]|$)|(?!\\*)[punct\\s](\\*+)(?=[^punct\\s])|[\\s](\\*+)(?!\\*)(?=[punct])|(?!\\*)[punct](\\*+)(?!\\*)(?=[punct])|[^punct\\s](\\*+)(?=[^punct\\s])","gu").replace(/punct/g,U).getRegex(),J=w("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)[punct](_+)(?=[\\s]|$)|[^punct\\s](_+)(?!_)(?=[punct\\s]|$)|(?!_)[punct\\s](_+)(?=[^punct\\s])|[\\s](_+)(?!_)(?=[punct])|(?!_)[punct](_+)(?!_)(?=[punct])","gu").replace(/punct/g,U).getRegex(),G=w(/\\([punct])/,"gu").replace(/punct/g,U).getRegex(),Y=w(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),K=w(F).replace("(?:--\x3e|$)","--\x3e").getRegex(),Z=w("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",K).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),X=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,ee=w(/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/).replace("label",X).replace("href",/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),te=w(/^!?\[(label)\]\[(ref)\]/).replace("label",X).replace("ref",_).getRegex(),ne=w(/^!?\[(ref)\](?:\[\])?/).replace("ref",_).getRegex(),ie={_backpedal:x,anyPunctuation:G,autolink:Y,blockSkip:/\[[^[\]]*?\]\([^\(\)]*?\)|`[^`]*?`|<[^<>]*?>/g,br:q,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:x,emStrongLDelim:V,emStrongRDelimAst:Q,emStrongRDelimUnd:J,escape:z,link:ee,nolink:ne,punctuation:W,reflink:te,reflinkSearch:w("reflink|nolink(?!\\()","g").replace("reflink",te).replace("nolink",ne).getRegex(),tag:Z,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:x},se={...ie,link:w(/^!?\[(label)\]\((.*?)\)/).replace("label",X).getRegex(),reflink:w(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",X).getRegex()},oe={...ie,escape:w(z).replace("])","~|])").getRegex(),url:w(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])([\s\S]*?[^\s~])\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},re={...oe,br:w(q).replace("{2,}","*").getRegex(),text:w(oe.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},ae={normal:D,gfm:P,pedantic:$},ce={normal:ie,gfm:oe,breaks:re,pedantic:se};class le{constructor(e){r(this,"tokens"),r(this,"options"),r(this,"state"),r(this,"tokenizer"),r(this,"inlineQueue"),this.tokens=[],this.tokens.links=Object.create(null),this.options=e||l,this.options.tokenizer=this.options.tokenizer||new T,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={block:ae.normal,inline:ce.normal};this.options.pedantic?(t.block=ae.pedantic,t.inline=ce.pedantic):this.options.gfm&&(t.block=ae.gfm,this.options.breaks?t.inline=ce.breaks:t.inline=ce.gfm),this.tokenizer.rules=t}static get rules(){return{block:ae,inline:ce}}static lex(e,t){return new le(t).lex(e)}static lexInline(e,t){return new le(t).inlineTokens(e)}lex(e){e=e.replace(/\r\n|\r/g,"\n"),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){const e=this.inlineQueue[t];this.inlineTokens(e.src,e.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[]){let n,i,s,o;for(e=this.options.pedantic?e.replace(/\t/g,"    ").replace(/^ +$/gm,""):e.replace(/^( *)(\t+)/gm,((e,t,n)=>t+"    ".repeat(n.length)));e;)if(!(this.options.extensions&&this.options.extensions.block&&this.options.extensions.block.some((i=>!!(n=i.call({lexer:this},e,t))&&(e=e.substring(n.raw.length),t.push(n),!0)))))if(n=this.tokenizer.space(e))e=e.substring(n.raw.length),1===n.raw.length&&t.length>0?t[t.length-1].raw+="\n":t.push(n);else if(n=this.tokenizer.code(e))e=e.substring(n.raw.length),i=t[t.length-1],!i||"paragraph"!==i.type&&"text"!==i.type?t.push(n):(i.raw+="\n"+n.raw,i.text+="\n"+n.text,this.inlineQueue[this.inlineQueue.length-1].src=i.text);else if(n=this.tokenizer.fences(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.heading(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.hr(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.blockquote(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.list(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.html(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.def(e))e=e.substring(n.raw.length),i=t[t.length-1],!i||"paragraph"!==i.type&&"text"!==i.type?this.tokens.links[n.tag]||(this.tokens.links[n.tag]={href:n.href,title:n.title}):(i.raw+="\n"+n.raw,i.text+="\n"+n.raw,this.inlineQueue[this.inlineQueue.length-1].src=i.text);else if(n=this.tokenizer.table(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.lheading(e))e=e.substring(n.raw.length),t.push(n);else{if(s=e,this.options.extensions&&this.options.extensions.startBlock){let t=1/0;const n=e.slice(1);let i;this.options.extensions.startBlock.forEach((e=>{i=e.call({lexer:this},n),"number"==typeof i&&i>=0&&(t=Math.min(t,i))})),t<1/0&&t>=0&&(s=e.substring(0,t+1))}if(this.state.top&&(n=this.tokenizer.paragraph(s)))i=t[t.length-1],o&&"paragraph"===i.type?(i.raw+="\n"+n.raw,i.text+="\n"+n.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(n),o=s.length!==e.length,e=e.substring(n.raw.length);else if(n=this.tokenizer.text(e))e=e.substring(n.raw.length),i=t[t.length-1],i&&"text"===i.type?(i.raw+="\n"+n.raw,i.text+="\n"+n.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(n);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent)break;throw new Error(t)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n,i,s,o,r,a,c=e;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(o=this.tokenizer.rules.inline.reflinkSearch.exec(c));)e.includes(o[0].slice(o[0].lastIndexOf("[")+1,-1))&&(c=c.slice(0,o.index)+"["+"a".repeat(o[0].length-2)+"]"+c.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(o=this.tokenizer.rules.inline.blockSkip.exec(c));)c=c.slice(0,o.index)+"["+"a".repeat(o[0].length-2)+"]"+c.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;null!=(o=this.tokenizer.rules.inline.anyPunctuation.exec(c));)c=c.slice(0,o.index)+"++"+c.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;e;)if(r||(a=""),r=!1,!(this.options.extensions&&this.options.extensions.inline&&this.options.extensions.inline.some((i=>!!(n=i.call({lexer:this},e,t))&&(e=e.substring(n.raw.length),t.push(n),!0)))))if(n=this.tokenizer.escape(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.tag(e))e=e.substring(n.raw.length),i=t[t.length-1],i&&"text"===n.type&&"text"===i.type?(i.raw+=n.raw,i.text+=n.text):t.push(n);else if(n=this.tokenizer.link(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.reflink(e,this.tokens.links))e=e.substring(n.raw.length),i=t[t.length-1],i&&"text"===n.type&&"text"===i.type?(i.raw+=n.raw,i.text+=n.text):t.push(n);else if(n=this.tokenizer.emStrong(e,c,a))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.codespan(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.br(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.del(e))e=e.substring(n.raw.length),t.push(n);else if(n=this.tokenizer.autolink(e))e=e.substring(n.raw.length),t.push(n);else if(this.state.inLink||!(n=this.tokenizer.url(e))){if(s=e,this.options.extensions&&this.options.extensions.startInline){let t=1/0;const n=e.slice(1);let i;this.options.extensions.startInline.forEach((e=>{i=e.call({lexer:this},n),"number"==typeof i&&i>=0&&(t=Math.min(t,i))})),t<1/0&&t>=0&&(s=e.substring(0,t+1))}if(n=this.tokenizer.inlineText(s))e=e.substring(n.raw.length),"_"!==n.raw.slice(-1)&&(a=n.raw.slice(-1)),r=!0,i=t[t.length-1],i&&"text"===i.type?(i.raw+=n.raw,i.text+=n.text):t.push(n);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent)break;throw new Error(t)}}else e=e.substring(n.raw.length),t.push(n);return t}}class he{constructor(e){r(this,"options"),this.options=e||l}code(e,t,n){const i=(t||"").match(/^\S*/)?.[0];return e=e.replace(/\n$/,"")+"\n",i?'<pre><code class="language-'+b(i)+'">'+(n?e:b(e,!0))+"</code></pre>\n":"<pre><code>"+(n?e:b(e,!0))+"</code></pre>\n"}blockquote(e){return`<blockquote>\n${e}</blockquote>\n`}html(e,t){return e}heading(e,t,n){return`<h${t}>${e}</h${t}>\n`}hr(){return"<hr>\n"}list(e,t,n){const i=t?"ol":"ul";return"<"+i+(t&&1!==n?' start="'+n+'"':"")+">\n"+e+"</"+i+">\n"}listitem(e,t,n){return`<li>${e}</li>\n`}checkbox(e){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph(e){return`<p>${e}</p>\n`}table(e,t){return t&&(t=`<tbody>${t}</tbody>`),"<table>\n<thead>\n"+e+"</thead>\n"+t+"</table>\n"}tablerow(e){return`<tr>\n${e}</tr>\n`}tablecell(e,t){const n=t.header?"th":"td";return(t.align?`<${n} align="${t.align}">`:`<${n}>`)+e+`</${n}>\n`}strong(e){return`<strong>${e}</strong>`}em(e){return`<em>${e}</em>`}codespan(e){return`<code>${e}</code>`}br(){return"<br>"}del(e){return`<del>${e}</del>`}link(e,t,n){const i=k(e);if(null===i)return n;let s='<a href="'+(e=i)+'"';return t&&(s+=' title="'+t+'"'),s+=">"+n+"</a>",s}image(e,t,n){const i=k(e);if(null===i)return n;let s=`<img src="${e=i}" alt="${n}"`;return t&&(s+=` title="${t}"`),s+=">",s}text(e){return e}}class de{strong(e){return e}em(e){return e}codespan(e){return e}del(e){return e}html(e){return e}text(e){return e}link(e,t,n){return""+n}image(e,t,n){return""+n}br(){return""}}class ue{constructor(e){r(this,"options"),r(this,"renderer"),r(this,"textRenderer"),this.options=e||l,this.options.renderer=this.options.renderer||new he,this.renderer=this.options.renderer,this.renderer.options=this.options,this.textRenderer=new de}static parse(e,t){return new ue(t).parse(e)}static parseInline(e,t){return new ue(t).parseInline(e)}parse(e,t=!0){let n="";for(let i=0;i<e.length;i++){const s=e[i];if(this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[s.type]){const e=s,t=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==t||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){n+=t||"";continue}}switch(s.type){case"space":continue;case"hr":n+=this.renderer.hr();continue;case"heading":{const e=s;n+=this.renderer.heading(this.parseInline(e.tokens),e.depth,this.parseInline(e.tokens,this.textRenderer).replace(y,((e,t)=>"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):"")));continue}case"code":{const e=s;n+=this.renderer.code(e.text,e.lang,!!e.escaped);continue}case"table":{const e=s;let t="",i="";for(let n=0;n<e.header.length;n++)i+=this.renderer.tablecell(this.parseInline(e.header[n].tokens),{header:!0,align:e.align[n]});t+=this.renderer.tablerow(i);let o="";for(let n=0;n<e.rows.length;n++){const t=e.rows[n];i="";for(let n=0;n<t.length;n++)i+=this.renderer.tablecell(this.parseInline(t[n].tokens),{header:!1,align:e.align[n]});o+=this.renderer.tablerow(i)}n+=this.renderer.table(t,o);continue}case"blockquote":{const e=s,t=this.parse(e.tokens);n+=this.renderer.blockquote(t);continue}case"list":{const e=s,t=e.ordered,i=e.start,o=e.loose;let r="";for(let n=0;n<e.items.length;n++){const t=e.items[n],i=t.checked,s=t.task;let a="";if(t.task){const e=this.renderer.checkbox(!!i);o?t.tokens.length>0&&"paragraph"===t.tokens[0].type?(t.tokens[0].text=e+" "+t.tokens[0].text,t.tokens[0].tokens&&t.tokens[0].tokens.length>0&&"text"===t.tokens[0].tokens[0].type&&(t.tokens[0].tokens[0].text=e+" "+t.tokens[0].tokens[0].text)):t.tokens.unshift({type:"text",text:e+" "}):a+=e+" "}a+=this.parse(t.tokens,o),r+=this.renderer.listitem(a,s,!!i)}n+=this.renderer.list(r,t,i);continue}case"html":{const e=s;n+=this.renderer.html(e.text,e.block);continue}case"paragraph":{const e=s;n+=this.renderer.paragraph(this.parseInline(e.tokens));continue}case"text":{let o=s,r=o.tokens?this.parseInline(o.tokens):o.text;for(;i+1<e.length&&"text"===e[i+1].type;)o=e[++i],r+="\n"+(o.tokens?this.parseInline(o.tokens):o.text);n+=t?this.renderer.paragraph(r):r;continue}default:{const e='Token with "'+s.type+'" type was not found.';if(this.options.silent)return"";throw new Error(e)}}}return n}parseInline(e,t){t=t||this.renderer;let n="";for(let i=0;i<e.length;i++){const s=e[i];if(this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[s.type]){const e=this.options.extensions.renderers[s.type].call({parser:this},s);if(!1!==e||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(s.type)){n+=e||"";continue}}switch(s.type){case"escape":{const e=s;n+=t.text(e.text);break}case"html":{const e=s;n+=t.html(e.text);break}case"link":{const e=s;n+=t.link(e.href,e.title,this.parseInline(e.tokens,t));break}case"image":{const e=s;n+=t.image(e.href,e.title,e.text);break}case"strong":{const e=s;n+=t.strong(this.parseInline(e.tokens,t));break}case"em":{const e=s;n+=t.em(this.parseInline(e.tokens,t));break}case"codespan":{const e=s;n+=t.codespan(e.text);break}case"br":n+=t.br();break;case"del":{const e=s;n+=t.del(this.parseInline(e.tokens,t));break}case"text":{const e=s;n+=t.text(e.text);break}default:{const e='Token with "'+s.type+'" type was not found.';if(this.options.silent)return"";throw new Error(e)}}}return n}}class pe{constructor(e){r(this,"options"),this.options=e||l}preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}}r(pe,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens"]));t=new WeakSet,n=function(e,n){return(s,o)=>{const r={...o},c={...this.defaults,...r};!0===this.defaults.async&&!1===r.async&&(c.silent,c.async=!0);const l=a(this,t,i).call(this,!!c.silent,!!c.async);if(null==s)return l(new Error("marked(): input parameter is undefined or null"));if("string"!=typeof s)return l(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(s)+", string expected"));if(c.hooks&&(c.hooks.options=c),c.async)return Promise.resolve(c.hooks?c.hooks.preprocess(s):s).then((t=>e(t,c))).then((e=>c.hooks?c.hooks.processAllTokens(e):e)).then((e=>c.walkTokens?Promise.all(this.walkTokens(e,c.walkTokens)).then((()=>e)):e)).then((e=>n(e,c))).then((e=>c.hooks?c.hooks.postprocess(e):e)).catch(l);try{c.hooks&&(s=c.hooks.preprocess(s));let t=e(s,c);c.hooks&&(t=c.hooks.processAllTokens(t)),c.walkTokens&&this.walkTokens(t,c.walkTokens);let i=n(t,c);return c.hooks&&(i=c.hooks.postprocess(i)),i}catch(h){return l(h)}}},i=function(e,t){return n=>{if(n.message+="\nPlease report this to https://github.com/markedjs/marked.",e){const e="<p>An error occurred:</p><pre>"+b(n.message+"",!0)+"</pre>";return t?Promise.resolve(e):e}if(t)return Promise.reject(n);throw n}};const me=new class{constructor(...e){((e,t,n)=>{t.has(e)?o("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n)})(this,t),r(this,"defaults",{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}),r(this,"options",this.setOptions),r(this,"parse",a(this,t,n).call(this,le.lex,ue.parse)),r(this,"parseInline",a(this,t,n).call(this,le.lexInline,ue.parseInline)),r(this,"Parser",ue),r(this,"Renderer",he),r(this,"TextRenderer",de),r(this,"Lexer",le),r(this,"Tokenizer",T),r(this,"Hooks",pe),this.use(...e)}walkTokens(e,t){let n=[];for(const i of e)switch(n=n.concat(t.call(this,i)),i.type){case"table":{const e=i;for(const i of e.header)n=n.concat(this.walkTokens(i.tokens,t));for(const i of e.rows)for(const e of i)n=n.concat(this.walkTokens(e.tokens,t));break}case"list":{const e=i;n=n.concat(this.walkTokens(e.items,t));break}default:{const e=i;this.defaults.extensions?.childTokens?.[e.type]?this.defaults.extensions.childTokens[e.type].forEach((i=>{const s=e[i].flat(1/0);n=n.concat(this.walkTokens(s,t))})):e.tokens&&(n=n.concat(this.walkTokens(e.tokens,t)))}}return n}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach((e=>{const n={...e};if(n.async=this.defaults.async||n.async||!1,e.extensions&&(e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if("renderer"in e){const n=t.renderers[e.name];t.renderers[e.name]=n?function(...t){let i=e.renderer.apply(this,t);return!1===i&&(i=n.apply(this,t)),i}:e.renderer}if("tokenizer"in e){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");const n=t[e.level];n?n.unshift(e.tokenizer):t[e.level]=[e.tokenizer],e.start&&("block"===e.level?t.startBlock?t.startBlock.push(e.start):t.startBlock=[e.start]:"inline"===e.level&&(t.startInline?t.startInline.push(e.start):t.startInline=[e.start]))}"childTokens"in e&&e.childTokens&&(t.childTokens[e.name]=e.childTokens)})),n.extensions=t),e.renderer){const t=this.defaults.renderer||new he(this.defaults);for(const n in e.renderer){if(!(n in t))throw new Error(`renderer '${n}' does not exist`);if("options"===n)continue;const i=n,s=e.renderer[i],o=t[i];t[i]=(...e)=>{let n=s.apply(t,e);return!1===n&&(n=o.apply(t,e)),n||""}}n.renderer=t}if(e.tokenizer){const t=this.defaults.tokenizer||new T(this.defaults);for(const n in e.tokenizer){if(!(n in t))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;const i=n,s=e.tokenizer[i],o=t[i];t[i]=(...e)=>{let n=s.apply(t,e);return!1===n&&(n=o.apply(t,e)),n}}n.tokenizer=t}if(e.hooks){const t=this.defaults.hooks||new pe;for(const n in e.hooks){if(!(n in t))throw new Error(`hook '${n}' does not exist`);if("options"===n)continue;const i=n,s=e.hooks[i],o=t[i];pe.passThroughHooks.has(n)?t[i]=e=>{if(this.defaults.async)return Promise.resolve(s.call(t,e)).then((e=>o.call(t,e)));const n=s.call(t,e);return o.call(t,n)}:t[i]=(...e)=>{let n=s.apply(t,e);return!1===n&&(n=o.apply(t,e)),n}}n.hooks=t}if(e.walkTokens){const t=this.defaults.walkTokens,i=e.walkTokens;n.walkTokens=function(e){let n=[];return n.push(i.call(this,e)),t&&(n=n.concat(t.call(this,e))),n}}this.defaults={...this.defaults,...n}})),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return le.lex(e,t??this.defaults)}parser(e,t){return ue.parse(e,t??this.defaults)}};function ge(e,t){return me.parse(e,t)}function fe(e){if(!e)return"";const t={"&aacute;":"á","&eacute;":"é","&iacute;":"í","&oacute;":"ó","&uacute;":"ú","&ntilde;":"ñ","&Aacute;":"Á","&Eacute;":"É","&Iacute;":"Í","&Oacute;":"Ó","&Uacute;":"Ú","&Ntilde;":"Ñ","&iquest;":"¿","&iexcl;":"¡","&quot;":'"',"&amp;":"&","&lt;":"<","&gt;":">"};let n=e;for(const[s,o]of Object.entries(t))n=n.replace(new RegExp(s,"g"),o);n=n.replace(/Â¿/g,"¿").replace(/Â¡/g,"¡").replace(/Ã¡/g,"á").replace(/Ã©/g,"é").replace(/Ã­/g,"í").replace(/Ã³/g,"ó").replace(/Ãº/g,"ú").replace(/Ã±/g,"ñ");try{if(n.includes("%")){n=decodeURIComponent(n)}}catch(i){}return n}function be(e){if(!e)return"";const t=document.createElement("div");t.textContent=e;let n=t.innerHTML;return n=n.replace(/(https?:\/\/[^\s]+)/g,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit; font-weight: 600;">${e}</a>`)),n}function ye(e){if(!e)return"";try{const t={breaks:!0,gfm:!0};let n=ge.parse(e,t);const i=document.createElement("div");i.innerHTML=n;i.querySelectorAll("script").forEach((e=>e.remove()));i.querySelectorAll("*").forEach((e=>{Array.from(e.attributes).forEach((t=>{t.name.startsWith("on")&&e.removeAttribute(t.name)}))}));return i.querySelectorAll("a").forEach((e=>{e.href&&(e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer"))})),i.innerHTML}catch(t){return be(e)}}ge.options=ge.setOptions=function(e){return me.setOptions(e),ge.defaults=me.defaults,h(ge.defaults),ge},ge.getDefaults=c,ge.defaults=l,ge.use=function(...e){return me.use(...e),ge.defaults=me.defaults,h(ge.defaults),ge},ge.walkTokens=function(e,t){return me.walkTokens(e,t)},ge.parseInline=me.parseInline,ge.Parser=ue,ge.parser=ue.parse,ge.Renderer=he,ge.TextRenderer=de,ge.Lexer=le,ge.lexer=le.lex,ge.Tokenizer=T,ge.Hooks=pe,ge.parse=ge,ge.options,ge.setOptions,ge.use,ge.walkTokens,ge.parseInline,ue.parse,le.lex;let ve=null,we=0,ke=null;function xe(){const e=window.location,t=window.screen,n=window.navigator;return ve={url:e.href,protocol:e.protocol,hostname:e.hostname,pathname:e.pathname,search:e.search,hash:e.hash,userAgent:n.userAgent,language:n.language,languages:n.languages?[...n.languages]:[n.language],screenWidth:t.width,screenHeight:t.height,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenResolution:`${t.width}x${t.height}`,colorDepth:t.colorDepth,timezoneOffset:(new Date).getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timestamp:Date.now(),platform:n.platform,cookieEnabled:n.cookieEnabled,online:n.onLine,referrer:document.referrer||""},we=Date.now(),ve}function Ee(e,t){customElements.get(e)||customElements.define(e,t)}function Se(e,t=!1){return null===e?t:"true"===e}function Ce(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}class Te extends HTMLElement{constructor(){super(),r(this,"styleSheet",null),r(this,"mediaType",null),this.attachShadow({mode:"open"})}static get observedAttributes(){return["src","modal"]}async detectMediaType(e){const t=this.detectMediaTypeFromUrl(e);if("image"!==t)return t;if(this.isLikelySameOrigin(e))try{const t=new AbortController,n=setTimeout((()=>t.abort()),1e3),i=await fetch(e,{method:"HEAD",signal:t.signal,credentials:"omit",mode:"no-cors"});clearTimeout(n);const s=i.headers.get("Content-Type");if(s){if(s.startsWith("image/"))return"image";if(s.startsWith("video/"))return"video";if(s.startsWith("audio/"))return"audio"}}catch(n){}return t}isLikelySameOrigin(e){if(e.startsWith("/")&&!e.startsWith("//"))return!0;try{return new URL(e,window.location.origin).origin===window.location.origin}catch(t){return!1}}detectMediaTypeFromUrl(e){if(e.startsWith("__WEB__IFRAME__"))return"iframe";const t=e.split(".").pop()?.toLowerCase()||"";return["jpg","jpeg","png","gif","webp","svg"].includes(t)?"image":["mp4","webm","ogg","mov"].includes(t)?"video":["mp3","wav","ogg","aac","mpeg"].includes(t)?"audio":e.match(/\.(jpg|jpeg|png|gif|webp|svg)/i)?"image":e.match(/\.(mp4|webm|mov)/i)?"video":e.match(/\.(mp3|wav|aac|mpeg)/i)?"audio":e.includes("video")||e.includes("mp4")||e.includes("webm")||e.includes("s3")&&e.match(/\.(mp4|webm|mov)/i)?"video":"file"}renderLoadingState(){return'\n      <div class="message-media loading">\n        <div class="loading-indicator">\n          <div class="spinner"></div>\n        </div>\n      </div>\n    '}async connectedCallback(){this.shadowRoot&&(this.shadowRoot.innerHTML=this.getStyles()+this.renderLoadingState()),await this.render()}disconnectedCallback(){this.styleSheet&&document.head.contains(this.styleSheet)&&(document.head.removeChild(this.styleSheet),this.styleSheet=null)}async attributeChangedCallback(e,t,n){t!==n&&await this.render()}getStyles(){return"\n      <style>\n        :host {\n          display: block;\n        }\n        .loading-indicator {\n          display: flex;\n          justify-content: center;\n          align-items: center;\n          min-height: 100px;\n          background: rgba(0, 0, 0, 0.05);\n          border-radius: 8px;\n        }\n        .spinner {\n          width: 24px;\n          height: 24px;\n          border: 3px solid rgba(0, 0, 0, 0.1);\n          border-radius: 50%;\n          border-top-color: #666;\n          animation: spin 1s linear infinite;\n        }\n        @keyframes spin {\n          to {\n            transform: rotate(360deg);\n          }\n        }\n        .error-message {\n          padding: 12px;\n          background: rgba(255, 0, 0, 0.1);\n          border-radius: 8px;\n          color: #721c24;\n        }\n      </style>\n    "}async render(){const e=this.getAttribute("src"),t=this.hasAttribute("modal");if(e&&this.shadowRoot)try{let n;this.mediaType=await this.detectMediaType(e);const i=t?"modal":"";switch(this.mediaType){case"image":n=`<media-image src="${e}" ${i}></media-image>`;break;case"video":n=`<media-video src="${e}" ${i}></media-video>`;break;case"audio":n=`<media-audio src="${e}"></media-audio>`;break;case"iframe":n=`<media-iframe src="${e}"></media-iframe>`;break;case"file":n=`<media-file src="${e}" ${i}></media-file>`}this.shadowRoot.innerHTML=`\n        ${this.getStyles()}\n        ${n}\n      `}catch(n){this.shadowRoot.innerHTML=`\n        ${this.getStyles()}\n        <div class="error-message">\n          <p>Error al cargar el medio</p>\n        </div>\n      `}}}Ee("message-media",Te);var Ae=(e=>(e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.FATAL=4]="FATAL",e[e.NONE=5]="NONE",e))(Ae||{}),Me=(e=>(e.CONSOLE="console",e.USER="user",e.BOTH="both",e.NONE="none",e))(Me||{});const Re=class e{constructor(e){r(this,"options"),r(this,"pendingUserMessages",[]),r(this,"COLORS",{0:"#808080",1:"#0066FF",2:"#FF9900",3:"#FF0000",4:"#990000",5:"#000000"}),r(this,"LEVEL_PREFIXES",{0:"DEBUG",1:"INFO",2:"WARN",3:"ERROR",4:"FATAL",5:"NONE"});const t=this.isDebugEnabled()?0:2;this.options={minLevel:t,showTimestamp:!0,showModule:!0,includeStackTrace:!0,...e}}isDebugEnabled(){return!("undefined"==typeof window||!window.localStorage)&&"true"===window.localStorage.getItem("builderbot_debug")}static getInstance(t){return e.instance||(e.instance=new e(t)),e.instance}configure(e){this.options={...this.options,...e},e.userMessageHandler&&this.pendingUserMessages.length>0&&(this.pendingUserMessages.forEach((({message:t,level:n})=>{e.userMessageHandler(t,n)})),this.pendingUserMessages=[])}setDebugMode(e){"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem("builderbot_debug",e.toString()),this.options.minLevel=e?0:2}getDebugMode(){return this.options.minLevel<=0}log(e,t,n,i,s,o="console"){if(e<this.options.minLevel)return;const r={timestamp:new Date,level:e,module:t,message:n,data:i,error:s};"console"!==o&&"both"!==o||this.logToConsole(r),"user"!==o&&"both"!==o||this.logToUser(r)}debug(e,t,n,i="console"){this.log(0,e,t,n,void 0,i)}info(e,t,n,i="console"){this.log(1,e,t,n,void 0,i)}warn(e,t,n,i="console"){this.log(2,e,t,n,void 0,i)}error(e,t,n,i,s="both"){this.log(3,e,t,i,n,s)}fatal(e,t,n,i,s="both"){this.log(4,e,t,i,n,s)}logToConsole(e){const{timestamp:t,level:n,module:i,message:s,data:o,error:r}=e;let a="";if(this.options.showTimestamp){a+=`[${t.toISOString().replace("T"," ").substring(0,19)}] `}a+=`[${this.LEVEL_PREFIXES[n]}]`,this.options.showModule&&i&&(a+=` [${i}]`);this.COLORS[n];switch(n){case 0:case 1:case 2:break;case 3:case 4:r&&this.options.includeStackTrace}}logToUser(e){const{level:t,message:n}=e;this.options.userMessageHandler?this.options.userMessageHandler(n,t):this.pendingUserMessages.push({message:n,level:t})}};r(Re,"instance");const Be=Re.getInstance(),_e=(e,t,n={})=>{if(!e)throw new Error("El nombre de la cookie es requerido");let i=`${e}=${encodeURIComponent(t)}`;n.path&&(i+=`; path=${n.path}`),n.domain&&(i+=`; domain=${n.domain}`),n.expires&&(i+=`; expires=${n.expires.toUTCString()}`),void 0!==n.maxAge&&(i+=`; max-age=${n.maxAge}`),n.secure&&(i+="; secure"),n.httpOnly&&(i+="; httpOnly"),n.sameSite&&(i+=`; samesite=${n.sameSite}`),document.cookie=i},Le=e=>{if(!e)return null;const t=document.cookie.split(";");for(const n of t){const[t,i]=n.trim().split("=");if(t===e&&i)return decodeURIComponent(i)}return null},Oe={es:{now:"Ahora",minutesAgo:e=>`Hace ${e} min`,hoursAgo:e=>`Hace ${e}h`,daysAgo:e=>`Hace ${e}d`,months:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],you:"Tú",agent:"Agente"},pt:{now:"Agora",minutesAgo:e=>`Há ${e} min`,hoursAgo:e=>`Há ${e}h`,daysAgo:e=>`Há ${e}d`,months:["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],you:"Você",agent:"Agente"},en:{now:"Now",minutesAgo:e=>`${e} min ago`,hoursAgo:e=>`${e}h ago`,daysAgo:e=>`${e}d ago`,months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],you:"You",agent:"Agent"}};function Ie(e="es"){return Oe[e]||Oe.es}function Fe(e,t="es"){const n="string"==typeof e?new Date(e):e,i=new Date,s=i.getTime()-n.getTime(),o=Ie(t);if(s<6e4)return o.now;if(s<36e5){const e=Math.floor(s/6e4);return o.minutesAgo(e)}if(s<864e5){const e=Math.floor(s/36e5);return o.hoursAgo(e)}if(s<6048e5){const e=Math.floor(s/864e5);return o.daysAgo(e)}const r=o.months[n.getMonth()],a=n.getDate();return n.getFullYear()===i.getFullYear()?`${r} ${a}`:`${r} ${a}, ${n.getFullYear()}`}const Ne=new Set;async function je(e,t=5e3){if("undefined"!=typeof document&&"undefined"!=typeof window)if(function(e){if(Ne.has(e))return!0;if("undefined"!=typeof document&&document.querySelector(`link[href="${e}"]`))return Ne.add(e),!0;return!1}(e))Be.debug("FontLoader",`Fuente ya cargada: ${e}`);else try{Be.info("FontLoader",`Cargando fuente: ${e}`),function(e){return e.includes("fonts.googleapis.com")}(e)&&function(){if("undefined"==typeof document)return;const e=document.querySelector('link[href="https://fonts.googleapis.com"]'),t=document.querySelector('link[href="https://fonts.gstatic.com"]');if(!e){const e=document.createElement("link");e.rel="preconnect",e.href="https://fonts.googleapis.com",document.head.appendChild(e),Be.debug("FontLoader","Preconnect a fonts.googleapis.com creado")}if(!t){const e=document.createElement("link");e.rel="preconnect",e.href="https://fonts.gstatic.com",e.crossOrigin="anonymous",document.head.appendChild(e),Be.debug("FontLoader","Preconnect a fonts.gstatic.com creado")}}();const n=document.createElement("link");n.rel="stylesheet",n.href=e;const i=new Promise(((i,s)=>{const o=setTimeout((()=>{Be.warn("FontLoader",`Timeout al cargar fuente: ${e} (${t}ms)`),s(new Error(`Timeout loading font after ${t}ms`))}),t);n.onload=()=>{clearTimeout(o),Ne.add(e),Be.info("FontLoader",`Fuente cargada exitosamente: ${e}`),i()},n.onerror=()=>{clearTimeout(o),Be.error("FontLoader",`Error al cargar fuente: ${e}`),s(new Error(`Failed to load font: ${e}`))}}));document.head.appendChild(n),await i}catch(n){Be.warn("FontLoader",`No se pudo cargar la fuente ${e}, usando fuente del sistema como fallback`,n)}else Be.debug("FontLoader","No se puede cargar fuente: no estamos en un entorno de navegador")}const De=Object.create(null);De.open="0",De.close="1",De.ping="2",De.pong="3",De.message="4",De.upgrade="5",De.noop="6";const He=Object.create(null);Object.keys(De).forEach((e=>{He[De[e]]=e}));const Pe={type:"error",data:"parser error"},$e="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),ze="function"==typeof ArrayBuffer,qe=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,Ue=({type:e,data:t},n,i)=>$e&&t instanceof Blob?n?i(t):We(t,i):ze&&(t instanceof ArrayBuffer||qe(t))?n?i(t):We(new Blob([t]),i):i(De[e]+(t||"")),We=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+(e||""))},n.readAsDataURL(e)};function Ve(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let Qe;const Je="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ge="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let Bi=0;Bi<64;Bi++)Ge[Je.charCodeAt(Bi)]=Bi;const Ye="function"==typeof ArrayBuffer,Ke=(e,t)=>{if("string"!=typeof e)return{type:"message",data:Xe(e,t)};const n=e.charAt(0);if("b"===n)return{type:"message",data:Ze(e.substring(1),t)};return He[n]?e.length>1?{type:He[n],data:e.substring(1)}:{type:He[n]}:Pe},Ze=(e,t)=>{if(Ye){const n=(e=>{let t,n,i,s,o,r=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(r--,"="===e[e.length-2]&&r--);const l=new ArrayBuffer(r),h=new Uint8Array(l);for(t=0;t<a;t+=4)n=Ge[e.charCodeAt(t)],i=Ge[e.charCodeAt(t+1)],s=Ge[e.charCodeAt(t+2)],o=Ge[e.charCodeAt(t+3)],h[c++]=n<<2|i>>4,h[c++]=(15&i)<<4|s>>2,h[c++]=(3&s)<<6|63&o;return l})(e);return Xe(n,t)}return{base64:!0,data:e}},Xe=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer,et=String.fromCharCode(30);function tt(){return new TransformStream({transform(e,t){!function(e,t){$e&&e.data instanceof Blob?e.data.arrayBuffer().then(Ve).then(t):ze&&(e.data instanceof ArrayBuffer||qe(e.data))?t(Ve(e.data)):Ue(e,!1,(e=>{Qe||(Qe=new TextEncoder),t(Qe.encode(e))}))}(e,(n=>{const i=n.length;let s;if(i<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,i);else if(i<65536){s=new Uint8Array(3);const e=new DataView(s.buffer);e.setUint8(0,126),e.setUint16(1,i)}else{s=new Uint8Array(9);const e=new DataView(s.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(i))}e.data&&"string"!=typeof e.data&&(s[0]|=128),t.enqueue(s),t.enqueue(n)}))}})}let nt;function it(e){return e.reduce(((e,t)=>e+t.length),0)}function st(e,t){if(e[0].length===t)return e.shift();const n=new Uint8Array(t);let i=0;for(let s=0;s<t;s++)n[s]=e[0][i++],i===e[0].length&&(e.shift(),i=0);return e.length&&i<e[0].length&&(e[0]=e[0].slice(i)),n}function ot(e){if(e)return function(e){for(var t in ot.prototype)e[t]=ot.prototype[t];return e}(e)}ot.prototype.on=ot.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},ot.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},ot.prototype.off=ot.prototype.removeListener=ot.prototype.removeAllListeners=ot.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,i=this._callbacks["$"+e];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<i.length;s++)if((n=i[s])===t||n.fn===t){i.splice(s,1);break}return 0===i.length&&delete this._callbacks["$"+e],this},ot.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(n){i=0;for(var s=(n=n.slice(0)).length;i<s;++i)n[i].apply(this,t)}return this},ot.prototype.emitReserved=ot.prototype.emit,ot.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},ot.prototype.hasListeners=function(e){return!!this.listeners(e).length};const rt="function"==typeof Promise&&"function"==typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),at="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function ct(e,...t){return t.reduce(((t,n)=>(e.hasOwnProperty(n)&&(t[n]=e[n]),t)),{})}const lt=at.setTimeout,ht=at.clearTimeout;function dt(e,t){t.useNativeTimers?(e.setTimeoutFn=lt.bind(at),e.clearTimeoutFn=ht.bind(at)):(e.setTimeoutFn=at.setTimeout.bind(at),e.clearTimeoutFn=at.clearTimeout.bind(at))}function ut(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}class pt extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class mt extends ot{constructor(e){super(),this.writable=!1,dt(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,n){return super.emitReserved("error",new pt(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Ke(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return-1===e.indexOf(":")?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(e){const t=function(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}(e);return t.length?"?"+t:""}}class gt extends mt{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let e=0;this._polling&&(e++,this.once("pollComplete",(function(){--e||t()}))),this.writable||(e++,this.once("drain",(function(){--e||t()})))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){((e,t)=>{const n=e.split(et),i=[];for(let s=0;s<n.length;s++){const e=Ke(n[s],t);if(i.push(e),"error"===e.type)break}return i})(e,this.socket.binaryType).forEach((e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)})),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,((e,t)=>{const n=e.length,i=new Array(n);let s=0;e.forEach(((e,o)=>{Ue(e,!1,(e=>{i[o]=e,++s===n&&t(i.join(et))}))}))})(e,(e=>{this.doWrite(e,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=ut()),this.supportsBinary||t.sid||(t.b64=1),this.createUri(e,t)}}let ft=!1;try{ft="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(Ri){}const bt=ft;function yt(){}class vt extends gt{constructor(e){if(super(e),"undefined"!=typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?"443":"80"),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port}}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",((e,t)=>{this.onError("xhr post error",e,t)}))}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",((e,t)=>{this.onError("xhr poll error",e,t)})),this.pollXhr=e}}class wt extends ot{constructor(e,t,n){super(),this.createRequest=e,dt(this,n),this._opts=n,this._method=n.method||"GET",this._uri=t,this._data=void 0!==n.data?n.data:null,this._create()}_create(){var e;const t=ct(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(t);try{n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let e in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(e)&&n.setRequestHeader(e,this._opts.extraHeaders[e])}}catch(i){}if("POST"===this._method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(i){}try{n.setRequestHeader("Accept","*/*")}catch(i){}null===(e=this._opts.cookieJar)||void 0===e||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var e;3===n.readyState&&(null===(e=this._opts.cookieJar)||void 0===e||e.parseCookies(n.getResponseHeader("set-cookie"))),4===n.readyState&&(200===n.status||1223===n.status?this._onLoad():this.setTimeoutFn((()=>{this._onError("number"==typeof n.status?n.status:0)}),0))},n.send(this._data)}catch(i){return void this.setTimeoutFn((()=>{this._onError(i)}),0)}"undefined"!=typeof document&&(this._index=wt.requestsCount++,wt.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=yt,e)try{this._xhr.abort()}catch(t){}"undefined"!=typeof document&&delete wt.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}if(wt.requestsCount=0,wt.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",kt);else if("function"==typeof addEventListener){addEventListener("onpagehide"in at?"pagehide":"unload",kt,!1)}function kt(){for(let e in wt.requests)wt.requests.hasOwnProperty(e)&&wt.requests[e].abort()}const xt=function(){const e=Et({xdomain:!1});return e&&null!==e.responseType}();function Et(e){const t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||bt))return new XMLHttpRequest}catch(n){}if(!t)try{return new(at[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(n){}}const St="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class Ct extends mt{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,n=St?{}:ct(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,n)}catch(Ri){return this.emitReserved("error",Ri)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;Ue(n,this.supportsBinary,(e=>{try{this.doWrite(n,e)}catch(t){}i&&rt((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=ut()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const Tt=at.WebSocket||at.MozWebSocket;const At={websocket:class extends Ct{createSocket(e,t,n){return St?new Tt(e,t,n):t?new Tt(e,t):new Tt(e)}doWrite(e,t){this.ws.send(t)}},webtransport:class extends mt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(Ri){return this.emitReserved("error",Ri)}this._transport.closed.then((()=>{this.onClose()})).catch((e=>{this.onError("webtransport error",e)})),this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((e=>{const t=function(e,t){nt||(nt=new TextDecoder);const n=[];let i=0,s=-1,o=!1;return new TransformStream({transform(r,a){for(n.push(r);;){if(0===i){if(it(n)<1)break;const e=st(n,1);o=!(128&~e[0]),s=127&e[0],i=s<126?3:126===s?1:2}else if(1===i){if(it(n)<2)break;const e=st(n,2);s=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),i=3}else if(2===i){if(it(n)<8)break;const e=st(n,8),t=new DataView(e.buffer,e.byteOffset,e.length),o=t.getUint32(0);if(o>Math.pow(2,21)-1){a.enqueue(Pe);break}s=o*Math.pow(2,32)+t.getUint32(4),i=3}else{if(it(n)<s)break;const e=st(n,s);a.enqueue(Ke(o?e:nt.decode(e),t)),i=0}if(0===s||s>e){a.enqueue(Pe);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),i=tt();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const s=()=>{n.read().then((({done:e,value:t})=>{e||(this.onPacket(t),s())})).catch((e=>{}))};s();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then((()=>this.onOpen()))}))}))}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;this._writer.write(n).then((()=>{i&&rt((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var e;null===(e=this._transport)||void 0===e||e.close()}},polling:class extends vt{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=xt&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new wt(Et,this.uri(),e)}}},Mt=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Rt=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Bt(e){if(e.length>8e3)throw"URI too long";const t=e,n=e.indexOf("["),i=e.indexOf("]");-1!=n&&-1!=i&&(e=e.substring(0,n)+e.substring(n,i).replace(/:/g,";")+e.substring(i,e.length));let s=Mt.exec(e||""),o={},r=14;for(;r--;)o[Rt[r]]=s[r]||"";return-1!=n&&-1!=i&&(o.source=t,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=function(e,t){const n=/\/{2,9}/g,i=t.replace(n,"/").split("/");"/"!=t.slice(0,1)&&0!==t.length||i.splice(0,1);"/"==t.slice(-1)&&i.splice(i.length-1,1);return i}(0,o.path),o.queryKey=function(e,t){const n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,i){t&&(n[t]=i)})),n}(0,o.query),o}const _t="function"==typeof addEventListener&&"function"==typeof removeEventListener,Lt=[];_t&&addEventListener("offline",(()=>{Lt.forEach((e=>e()))}),!1);class Ot extends ot{constructor(e,t){if(super(),this.binaryType="arraybuffer",this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&"object"==typeof e&&(t=e,e=null),e){const n=Bt(e);t.hostname=n.host,t.secure="https"===n.protocol||"wss"===n.protocol,t.port=n.port,n.query&&(t.query=n.query)}else t.host&&(t.hostname=Bt(t.host).host);dt(this,t),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach((e=>{const t=e.prototype.name;this.transports.push(t),this._transportsByName[t]=e})),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=function(e){let t={},n=e.split("&");for(let i=0,s=n.length;i<s;i++){let e=n[i].split("=");t[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return t}(this.opts.query)),_t&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Lt.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](n)}_open(){if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);const e=this.opts.rememberUpgrade&&Ot.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(e=>this._onClose("transport close",e)))}onOpen(){this.readyState="open",Ot.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let n=0;n<this.writeBuffer.length;n++){const i=this.writeBuffer[n].data;if(i&&(e+="string"==typeof(t=i)?function(e){let t=0,n=0;for(let i=0,s=e.length;i<s;i++)t=e.charCodeAt(i),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(i++,n+=4);return n}(t):Math.ceil(1.33*(t.byteLength||t.size))),n>0&&e>this._maxPayload)return this.writeBuffer.slice(0,n);e+=2}var t;return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,rt((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)),e}write(e,t,n){return this._sendPacket("message",e,t,n),this}send(e,t,n){return this._sendPacket("message",e,t,n),this}_sendPacket(e,t,n,i){if("function"==typeof t&&(i=t,t=void 0),"function"==typeof n&&(i=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const s={type:e,data:t,options:n};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():e()})):this.upgrading?n():e()),this}_onError(e){if(Ot.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),_t&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const e=Lt.indexOf(this._offlineEventListener);-1!==e&&Lt.splice(e,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}Ot.protocol=4;class It extends Ot{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),n=!1;Ot.priorWebsocketSuccess=!1;const i=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",(e=>{if(!n)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Ot.priorWebsocketSuccess="websocket"===t.name,this.transport.pause((()=>{n||"closed"!==this.readyState&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())}))}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}})))};function s(){n||(n=!0,l(),t.close(),t=null)}const o=e=>{const n=new Error("probe error: "+e);n.transport=t.name,s(),this.emitReserved("upgradeError",n)};function r(){o("transport closed")}function a(){o("socket closed")}function c(e){t&&e.name!==t.name&&s()}const l=()=>{t.removeListener("open",i),t.removeListener("error",o),t.removeListener("close",r),this.off("close",a),this.off("upgrading",c)};t.once("open",i),t.once("error",o),t.once("close",r),this.once("close",a),this.once("upgrading",c),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==e?this.setTimeoutFn((()=>{n||t.open()}),200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let n=0;n<e.length;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}let Ft=class extends It{constructor(e,t={}){const n="object"==typeof e?e:t;(!n.transports||n.transports&&"string"==typeof n.transports[0])&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map((e=>At[e])).filter((e=>!!e))),super(e,n)}};const Nt="function"==typeof ArrayBuffer,jt=Object.prototype.toString,Dt="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===jt.call(Blob),Ht="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===jt.call(File);function Pt(e){return Nt&&(e instanceof ArrayBuffer||(e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer)(e))||Dt&&e instanceof Blob||Ht&&e instanceof File}function $t(e,t){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if($t(e[t]))return!0;return!1}if(Pt(e))return!0;if(e.toJSON&&"function"==typeof e.toJSON&&1===arguments.length)return $t(e.toJSON(),!0);for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&$t(e[n]))return!0;return!1}function zt(e){const t=[],n=e.data,i=e;return i.data=qt(n,t),i.attachments=t.length,{packet:i,buffers:t}}function qt(e,t){if(!e)return e;if(Pt(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let i=0;i<e.length;i++)n[i]=qt(e[i],t);return n}if("object"==typeof e&&!(e instanceof Date)){const n={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=qt(e[i],t));return n}return e}function Ut(e,t){return e.data=Wt(e.data,t),delete e.attachments,e}function Wt(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"==typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=Wt(e[n],t);else if("object"==typeof e)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=Wt(e[n],t));return e}const Vt=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var Qt,Jt;(Jt=Qt||(Qt={}))[Jt.CONNECT=0]="CONNECT",Jt[Jt.DISCONNECT=1]="DISCONNECT",Jt[Jt.EVENT=2]="EVENT",Jt[Jt.ACK=3]="ACK",Jt[Jt.CONNECT_ERROR=4]="CONNECT_ERROR",Jt[Jt.BINARY_EVENT=5]="BINARY_EVENT",Jt[Jt.BINARY_ACK=6]="BINARY_ACK";function Gt(e){return"[object Object]"===Object.prototype.toString.call(e)}class Yt extends ot{constructor(e){super(),this.reviver=e}add(e){let t;if("string"==typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===Qt.BINARY_EVENT;n||t.type===Qt.BINARY_ACK?(t.type=n?Qt.EVENT:Qt.ACK,this.reconstructor=new Kt(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!Pt(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===Qt[n.type])throw new Error("unknown packet type "+n.type);if(n.type===Qt.BINARY_EVENT||n.type===Qt.BINARY_ACK){const i=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const s=e.substring(i,t);if(s!=Number(s)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(s)}if("/"===e.charAt(t+1)){const i=t+1;for(;++t;){if(","===e.charAt(t))break;if(t===e.length)break}n.nsp=e.substring(i,t)}else n.nsp="/";const i=e.charAt(t+1);if(""!==i&&Number(i)==i){const i=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(!Yt.isPayloadValid(n.type,i))throw new Error("invalid payload");n.data=i}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case Qt.CONNECT:return Gt(t);case Qt.DISCONNECT:return void 0===t;case Qt.CONNECT_ERROR:return"string"==typeof t||Gt(t);case Qt.EVENT:case Qt.BINARY_EVENT:return Array.isArray(t)&&("number"==typeof t[0]||"string"==typeof t[0]&&-1===Vt.indexOf(t[0]));case Qt.ACK:case Qt.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Kt{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=Ut(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Zt=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Yt,Encoder:class{constructor(e){this.replacer=e}encode(e){return e.type!==Qt.EVENT&&e.type!==Qt.ACK||!$t(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===Qt.EVENT?Qt.BINARY_EVENT:Qt.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==Qt.BINARY_EVENT&&e.type!==Qt.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=zt(e),n=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(n),i}},get PacketType(){return Qt},protocol:5},Symbol.toStringTag,{value:"Module"}));function Xt(e,t,n){return e.on(t,n),function(){e.off(t,n)}}const en=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class tn extends ot{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Xt(e,"open",this.onopen.bind(this)),Xt(e,"packet",this.onpacket.bind(this)),Xt(e,"error",this.onerror.bind(this)),Xt(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var n,i,s;if(en.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const o={type:Qt.EVENT,data:t,options:{}};if(o.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]){const e=this.ids++,n=t.pop();this._registerAckCallback(e,n),o.id=e}const r=null===(i=null===(n=this.io.engine)||void 0===n?void 0:n.transport)||void 0===i?void 0:i.writable,a=this.connected&&!(null===(s=this.io.engine)||void 0===s?void 0:s._hasPingExpired());return this.flags.volatile&&!r||(a?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(e,t){var n;const i=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===i)return void(this.acks[e]=t);const s=this.io.setTimeoutFn((()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))}),i),o=(...e)=>{this.io.clearTimeoutFn(s),t.apply(this,e)};o.withError=!0,this.acks[e]=o}emitWithAck(e,...t){return new Promise(((n,i)=>{const s=(e,t)=>e?i(e):n(t);s.withError=!0,t.push(s),this.emit(e,...t)}))}_addToQueue(e){let t;"function"==typeof e[e.length-1]&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push(((e,...i)=>{if(n!==this._queue[0])return;return null!==e?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(e)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue()})),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth((e=>{this._sendConnectPacket(e)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:Qt.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((e=>{if(!this.sendBuffer.some((t=>String(t.id)===e))){const t=this.acks[e];delete this.acks[e],t.withError&&t.call(this,new Error("socket has been disconnected"))}}))}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case Qt.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Qt.EVENT:case Qt.BINARY_EVENT:this.onevent(e);break;case Qt.ACK:case Qt.BINARY_ACK:this.onack(e);break;case Qt.DISCONNECT:this.ondisconnect();break;case Qt.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"==typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...i){n||(n=!0,t.packet({type:Qt.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];"function"==typeof t&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((e=>this.emitEvent(e))),this.receiveBuffer=[],this.sendBuffer.forEach((e=>{this.notifyOutgoingListeners(e),this.packet(e)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((e=>e())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Qt.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function nn(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}nn.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=1&Math.floor(10*t)?e+n:e-n}return 0|Math.min(e,this.max)},nn.prototype.reset=function(){this.attempts=0},nn.prototype.setMin=function(e){this.ms=e},nn.prototype.setMax=function(e){this.max=e},nn.prototype.setJitter=function(e){this.jitter=e};class sn extends ot{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,dt(this,t),this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(n=t.randomizationFactor)&&void 0!==n?n:.5),this.backoff=new nn({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||Zt;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Ft(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=Xt(t,"open",(function(){n.onopen(),e&&e()})),s=t=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",t),e?e(t):this.maybeReconnectOnOpen()},o=Xt(t,"error",s);if(!1!==this._timeout){const e=this._timeout,n=this.setTimeoutFn((()=>{i(),s(new Error("timeout")),t.close()}),e);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}return this.subs.push(i),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Xt(e,"ping",this.onping.bind(this)),Xt(e,"data",this.ondata.bind(this)),Xt(e,"error",this.onerror.bind(this)),Xt(e,"close",this.onclose.bind(this)),Xt(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){rt((()=>{this.emitReserved("packet",e)}),this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new tn(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t){if(this.nsps[n].active)return}this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach((e=>e())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var n;this.cleanup(),null===(n=this.engine)||void 0===n||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn((()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open((t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()})))}),t);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const on={};function rn(e,t){"object"==typeof e&&(t=e,e=void 0);const n=function(e,t="",n){let i=e;n=n||"undefined"!=typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==n?n.protocol+"//"+e:"https://"+e),i=Bt(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const s=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+s+":"+i.port+t,i.href=i.protocol+"://"+s+(n&&n.port===i.port?"":":"+i.port),i}(e,(t=t||{}).path||"/socket.io"),i=n.source,s=n.id,o=n.path,r=on[s]&&o in on[s].nsps;let a;return t.forceNew||t["force new connection"]||!1===t.multiplex||r?a=new sn(i,t):(on[s]||(on[s]=new sn(i,t)),a=on[s]),n.query&&!t.query&&(t.query=n.queryKey),a.socket(n.path,t)}Object.assign(rn,{Manager:sn,Socket:tn,io:rn,connect:rn});var an=(e=>(e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.FAILED="failed",e))(an||{});const cn=class e{constructor(e="[SocketIO]"){r(this,"prefix"),this.prefix=e}isDebugEnabled(){if("undefined"!=typeof window&&window.localStorage){if("true"===window.localStorage.getItem("builderbot_debug"))return!0}return e.debugMode}static setDebugMode(t){e.debugMode=t,"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem("builderbot_debug",t.toString())}static getDebugMode(){return"undefined"!=typeof window&&window.localStorage?"true"===window.localStorage.getItem("builderbot_debug"):e.debugMode}info(e,t){this.isDebugEnabled()}warn(e,t){}error(e,t){t?.stack&&this.isDebugEnabled()}debug(e,t){this.isDebugEnabled()}};r(cn,"debugMode",!1);let ln=cn;class hn{constructor(e){r(this,"socket",null),r(this,"handlers",{}),r(this,"namespace",""),r(this,"connectionState",an.DISCONNECTED),r(this,"maxReconnectAttempts",5),r(this,"reconnectDelay",2e3),r(this,"pendingMessages",[]),r(this,"maxPendingMessageRetries",3),r(this,"MAX_PENDING_MESSAGES",50),r(this,"connectionTimeout",1e4),r(this,"autoReconnect",!0),r(this,"maxMessageSize",1048576),r(this,"connectionTimeoutId",null),r(this,"socketOptions",{}),r(this,"logger"),r(this,"heartbeatInterval",null),r(this,"heartbeatTimeout",3e4),r(this,"reconnectAttempts",0),r(this,"connectionErrorCount",0),r(this,"socketUrl",""),r(this,"projectId",""),r(this,"pendingMessagesTimeout",null),r(this,"joinProjectInProgress",!1),r(this,"joinProjectRetries",0),r(this,"MAX_JOIN_PROJECT_RETRIES",3),r(this,"joinProjectBackoffDelay",1e3),r(this,"lastJoinProjectError",null),r(this,"lastJoinProjectSuccess",0),r(this,"lastJoinedProjectId",""),r(this,"lastJoinProjectAttempt",0),r(this,"MIN_JOIN_PROJECT_INTERVAL",5e3),r(this,"MIN_JOIN_PROJECT_RETRY_INTERVAL",2e3),this.logger=new ln("[SocketIoRepository]"),this.initializeOptions(e)}initializeOptions(e){e&&(this.maxReconnectAttempts=e.maxReconnectAttempts??this.maxReconnectAttempts,this.reconnectDelay=e.reconnectDelay??this.reconnectDelay,this.connectionTimeout=e.connectionTimeout??this.connectionTimeout,this.autoReconnect=e.autoReconnect??this.autoReconnect,this.maxMessageSize=e.maxMessageSize??this.maxMessageSize,this.namespace=e.namespace??this.namespace,this.socketOptions=e.socketOptions??{},this.heartbeatTimeout=e.heartbeatTimeout??this.heartbeatTimeout,this.logger.info("Opciones inicializadas",{maxReconnectAttempts:this.maxReconnectAttempts,reconnectDelay:this.reconnectDelay,connectionTimeout:this.connectionTimeout,autoReconnect:this.autoReconnect,maxMessageSize:this.maxMessageSize,namespace:this.namespace,heartbeatTimeout:this.heartbeatTimeout}))}async connect(e,t,n){if(this.logger.info("Iniciando conexión",{url:e,projectId:n}),!e)throw new Error("URL de conexión inválida");if(this.socketUrl=e,n&&(this.projectId=n),t&&(this.handlers=t),!this.checkExistingConnection())return this.connectionState=an.CONNECTING,this.reconnectAttempts=0,new Promise(((t,i)=>{try{this.cleanup(),this.setupConnectionTimeout(i),this.initializeSocket(e,n),this.setupEventHandlers(t,i)}catch(s){this.handleConnectionError(s,i)}}))}checkExistingConnection(){if(this.connectionState===an.CONNECTED){const e=this.socket?.connected;if(e)return this.logger.info("Ya está conectado"),!0;this.cleanup()}else if(this.connectionState===an.CONNECTING)return this.logger.info("Ya está conectando"),!0;return!1}setupConnectionTimeout(e){this.connectionTimeoutId=setTimeout((()=>{if(this.connectionState===an.CONNECTING){const t=new Error("Timeout al conectar al servidor Socket.IO");this.handleConnectionError(t,e)}}),this.connectionTimeout)}initializeSocket(e,t){const n={reconnection:this.autoReconnect,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:this.reconnectDelay,reconnectionDelayMax:6e4,timeout:this.connectionTimeout,transports:["websocket"],pingTimeout:1e4,pingInterval:5e3,randomizationFactor:.5,...this.socketOptions};t&&(n.auth={projectId:t,...this.socketOptions.auth||{}},this.logger.info("Configurando autenticación del socket con projectId",{projectId:t}));const i=this.namespace?`${e}/${this.namespace}`:e;this.socket=rn(i,n)}handleTyping(e){this.logger.debug("Evento de typing recibido",e),this.handlers.onTyping&&this.handlers.onTyping(e.isTyping,e.from)}setupEventHandlers(e,t){this.socket&&(this.socket.off("connect"),this.socket.off("disconnect"),this.socket.off("connect_error"),this.socket.off("message"),this.socket.off("unmount_webchat"),this.socket.off("typing"),this.socket.off("pong"),this.socket.io.off("reconnect_attempt"),this.socket.on("connect",(()=>this.handleConnect(e))),this.socket.on("disconnect",(e=>this.handleDisconnect(e,t))),this.socket.on("connect_error",(e=>this.handleError(e))),this.socket.on("message",(e=>this.handleMessage(e))),this.socket.on("unmount_webchat",(e=>this.handleUnmountWebchat(e))),this.socket.on("typing",(e=>this.handleTyping(e))),this.setupReconnectionHandlers())}handleConnect(e){this.clearConnectionTimeout(),this.onConnectionEstablished(),e()}onConnectionEstablished(){this.reconnectAttempts=0,this.connectionErrorCount=0,this.connectionState=an.CONNECTED,this.joinProjectRetries=0,this.lastJoinProjectError=null,this.lastJoinProjectAttempt=0,this.logger.info("Conexión establecida exitosamente"),this.handlers.onOpen&&this.handlers.onOpen(),this.clearPendingMessagesTimeout(),this.pendingMessagesTimeout=setTimeout((()=>{this.processPendingMessages(),this.pendingMessagesTimeout=null}),100),this.startHeartbeat()}handleDisconnect(e,t){this.clearConnectionTimeout(),this.clearPendingMessagesTimeout(),this.stopHeartbeat(),this.connectionState===an.CONNECTING&&t(new Error(`Conexión cerrada durante inicialización: ${e}`)),this.connectionState!==an.FAILED?(this.connectionState=an.DISCONNECTED,this.handlers.onClose&&this.handlers.onClose(),this.logger.info(`Desconexión detectada (${e}), Socket.IO manejará la reconexión automáticamente`)):this.logger.warn(`Desconexión ignorada - conexión falló permanentemente (razón: ${e})`)}handleError(e){this.connectionState!==an.FAILED&&(this.connectionErrorCount++,this.logger.error(`Error de conexión (${this.connectionErrorCount}/${this.maxReconnectAttempts})`,e),this.connectionErrorCount>=this.maxReconnectAttempts?this.handlePermanentFailure():this.handlers.onError&&this.handlers.onError(e))}handlePermanentFailure(){if(this.logger.error(`Se alcanzó el límite de ${this.maxReconnectAttempts} errores de conexión. Deteniendo intentos.`),this.connectionState=an.FAILED,this.socket&&(this.socket.io.reconnection(!1),this.socket.disconnect(),this.socket.removeAllListeners(),this.socket=null),this.clearConnectionTimeout(),this.clearPendingMessagesTimeout(),this.stopHeartbeat(),this.handlers.onError){const e=new Error(`No se pudo conectar al servidor después de ${this.maxReconnectAttempts} intentos. Por favor, recarga la página para intentar nuevamente.`);this.handlers.onError(e)}}setupReconnectionHandlers(){this.socket&&(this.socket.off("reconnect_attempt"),this.socket.off("reconnect"),this.socket.off("reconnect_failed"),this.socket.on("reconnect_attempt",(e=>{this.connectionState!==an.FAILED&&(this.connectionState=an.RECONNECTING,this.logger.info(`Socket.IO intentando reconectar (intento ${e}/${this.maxReconnectAttempts})`))})),this.socket.on("reconnect",(e=>{this.logger.info(`Socket.IO reconectado exitosamente después de ${e} intentos`),this.onConnectionEstablished()})),this.socket.on("reconnect_failed",(()=>{this.logger.error(`Socket.IO falló en reconexión después de ${this.maxReconnectAttempts} intentos. Deteniendo reconexiones.`),this.handlePermanentFailure()})))}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval((()=>{this.socket&&this.connectionState===an.CONNECTED&&(this.socket.connected||(this.logger.warn("Conexión silenciosa detectada - socket marcado como desconectado"),this.connectionState=an.DISCONNECTED))}),this.heartbeatTimeout)}clearPendingMessagesTimeout(){null!==this.pendingMessagesTimeout&&(clearTimeout(this.pendingMessagesTimeout),this.pendingMessagesTimeout=null)}stopHeartbeat(){null!==this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}handleMessage(e){try{this.logger.debug("Mensaje recibido",e);const t=this.parseMessage(e);this.handlers.onMessage&&this.handlers.onMessage(t,t.from,t.projectId)}catch(t){this.logger.error("Error al procesar mensaje",t)}}parseMessage(e){try{return"string"==typeof e?JSON.parse(e):e}catch(t){return this.logger.warn("Error al parsear mensaje, usando fallback",{error:t,data:e}),{type:"text",content:String(e),timestamp:Date.now(),projectId:"",name:"",from:"",emitter:"assistant"}}}async sendMessage(e){if(this.validateMessage(e),!this.isConnected())throw this.pendingMessages.length>=this.MAX_PENDING_MESSAGES&&(this.pendingMessages.shift(),this.logger.warn(`Cola de mensajes pendientes llena (${this.MAX_PENDING_MESSAGES}), mensaje más antiguo descartado`)),this.pendingMessages.push({message:e,retries:0,maxRetries:this.maxPendingMessageRetries}),this.logger.info(`Mensaje agregado a cola de pendientes (total: ${this.pendingMessages.length})`),new Error("No hay conexión Socket.IO disponible");return this.emitMessage(e)}validateMessage(e){if(!e||"object"!=typeof e)throw new Error("Mensaje inválido: Debe ser un objeto");if(this.maxMessageSize>0){const t=JSON.stringify(e).length;if(t>this.maxMessageSize)throw new Error(`Mensaje excede el tamaño máximo permitido: ${t} bytes`)}}emitMessage(e){return new Promise(((t,n)=>{this.socket?.connected?this.socket.emit("message",e,(e=>{e?.error?n(new Error(e.error)):t()})):n(new Error("Socket.IO no está conectado"))}))}disconnect(){this.connectionState!==an.FAILED?(this.clearConnectionTimeout(),this.clearPendingMessagesTimeout(),this.stopHeartbeat(),this.socket&&(this.socket.io.reconnection(!1),this.socket.connected&&this.socket.disconnect(),this.socket.removeAllListeners(),this.socket=null),this.connectionState=an.DISCONNECTED,this.pendingMessages=[]):this.logger.info("Socket ya está en estado FAILED, ya fue desconectado")}isConnected(){return null!==this.socket&&this.socket.connected&&this.connectionState===an.CONNECTED}emitWithAck(e,...t){return new Promise(((n,i)=>{this.isConnected()&&this.socket?this.socket.emit(e,...t,(e=>{e?.error?i(new Error(e.error)):n(e)})):i(new Error("No hay conexión Socket.IO disponible"))}))}clearConnectionTimeout(){null!==this.connectionTimeoutId&&(clearTimeout(this.connectionTimeoutId),this.connectionTimeoutId=null)}cleanup(){this.clearConnectionTimeout(),this.clearPendingMessagesTimeout(),this.stopHeartbeat(),this.joinProjectInProgress=!1,this.socket&&(this.socket.off(),this.socket.connected&&this.socket.disconnect(),this.socket=null)}async processPendingMessages(){if(0===this.pendingMessages.length||!this.isConnected())return;this.logger.info(`Procesando ${this.pendingMessages.length} mensaje(s) pendiente(s)`);const e=[...this.pendingMessages];this.pendingMessages=[];for(const n of e)try{await this.emitMessage(n.message),this.logger.debug("Mensaje pendiente enviado exitosamente")}catch(t){if(n.retries++,n.retries<n.maxRetries)this.logger.warn(`Error al enviar mensaje pendiente (intento ${n.retries}/${n.maxRetries})`,t),this.pendingMessages.push(n);else if(this.logger.error(`Mensaje pendiente descartado después de ${n.retries} intentos fallidos`,t),this.handlers.onError){const e=new Event("message_failed");e.detail={message:n.message,error:t,retries:n.retries},this.handlers.onError(e)}}this.pendingMessages.length>0&&this.logger.info(`Quedan ${this.pendingMessages.length} mensaje(s) en cola de pendientes`)}handleConnectionError(e,t){this.logger.error("Error durante la conexión",e),this.clearConnectionTimeout(),this.connectionState=an.DISCONNECTED,t(e)}async joinProject(e){if(this.joinProjectInProgress)return void this.logger.warn("joinProject ya está en progreso, ignorando llamada duplicada");const t=Date.now();if(t-this.lastJoinProjectAttempt<this.MIN_JOIN_PROJECT_RETRY_INTERVAL)this.logger.debug("Throttling joinProject - último intento muy reciente");else if(this.lastJoinedProjectId===e&&t-this.lastJoinProjectSuccess<this.MIN_JOIN_PROJECT_INTERVAL)this.logger.debug(`Ignorando joinProject duplicado - ya unido a ${e}`);else{if(this.joinProjectRetries>=this.MAX_JOIN_PROJECT_RETRIES){if(this.lastJoinProjectError){const e=this.lastJoinProjectError.message.toLowerCase();if(e.includes("deploy not found")||e.includes("project deployment not found")||e.includes("eaddrnotavail"))throw this.logger.error(`joinProject falló permanentemente: ${this.lastJoinProjectError.message}`),this.lastJoinProjectError}throw setTimeout((()=>{this.joinProjectRetries=0,this.lastJoinProjectError=null,this.lastJoinProjectAttempt=0}),3e4),new Error(`joinProject falló después de ${this.MAX_JOIN_PROJECT_RETRIES} intentos`)}this.joinProjectInProgress=!0,this.lastJoinProjectAttempt=t;try{if(this.joinProjectRetries>0){const e=Math.min(this.joinProjectBackoffDelay*Math.pow(2,this.joinProjectRetries-1),1e4);this.logger.debug(`Aplicando backoff de ${e}ms (intento ${this.joinProjectRetries+1})`),await new Promise((t=>setTimeout(t,e)))}await this.emitWithAck("join_project",e),this.joinProjectRetries=0,this.lastJoinProjectError=null,this.lastJoinProjectSuccess=t,this.lastJoinedProjectId=e,this.logger.info("joinProject completado exitosamente")}catch(n){this.joinProjectRetries++,this.lastJoinProjectError=n instanceof Error?n:new Error(String(n));const e=n instanceof Error?n.message:String(n),t=e.toLowerCase().includes("deploy not found")||e.toLowerCase().includes("project deployment not found")||e.toLowerCase().includes("eaddrnotavail");if(this.logger.error(`Error en joinProject (intento ${this.joinProjectRetries}/${this.MAX_JOIN_PROJECT_RETRIES}):`,n),t)throw this.joinProjectRetries=this.MAX_JOIN_PROJECT_RETRIES,n;throw n}finally{this.joinProjectInProgress=!1}}}leaveProject(e){return this.emitWithAck("leave_project",e)}handleUnmountWebchat(e){this.logger.debug("Evento unmount webchat recibido",e),this.handlers.onUnmountWebchat&&this.handlers.onUnmountWebchat(e)}}class dn{constructor(){r(this,"DB_NAME","ChatHistoryDB"),r(this,"DB_VERSION",1),r(this,"STORE_NAME","messages"),r(this,"db",null),r(this,"initPromise",null),this.initPromise=this.initDB()}async initDB(){if(this.isIndexedDBAvailable())try{return new Promise(((e,t)=>{const n=indexedDB.open(this.DB_NAME,this.DB_VERSION);n.onerror=()=>{Be.error("IndexedDBRepository","Error al abrir IndexedDB",n.error),t(n.error)},n.onsuccess=()=>{this.db=n.result,Be.info("IndexedDBRepository","IndexedDB inicializado correctamente"),e()},n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.STORE_NAME)){const e=t.createObjectStore(this.STORE_NAME,{keyPath:"id"});e.createIndex("projectId_from",["projectId","from"],{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("conversation",["projectId","from","timestamp"],{unique:!1}),Be.info("IndexedDBRepository","Object store y índices creados")}}}))}catch(e){throw Be.error("IndexedDBRepository","Error al inicializar IndexedDB",e instanceof Error?e:void 0),e}else Be.warn("IndexedDBRepository","IndexedDB no está disponible en este navegador")}isIndexedDBAvailable(){try{return"undefined"!=typeof window&&"indexedDB"in window&&null!==window.indexedDB}catch{return!1}}async ensureDB(){if(this.initPromise&&await this.initPromise,!this.db)throw new Error("IndexedDB no está disponible");return this.db}generateMessageId(e){const t=`${e.projectId}|${e.from}|${e.sender}|${e.text.trim()}`;let n=2166136261,i=2166136261;for(let s=0;s<t.length;s++){const e=t.charCodeAt(s);n^=e,n=Math.imul(n,16777619),i^=e>>8||e,i=Math.imul(i,16777619)}return`msg_${`${Math.abs(n).toString(36)}_${Math.abs(i).toString(36)}`}`}async saveMessage(e){try{const t=await this.ensureDB();e.id||(e.id=this.generateMessageId(e)),Be.debug("IndexedDBRepository","Intentando guardar mensaje",{id:e.id,projectId:e.projectId,from:e.from,sender:e.sender,text:e.text.substring(0,50),textLength:e.text.length,timestamp:e.timestamp}),await new Promise(((n,i)=>{const s=t.transaction([this.STORE_NAME],"readwrite"),o=s.objectStore(this.STORE_NAME).add(e);o.onsuccess=()=>{Be.debug("IndexedDBRepository","Mensaje guardado exitosamente",{id:e.id,text:e.text.substring(0,30)}),n()},o.onerror=()=>{"ConstraintError"===o.error?.name?(Be.debug("IndexedDBRepository","Mensaje ya existe (ConstraintError, no duplicado)",{id:e.id,text:e.text.substring(0,30)}),n()):(Be.error("IndexedDBRepository","Error al guardar mensaje",o.error),i(o.error))},s.oncomplete=()=>{void 0!==o.result&&this.keepRecentMessages(e.projectId,e.from,25).catch((e=>{Be.error("IndexedDBRepository","Error al limpiar mensajes antiguos",e)}))}}))}catch(t){Be.error("IndexedDBRepository","Error fatal al guardar mensaje",t instanceof Error?t:void 0)}}async getMessages(e,t,n=25){try{const i=await this.ensureDB();return new Promise(((s,o)=>{const r=i.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).index("conversation"),a=IDBKeyRange.bound([e,t,0],[e,t,Date.now()]),c=r.openCursor(a,"prev"),l=[];c.onsuccess=e=>{const t=e.target.result;if(t&&l.length<n)l.push(t.value),t.continue();else{const e=l.reverse();Be.debug("IndexedDBRepository",`${e.length} mensajes recuperados`),s(e)}},c.onerror=()=>{Be.error("IndexedDBRepository","Error al obtener mensajes",c.error),o(c.error)}}))}catch(i){return Be.error("IndexedDBRepository","Error al obtener mensajes",i instanceof Error?i:void 0),[]}}async clearOldMessages(e,t,n=7){try{const i=await this.ensureDB(),s=Date.now()-24*n*60*60*1e3;return new Promise(((n,o)=>{const r=i.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).index("conversation"),a=IDBKeyRange.bound([e,t,0],[e,t,s]),c=r.openCursor(a);let l=0;c.onsuccess=e=>{const t=e.target.result;t?(t.delete(),l++,t.continue()):(Be.debug("IndexedDBRepository",`${l} mensajes antiguos eliminados`),n())},c.onerror=()=>{Be.error("IndexedDBRepository","Error al eliminar mensajes antiguos",c.error),o(c.error)}}))}catch(i){Be.error("IndexedDBRepository","Error al eliminar mensajes antiguos",i instanceof Error?i:void 0)}}async clearHistory(e,t){return this.clearAll(e,t)}async clearAll(e,t){try{const n=await this.ensureDB();return new Promise(((i,s)=>{const o=n.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).index("projectId_from"),r=IDBKeyRange.only([e,t]),a=o.openCursor(r);let c=0;a.onsuccess=e=>{const t=e.target.result;t?(t.delete(),c++,t.continue()):(Be.debug("IndexedDBRepository",`${c} mensajes eliminados`),i())},a.onerror=()=>{Be.error("IndexedDBRepository","Error al eliminar todos los mensajes",a.error),s(a.error)}}))}catch(n){Be.error("IndexedDBRepository","Error al eliminar todos los mensajes",n instanceof Error?n:void 0)}}async keepRecentMessages(e,t,n=25){try{const i=await this.ensureDB();return new Promise(((s,o)=>{const r=i.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).index("conversation"),a=IDBKeyRange.bound([e,t,0],[e,t,Date.now()]),c=r.openCursor(a,"prev"),l=[];c.onsuccess=e=>{const t=e.target.result;if(t)l.push({id:t.value.id,timestamp:t.value.timestamp}),t.continue();else if(l.length>n){const e=l.slice(n),t=i.transaction([this.STORE_NAME],"readwrite"),o=t.objectStore(this.STORE_NAME);e.forEach((e=>{o.delete(e.id)})),t.oncomplete=()=>{Be.debug("IndexedDBRepository",`${e.length} mensajes excedentes eliminados`),s()},t.onerror=()=>{Be.error("IndexedDBRepository","Error al eliminar mensajes excedentes"),s()}}else s()},c.onerror=()=>{Be.error("IndexedDBRepository","Error al mantener mensajes recientes",c.error),o(c.error)}}))}catch(i){Be.error("IndexedDBRepository","Error al mantener mensajes recientes",i instanceof Error?i:void 0)}}close(){this.db&&(this.db.close(),this.db=null,Be.info("IndexedDBRepository","Conexión a IndexedDB cerrada"))}}var un=(e=>(e.IDLE="idle",e.LISTENING="listening",e.PROCESSING="processing",e.ERROR="error",e))(un||{}),pn=(e=>(e.NO_SPEECH="no-speech",e.ABORTED="aborted",e.AUDIO_CAPTURE="audio-capture",e.NETWORK="network",e.NOT_ALLOWED="not-allowed",e.SERVICE_NOT_ALLOWED="service-not-allowed",e.BAD_GRAMMAR="bad-grammar",e.LANGUAGE_NOT_SUPPORTED="language-not-supported",e.NO_MATCH="no-match",e.UNKNOWN="unknown",e))(pn||{});class mn{constructor(){r(this,"recognition",null),r(this,"currentState",un.IDLE),r(this,"resultCallback",null),r(this,"errorCallback",null),r(this,"endCallback",null),r(this,"startCallback",null),r(this,"unavailableCallback",null),Be.debug("SpeechRecognitionRepository","Instancia creada")}isSupported(){const e="undefined"==typeof window?{isSupported:!1,message:"No se está ejecutando en un entorno de navegador"}:"SpeechRecognition"in window?{isSupported:!0,apiName:"SpeechRecognition",message:"El navegador soporta la Web Speech API (SpeechRecognition)"}:"webkitSpeechRecognition"in window?{isSupported:!0,apiName:"webkitSpeechRecognition",message:"El navegador soporta la Web Speech API (webkitSpeechRecognition)"}:{isSupported:!1,message:"El navegador no soporta la Web Speech API. Se recomienda usar Chrome, Edge o Safari."};return{isSupported:e.isSupported,apiName:e.apiName,message:e.message}}start(e){const t=this.isSupported();if(!t.isSupported)return Be.error("SpeechRecognitionRepository","Navegador no soporta Speech Recognition"),void this.handleError({type:pn.SERVICE_NOT_ALLOWED,message:t.message,timestamp:new Date});this.recognition&&this.stop();try{const t=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new t;const n={...{language:"es-ES",continuous:!1,interimResults:!0,maxAlternatives:1},...e};this.recognition.lang=n.language,this.recognition.continuous=n.continuous,this.recognition.interimResults=n.interimResults,this.recognition.maxAlternatives=n.maxAlternatives,this.setupEventHandlers(),this.recognition.start(),Be.info("SpeechRecognitionRepository","Reconocimiento de voz iniciado",{options:n})}catch(n){Be.error("SpeechRecognitionRepository","Error al iniciar reconocimiento",n instanceof Error?n:void 0),this.handleError({type:pn.UNKNOWN,message:n instanceof Error?n.message:"Error desconocido al iniciar reconocimiento",timestamp:new Date})}}stop(){if(this.recognition)try{this.recognition.stop(),Be.info("SpeechRecognitionRepository","Reconocimiento de voz detenido")}catch(e){Be.error("SpeechRecognitionRepository","Error al detener reconocimiento",e instanceof Error?e:void 0)}else Be.warn("SpeechRecognitionRepository","No hay reconocimiento activo para detener")}abort(){if(!this.recognition)return Be.debug("SpeechRecognitionRepository","No hay reconocimiento activo para abortar"),void(this.unavailableCallback&&this.unavailableCallback());try{this.recognition.abort(),this.currentState=un.IDLE,Be.info("SpeechRecognitionRepository","Reconocimiento de voz abortado")}catch(e){Be.error("SpeechRecognitionRepository","Error al abortar reconocimiento",e instanceof Error?e:void 0)}}getState(){return this.currentState}onResult(e){this.resultCallback=e}onError(e){this.errorCallback=e}onEnd(e){this.endCallback=e}onStart(e){this.startCallback=e}onUnavailable(e){this.unavailableCallback=e}dispose(){this.recognition&&(this.abort(),this.recognition=null),this.resultCallback=null,this.errorCallback=null,this.endCallback=null,this.startCallback=null,this.unavailableCallback=null,this.currentState=un.IDLE,Be.debug("SpeechRecognitionRepository","Recursos liberados")}setupEventHandlers(){this.recognition&&(this.recognition.onstart=()=>{this.currentState=un.LISTENING,Be.debug("SpeechRecognitionRepository","Evento: start"),this.startCallback&&this.startCallback()},this.recognition.onresult=e=>{if(Be.debug("SpeechRecognitionRepository","Evento: result",{resultIndex:e.resultIndex,resultsLength:e.results.length}),!e.results||0===e.results.length)return;const t=e.results[e.resultIndex];if(!t||0===t.length)return;const n=t[0],i=n.transcript,s=n.confidence||0,o=t.isFinal;Be.debug("SpeechRecognitionRepository","Transcripción recibida",{transcript:i.substring(0,50),confidence:s,isFinal:o}),this.resultCallback&&this.resultCallback({transcript:i,confidence:s,isFinal:o,timestamp:new Date}),o&&(this.currentState=un.PROCESSING)},this.recognition.onerror=e=>{Be.error("SpeechRecognitionRepository","Evento: error",void 0,{error:e.error});const t=this.mapErrorType(e.error),n=this.getErrorMessage(t,e.error);this.handleError({type:t,message:n,timestamp:new Date})},this.recognition.onend=()=>{Be.debug("SpeechRecognitionRepository","Evento: end"),this.currentState=un.IDLE,this.endCallback&&this.endCallback()},this.recognition.onspeechend=()=>{Be.debug("SpeechRecognitionRepository","Evento: speechend (el usuario dejó de hablar)")})}handleError(e){this.currentState=un.ERROR,this.errorCallback&&this.errorCallback(e)}mapErrorType(e){return{"no-speech":pn.NO_SPEECH,aborted:pn.ABORTED,"audio-capture":pn.AUDIO_CAPTURE,network:pn.NETWORK,"not-allowed":pn.NOT_ALLOWED,"service-not-allowed":pn.SERVICE_NOT_ALLOWED,"bad-grammar":pn.BAD_GRAMMAR,"language-not-supported":pn.LANGUAGE_NOT_SUPPORTED,"no-match":pn.NO_MATCH}[e]||pn.UNKNOWN}getErrorMessage(e,t){return{[pn.NO_SPEECH]:"No se detectó voz. Por favor, intenta hablar más alto o acércate al micrófono.",[pn.ABORTED]:"El reconocimiento de voz fue cancelado.",[pn.AUDIO_CAPTURE]:"No se pudo capturar audio. Verifica que el micrófono esté conectado y funcionando.",[pn.NETWORK]:"Error de red. Verifica tu conexión a internet.",[pn.NOT_ALLOWED]:"Permiso denegado. Por favor, permite el acceso al micrófono en la configuración del navegador.",[pn.SERVICE_NOT_ALLOWED]:"El servicio de reconocimiento de voz no está disponible.",[pn.BAD_GRAMMAR]:"Error de gramática en el reconocimiento.",[pn.LANGUAGE_NOT_SUPPORTED]:"El idioma seleccionado no es soportado.",[pn.NO_MATCH]:"No se pudo reconocer lo que dijiste. Por favor, intenta de nuevo.",[pn.UNKNOWN]:`Error desconocido: ${t}`}[e]||`Error desconocido: ${t}`}}class gn extends HTMLElement{constructor(){super(),r(this,"typewriterTimeout",null),r(this,"isTyping",!1),r(this,"typewriterSpeed",50),r(this,"animationPromise"),r(this,"animationResolve",null),r(this,"hasRendered",!1),r(this,"isElementConnected",!1),this.animationPromise=new Promise((e=>{this.animationResolve=e}))}static get observedAttributes(){return["text","is-user","animate"]}connectedCallback(){this.isElementConnected=!0,this.hasRendered||this.render()}attributeChangedCallback(){this.isElementConnected&&!this.hasRendered&&this.render()}async waitForAnimation(){return this.animationPromise}render(){if(this.hasRendered)return;const e=this.getAttribute("text"),t=Se(this.getAttribute("is-user"),!1),n=Se(this.getAttribute("animate"),!1);if(!e)return;this.hasRendered=!0;const i=document.createElement("div");if(i.className="message-bubble "+(t?"user":"agent"),i.setAttribute("role","article"),i.setAttribute("aria-label","Mensaje "+(t?"del usuario":"del agente")),this.innerHTML="",this.appendChild(i),t||!n)return i.innerHTML=ye(e),void this.completeAnimation();this.typewriterEffect(i,e)}typewriterEffect(e,t){this.isTyping=!0;const n=t.split(" ");let i=0,s="";const o=document.createElement("span");o.className="typewriter-cursor",o.textContent="▋";const r=t.length>500?30:this.typewriterSpeed,a=()=>{if(!this.isConnected)return this.isTyping=!1,void(this.typewriterTimeout&&(clearTimeout(this.typewriterTimeout),this.typewriterTimeout=null));i<n.length?(s+=(i>0?" ":"")+n[i],e.innerHTML=be(s),e.appendChild(o),i++,t.length>200?requestAnimationFrame((()=>{this.typewriterTimeout=window.setTimeout(a,r)})):this.typewriterTimeout=window.setTimeout(a,r)):(o.remove(),this.isTyping=!1,e.innerHTML=ye(t),this.completeAnimation())};a()}completeAnimation(){this.dispatchEvent(new CustomEvent("typewriter-complete")),this.animationResolve&&(this.animationResolve(),this.animationResolve=null,this.animationPromise=Promise.resolve())}disconnectedCallback(){this.isElementConnected=!1,this.typewriterTimeout&&(clearTimeout(this.typewriterTimeout),this.typewriterTimeout=null)}}Ee("chat-message",gn);class fn extends HTMLElement{constructor(){super(),r(this,"shadow"),r(this,"darkModeObserver",null),r(this,"hasRendered",!1),r(this,"isElementConnected",!1),r(this,"imageErrorHandler",null),r(this,"handleImageError",(e=>{const t=e.target;if(t){t.style.display="none";const e=this.shadow.querySelector(".avatar-initials");e&&(e.style.display="flex")}})),this.shadow=this.attachShadow({mode:"open"})}static get observedAttributes(){return["src","initials","size"]}connectedCallback(){this.isElementConnected=!0,this.render(),this.observeDarkMode(),this.hasRendered=!0}disconnectedCallback(){if(this.isElementConnected=!1,this.darkModeObserver&&(this.darkModeObserver.disconnect(),this.darkModeObserver=null),this.imageErrorHandler){const e=this.shadow.querySelector("img");e&&e.removeEventListener("error",this.imageErrorHandler),this.imageErrorHandler=null}}attributeChangedCallback(e,t,n){t!==n&&(this.isElementConnected||this.shadowRoot)&&this.render()}checkDarkMode(){if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector(".avatar-container");if(!e)return;this.closest(".dark-mode")||document.querySelector(".dark-mode")?e.classList.add("dark-mode"):e.classList.remove("dark-mode")}observeDarkMode(){this.darkModeObserver=new MutationObserver((()=>{this.checkDarkMode()}));const e=document.querySelector(".chat-widget-container");e&&this.darkModeObserver.observe(e,{attributes:!0,attributeFilter:["class"]}),this.checkDarkMode()}render(){if(!this.shadowRoot)return;const e=this.getAttribute("src")||"",t=this.getAttribute("initials")||"",n=this.getAttribute("size")||"32",i=parseInt(n,10)||32,s=e&&""!==e.trim()&&"undefined"!==e.trim()&&"null"!==e.trim(),o=t||"?",r=s?e.trim():"",a=o?Ce(o.substring(0,2).toUpperCase()):"?";this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: inline-block;\n          width: ${i}px;\n          height: ${i}px;\n        }\n        .avatar-container {\n          width: 100%;\n          height: 100%;\n          border-radius: 50%;\n          background-color: var(--chat-light-gray, #F3F4F6);\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          overflow: hidden;\n          position: relative;\n          flex-shrink: 0;\n        }\n        .avatar-container.dark-mode {\n          background-color: var(--chat-light-gray, #374151);\n        }\n        .avatar-image {\n          width: 100%;\n          height: 100%;\n          object-fit: cover;\n          border-radius: 50%;\n          display: block;\n        }\n        .avatar-initials {\n          width: 100%;\n          height: 100%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: ${Math.max(.4*i,12)}px;\n          font-weight: var(--chat-font-weight-semibold, 600);\n          color: var(--chat-secondary-color, #4B5563);\n          font-family: var(--chat-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif);\n          user-select: none;\n          position: absolute;\n          top: 0;\n          left: 0;\n        }\n        ${s?"\n        .avatar-image {\n          display: block;\n        }\n        .avatar-initials {\n          display: none;\n        }\n        ":"\n        .avatar-image {\n          display: none;\n        }\n        .avatar-initials {\n          display: flex;\n        }\n        "}\n        .avatar-container.dark-mode .avatar-initials {\n          color: var(--chat-secondary-color, #9CA3AF);\n        }\n      </style>\n      <div class="avatar-container">\n        <img class="avatar-image" src="${s?r.replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}" alt="Avatar" loading="lazy" style="display: ${s?"block":"none"};" />\n        <div class="avatar-initials" style="display: ${s?"none":"flex"};">${a}</div>\n      </div>\n    `,setTimeout((()=>{const e=this.shadow.querySelector(".avatar-image"),t=this.shadow.querySelector(".avatar-initials");if(e&&t)if(s){e.style.display="block",t.style.display="none",this.imageErrorHandler&&e.removeEventListener("error",this.imageErrorHandler),this.imageErrorHandler=this.handleImageError,e.addEventListener("error",this.imageErrorHandler);const n=()=>{e.style.display="block",t&&(t.style.display="none")};e.complete&&0!==e.naturalHeight?n():e.addEventListener("load",n,{once:!0})}else t.style.display="flex",e.style.display="none"}),0),setTimeout((()=>this.checkDarkMode()),0)}}Ee("chat-avatar",fn);class bn extends HTMLElement{constructor(){super(),r(this,"backButton",null),r(this,"moreOptionsButton",null),r(this,"clearButton",null),r(this,"resizeButton",null),r(this,"statusIndicator",null),r(this,"connectionStatus",null),r(this,"handleBackClick",(e=>{e.preventDefault(),this.dispatchEvent(new CustomEvent("back-click",{bubbles:!0,cancelable:!0}))})),r(this,"handleMoreOptionsClick",(e=>{e.preventDefault(),this.dispatchEvent(new CustomEvent("more-options-click",{bubbles:!0,cancelable:!0}))})),r(this,"handleClearClick",(e=>{e.preventDefault(),this.dispatchEvent(new CustomEvent("clear-conversation",{bubbles:!0,cancelable:!0}))})),r(this,"handleResizeClick",(e=>{e.preventDefault(),this.dispatchEvent(new CustomEvent("resize-toggle",{bubbles:!0,cancelable:!0}))}))}static get observedAttributes(){return["company-name","subtitle","connected","avatar-src","avatar-initials","expanded"]}connectedCallback(){this.render(),this.attachEventListeners()}attributeChangedCallback(e,t,n){t!==n&&("connected"===e?this.updateConnectionStatus():"expanded"===e?this.updateResizeIcon():(this.render(),this.attachEventListeners()))}attachEventListeners(){this.backButton=this.querySelector(".back-button"),this.backButton&&(this.backButton.removeEventListener("click",this.handleBackClick),this.backButton.addEventListener("click",this.handleBackClick)),this.moreOptionsButton=this.querySelector(".more-options"),this.moreOptionsButton&&(this.moreOptionsButton.removeEventListener("click",this.handleMoreOptionsClick),this.moreOptionsButton.addEventListener("click",this.handleMoreOptionsClick)),this.clearButton=this.querySelector(".clear-button"),this.clearButton&&(this.clearButton.removeEventListener("click",this.handleClearClick),this.clearButton.addEventListener("click",this.handleClearClick)),this.resizeButton=this.querySelector(".resize-button"),this.resizeButton&&(this.resizeButton.removeEventListener("click",this.handleResizeClick),this.resizeButton.addEventListener("click",this.handleResizeClick)),this.updateConnectionStatus()}updateConnectionStatus(){const e=Se(this.getAttribute("connected"),!1);this.statusIndicator=this.querySelector(".status-indicator"),this.connectionStatus=this.querySelector(".connection-status"),this.statusIndicator&&this.connectionStatus&&(e?(this.statusIndicator.classList.remove("disconnected"),this.statusIndicator.classList.add("connected"),this.connectionStatus.setAttribute("title","Servidor conectado"),this.connectionStatus.setAttribute("aria-label","Estado: Conectado")):(this.statusIndicator.classList.remove("connected"),this.statusIndicator.classList.add("disconnected"),this.connectionStatus.setAttribute("title","Servidor desconectado"),this.connectionStatus.setAttribute("aria-label","Estado: Desconectado")))}updateResizeIcon(){const e=Se(this.getAttribute("expanded"),!1);if(this.resizeButton=this.querySelector(".resize-button"),this.resizeButton){const t='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>';this.resizeButton.innerHTML=e?t:n,this.resizeButton.setAttribute("aria-label",e?"Minimizar tamaño":"Maximizar tamaño"),this.resizeButton.setAttribute("title",e?"Minimizar tamaño":"Maximizar tamaño")}}render(){const e=this.getAttribute("company-name")||"",t=this.getAttribute("subtitle")||"",n=this.getAttribute("avatar-src")||"",i=this.getAttribute("avatar-initials")||e.charAt(0)||"",s=Ce(e),o=t?Ce(t):"",r=document.createElement("div");if(r.className="header-title",n||i){const e=document.createElement("chat-avatar");e.setAttribute("size","32"),i&&e.setAttribute("initials",i),n&&""!==n.trim()&&e.setAttribute("src",n),r.appendChild(e)}const a=document.createElement("div");a.className="meeting-info";const c=document.createElement("h3");if(c.className="meeting-name truncate-title",c.textContent=s,a.appendChild(c),o){const e=document.createElement("p");e.className="meeting-subtitle truncate-subtitle",e.textContent=o,a.appendChild(e)}r.appendChild(a);const l=document.createElement("button");l.className="back-button",l.setAttribute("aria-label","Minimizar chat"),l.setAttribute("type","button"),l.setAttribute("title","Minimizar chat"),l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>';const h=Se(this.getAttribute("expanded"),!1),d=document.createElement("button");d.className="resize-button",d.setAttribute("aria-label",h?"Minimizar tamaño":"Maximizar tamaño"),d.setAttribute("type","button"),d.setAttribute("title",h?"Minimizar tamaño":"Maximizar tamaño"),d.innerHTML=h?'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>';const u=document.createElement("button");u.className="clear-button",u.setAttribute("aria-label","Limpiar conversación"),u.setAttribute("type","button"),u.setAttribute("title","Limpiar conversación"),u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>',this.innerHTML="",this.appendChild(r),this.appendChild(l),this.appendChild(d),this.appendChild(u)}}Ee("chat-header",bn);class yn extends HTMLElement{constructor(){super(),r(this,"hasRendered",!1),r(this,"isElementConnected",!1)}static get observedAttributes(){return["text","is-user","avatar","media","animate","timestamp","author","locale","show-timestamp","selected-element-tag","selected-element-selector","selected-element-text"]}connectedCallback(){this.isElementConnected=!0,this.hasRendered||this.render()}attributeChangedCallback(e){"show-timestamp"===e&&this.hasRendered?this.updateTimestamp():this.isElementConnected&&!this.hasRendered&&this.render()}async waitForAnimation(){await new Promise((e=>requestAnimationFrame((()=>{requestAnimationFrame((()=>e(null)))}))));const e=this.querySelector("chat-message");e&&e.waitForAnimation&&await e.waitForAnimation()}render(){if(this.hasRendered)return;this.hasRendered=!0;const e=this.getAttribute("text"),t=Se(this.getAttribute("is-user"),!1);this.getAttribute("avatar");const n=this.getAttribute("media"),i=Se(this.getAttribute("animate"),!1),s=this.getAttribute("timestamp"),o=this.getAttribute("locale")||"es",r=Se(this.getAttribute("show-timestamp"),!1),a=this.getAttribute("selected-element-tag"),c=this.getAttribute("selected-element-selector"),l=this.getAttribute("selected-element-text"),h=!(!a&&!c),d=Ie(o);this.getAttribute("author")||(t?d.you:d.agent),this.className="message-wrapper "+(t?"user":"agent"),this.setAttribute("role","article"),this.setAttribute("aria-label","Mensaje "+(t?"del usuario":"del agente"));const u=n?Ce(n):"",p=e?Ce(e):"",m=a?Ce(a):"",g=c?Ce(c):"",f=l?Ce(l):"",b=s?Fe(s,o):"",y=!t&&r;this.innerHTML=`\n      <div class="message-content">\n        ${u?`<message-media src="${u}" modal></message-media>`:""}\n        ${h?`<selected-element tag="${m}" selector="${g}" text="${f}"></selected-element>`:""}\n        ${p?`<chat-message text="${p}" is-user="${t}" animate="${i}"></chat-message>`:""}\n      </div>\n      ${y?`<div class="message-timestamp">\n        ${b?`<span class="message-time">${b}</span>`:""}\n      </div>`:""}\n    `}updateTimestamp(){const e=Se(this.getAttribute("show-timestamp"),!1);if(Se(this.getAttribute("is-user"),!1))return;const t=this.getAttribute("timestamp"),n=this.getAttribute("locale")||"es",i=Ie(n);this.getAttribute("author")||i.agent;const s=t?Fe(t,n):"";let o=this.querySelector(".message-timestamp");e&&!o?(o=document.createElement("div"),o.className="message-timestamp",o.innerHTML=`\n        ${s?`<span class="message-time">${s}</span>`:""}\n      `,this.appendChild(o)):!e&&o&&o.remove()}}Ee("message-wrapper",yn);class vn{constructor(e){r(this,"repository"),r(this,"currentTranscript",""),r(this,"isListening",!1),r(this,"transcriptionCallback",null),r(this,"errorCallback",null),r(this,"stateChangeCallback",null),r(this,"endCallback",null),r(this,"unavailableCallback",null),this.repository=e,this.setupRepositoryCallbacks(),Be.debug("SpeechRecognitionService","Servicio creado")}checkSupport(){return this.repository.isSupported()}startListening(e){if(this.isListening)return void Be.warn("SpeechRecognitionService","Ya hay un reconocimiento activo");const t=this.checkSupport();if(!t.isSupported)return Be.error("SpeechRecognitionService","Navegador no soporta reconocimiento de voz"),void(this.errorCallback&&this.errorCallback({type:pn.SERVICE_NOT_ALLOWED,message:t.message,timestamp:new Date}));this.currentTranscript="",this.isListening=!0,Be.info("SpeechRecognitionService","Iniciando escucha",{options:e}),this.repository.start(e)}stopListening(){this.isListening?(Be.info("SpeechRecognitionService","Deteniendo escucha"),this.repository.stop(),this.isListening=!1):Be.warn("SpeechRecognitionService","No hay reconocimiento activo para detener")}abort(){Be.info("SpeechRecognitionService","Abortando reconocimiento"),this.repository.abort(),this.isListening=!1,this.currentTranscript=""}toggleListening(e){this.isListening?this.stopListening():this.startListening(e)}isCurrentlyListening(){return this.isListening}getState(){return this.repository.getState()}getCurrentTranscript(){return this.currentTranscript}clearTranscript(){this.currentTranscript="",Be.debug("SpeechRecognitionService","Transcripción limpiada")}onTranscription(e){this.transcriptionCallback=e}onError(e){this.errorCallback=e}onStateChange(e){this.stateChangeCallback=e}onEnd(e){this.endCallback=e}onUnavailable(e){this.unavailableCallback=e,this.repository.onUnavailable(e)}dispose(){Be.info("SpeechRecognitionService","Liberando recursos"),this.abort(),this.repository.dispose(),this.transcriptionCallback=null,this.errorCallback=null,this.stateChangeCallback=null,this.endCallback=null,this.unavailableCallback=null,this.currentTranscript=""}setupRepositoryCallbacks(){this.repository.onResult((e=>{if(Be.debug("SpeechRecognitionService","Resultado recibido",{transcript:e.transcript.substring(0,50),isFinal:e.isFinal,confidence:e.confidence}),e.isFinal&&(this.currentTranscript?this.currentTranscript+=" "+e.transcript:this.currentTranscript=e.transcript),this.transcriptionCallback){const t=e.isFinal?this.currentTranscript:(this.currentTranscript?this.currentTranscript+" ":"")+e.transcript;this.transcriptionCallback(t,e.isFinal)}})),this.repository.onError((e=>{Be.error("SpeechRecognitionService","Error recibido",void 0,{type:e.type,message:e.message}),this.isListening=!1,this.errorCallback&&this.errorCallback(e),this.stateChangeCallback&&this.stateChangeCallback(un.ERROR)})),this.repository.onStart((()=>{Be.debug("SpeechRecognitionService","Reconocimiento iniciado"),this.isListening=!0,this.stateChangeCallback&&this.stateChangeCallback(un.LISTENING)})),this.repository.onEnd((()=>{Be.debug("SpeechRecognitionService","Reconocimiento finalizado"),this.isListening=!1,this.endCallback&&this.endCallback(),this.stateChangeCallback&&this.stateChangeCallback(un.IDLE)}))}getErrorMessage(e){return e.message}isRecoverableError(e){return[pn.NO_SPEECH,pn.NO_MATCH,pn.ABORTED].includes(e.type)}}const wn={SEND:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">\x3c!-- Icon from Material Symbols by Google - https://github.com/google/material-design-icons/blob/master/LICENSE --\x3e<path fill="currentColor" d="M11 18V9.825L7.4 13.4L6 12l6-6l6 6l-1.4 1.4L13 9.825V18h-2Z"/></svg>',EMOJI:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">\x3c!-- Icon from ProIcons by ProCode - https://github.com/ProCode-Software/proicons/blob/main/LICENSE --\x3e<g fill="none"><circle cx="12" cy="12" r="9.25" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/><circle cx="9" cy="9.5" r="1.25" fill="currentColor"/><circle cx="15" cy="9.5" r="1.25" fill="currentColor"/><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.464 14.25a4 4 0 0 1-6.928 0"/></g></svg>',SELECTOR:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path fill="currentColor" d="M13 13l6 6"/></svg>',MICROPHONE:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">\x3c!-- Icon from Material Symbols by Google - https://github.com/google/material-design-icons/blob/master/LICENSE --\x3e<path fill="currentColor" d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm0-2q.425 0 .713-.288T13 11V5q0-.425-.288-.713T12 4q-.425 0-.713.288T11 5v6q0 .425.288.713T12 12Zm-1 9v-3.075q-2.6-.35-4.3-2.325T5 11h2q0 2.075 1.463 3.537T12 16q2.075 0 3.538-1.463T17 11h2q0 2.625-1.7 4.6T13 17.925V21h-2Z"/></svg>',MICROPHONE_LISTENING:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">\x3c!-- Icon from Material Symbols by Google - https://github.com/google/material-design-icons/blob/master/LICENSE --\x3e<path fill="currentColor" d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 9v-3.075q-2.6-.35-4.3-2.325T5 11h2q0 2.075 1.463 3.537T12 16q2.075 0 3.538-1.463T17 11h2q0 2.625-1.7 4.6T13 17.925V21h-2Z"/></svg>'},kn=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠","😈","👿","👹","👺","🤡","💩","👻","💀","☠️","👽","👾","🤖","👍","👎","👊","✊","🤛","🤜","🤞","✌️","🤟","🤘","👌","🤌","🤏","👏","🙌","👐","🤲","🤝","🙏","✍️","❤️","🧡","💛","💚","💙","💜","🖤","🤍","🤎","💔","💕","💞","💓","💗","💖","💘","💝","💟","🔥","⭐","🌟","✨","💫","💥","💢","💯","✅","❌","⭕","🎉","🎊","🎈","🎁","🏆","🥇","🥈","🥉","🎖️","🏅","🎗️"];class xn extends HTMLElement{constructor(){super(),r(this,"inputField",null),r(this,"sendButton",null),r(this,"attachButton",null),r(this,"emojiButton",null),r(this,"selectorButton",null),r(this,"microphoneButton",null),r(this,"form",null),r(this,"emojiPicker",null),r(this,"isEmojiPickerOpen",!1),r(this,"outsideClickHandler",null),r(this,"messageTimestamps",[]),r(this,"isThrottled",!1),r(this,"throttleTimeout",null),r(this,"FLOOD_THRESHOLD",5),r(this,"FLOOD_WINDOW",3e3),r(this,"THROTTLE_DURATION",5e3),r(this,"speechService",null),r(this,"isSpeechSupported",!1),r(this,"isListening",!1),r(this,"boundHandleSubmit"),r(this,"boundHandleInputChange"),r(this,"boundHandleKeyPress"),r(this,"boundHandleKeyDown"),r(this,"boundHandleAttachClick"),r(this,"boundHandleEmojiClick"),r(this,"boundHandleSelectorClick"),r(this,"boundHandleMicrophoneClick"),this.boundHandleSubmit=this.handleSubmit.bind(this),this.boundHandleInputChange=this.handleInputChange.bind(this),this.boundHandleKeyPress=this.handleKeyPress.bind(this),this.boundHandleKeyDown=this.handleKeyDown.bind(this),this.boundHandleAttachClick=this.handleAttachClick.bind(this),this.boundHandleEmojiClick=this.handleEmojiClick.bind(this),this.boundHandleSelectorClick=this.handleSelectorClick.bind(this),this.boundHandleMicrophoneClick=this.handleMicrophoneClick.bind(this)}static get observedAttributes(){return["placeholder","disabled","throttled"]}connectedCallback(){this.initializeSpeechRecognition(),this.render(),this.attachEventListeners()}disconnectedCallback(){(this.emojiPicker||this.isEmojiPickerOpen)&&this.closeEmojiPicker(),this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.removeEventListeners(),this.throttleTimeout&&(clearTimeout(this.throttleTimeout),this.throttleTimeout=null),this.speechService&&(this.speechService.dispose(),this.speechService=null),this.messageTimestamps=[]}attributeChangedCallback(e,t,n){if(t!==n&&("placeholder"===e&&this.inputField&&(this.inputField.placeholder=n||"Escribe un mensaje..."),"disabled"===e)){const e=this.hasAttribute("disabled");this.inputField&&(this.inputField.disabled=e),this.sendButton&&(this.sendButton.disabled=e)}}render(){const e=this.getAttribute("placeholder")||"Escribe un mensaje...",t=this.hasAttribute("disabled"),n=this.escapeHTML(e);this.innerHTML=`\n      <form class="chat-input">\n        <div class="input-container">\n          <textarea \n            class="input-field" \n            spellcheck="false"\n            placeholder="${n}"\n            rows="1"\n            role="textbox"\n            aria-label="Campo de entrada de mensaje"\n            aria-required="false"\n            ${t?"disabled":""}\n          ></textarea>\n        </div>\n        <div class="input-actions-container">\n          <div class="input-actions">\n            ${this.isSpeechSupported?`\n            <button \n              type="button" \n              class="action-button mic-btn" \n              title="Reconocimiento de voz"\n              aria-label="Activar reconocimiento de voz"\n            >\n              ${wn.MICROPHONE}\n            </button>\n            `:""}\n            <button \n              type="button" \n              class="action-button selector-btn" \n              title="Selector de elementos"\n              aria-label="Activar selector de elementos"\n            >\n              ${wn.SELECTOR}\n            </button>\n            <button \n              type="button" \n              class="action-button emoji-btn" \n              title="Emoji"\n              aria-label="Abrir selector de emojis"\n            >\n              ${wn.EMOJI}\n            </button>\n          </div>\n          <button \n            type="submit" \n            class="send-button" \n            disabled\n            aria-label="Enviar mensaje"\n          >\n            ${wn.SEND}\n          </button>\n        </div>\n      </form>\n    `,this.form=this.querySelector("form"),this.inputField=this.querySelector(".input-field"),this.sendButton=this.querySelector(".send-button"),this.attachButton=this.querySelector(".attach-btn"),this.emojiButton=this.querySelector(".emoji-btn"),this.selectorButton=this.querySelector(".selector-btn"),this.microphoneButton=this.querySelector(".mic-btn")}attachEventListeners(){this.form&&this.inputField&&this.sendButton&&(this.form.addEventListener("submit",this.boundHandleSubmit),this.inputField.addEventListener("input",this.boundHandleInputChange),this.inputField.addEventListener("keypress",this.boundHandleKeyPress),this.inputField.addEventListener("keydown",this.boundHandleKeyDown),this.attachButton&&this.attachButton.addEventListener("click",this.boundHandleAttachClick),this.emojiButton&&this.emojiButton.addEventListener("click",this.boundHandleEmojiClick),this.selectorButton&&this.selectorButton.addEventListener("click",this.boundHandleSelectorClick),this.microphoneButton&&this.microphoneButton.addEventListener("click",this.boundHandleMicrophoneClick))}removeEventListeners(){this.form&&this.form.removeEventListener("submit",this.boundHandleSubmit),this.inputField&&(this.inputField.removeEventListener("input",this.boundHandleInputChange),this.inputField.removeEventListener("keypress",this.boundHandleKeyPress),this.inputField.removeEventListener("keydown",this.boundHandleKeyDown)),this.attachButton&&this.attachButton.removeEventListener("click",this.boundHandleAttachClick),this.emojiButton&&this.emojiButton.removeEventListener("click",this.boundHandleEmojiClick),this.selectorButton&&this.selectorButton.removeEventListener("click",this.boundHandleSelectorClick),this.microphoneButton&&this.microphoneButton.removeEventListener("click",this.boundHandleMicrophoneClick)}handleSubmit(e){e.preventDefault(),this.submitMessage()}handleInputChange(){this.inputField&&this.sendButton&&(this.sendButton.disabled=!this.inputField.value.trim(),this.adjustTextareaHeight())}handleKeyDown(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.submitMessage())}handleKeyPress(e){}adjustTextareaHeight(){if(!this.inputField)return;this.inputField.style.height="auto";const e=this.inputField.scrollHeight;this.inputField.style.height=Math.min(e,120)+"px",this.inputField.style.overflowY=e>120?"auto":"hidden"}handleAttachClick(){this.dispatchEvent(new CustomEvent("attach-click",{bubbles:!0,composed:!0}))}handleEmojiClick(e){e.stopPropagation(),this.toggleEmojiPicker()}handleSelectorClick(e){e.stopPropagation();const t=this.selectorButton?.classList.contains("active");t?this.selectorButton?.classList.remove("active"):this.selectorButton?.classList.add("active"),this.dispatchEvent(new CustomEvent("selector-toggle",{bubbles:!0,composed:!0,detail:{active:!t}}))}toggleEmojiPicker(){this.isEmojiPickerOpen?this.closeEmojiPicker():this.openEmojiPicker()}openEmojiPicker(){this.isEmojiPickerOpen||(this.isEmojiPickerOpen=!0,this.createEmojiPicker(),this.positionEmojiPicker(),this.outsideClickHandler=this.handleOutsideClick.bind(this),setTimeout((()=>{this.outsideClickHandler&&document.addEventListener("click",this.outsideClickHandler)}),0))}closeEmojiPicker(){(this.isEmojiPickerOpen||this.emojiPicker)&&(this.isEmojiPickerOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.emojiPicker&&(this.emojiPicker.parentNode&&this.emojiPicker.remove(),this.emojiPicker=null))}handleOutsideClick(e){const t=e.target;!this.emojiPicker||this.emojiPicker.contains(t)||this.emojiButton?.contains(t)||this.closeEmojiPicker()}createEmojiPicker(){this.emojiPicker=document.createElement("div"),this.emojiPicker.className="emoji-picker";const e=document.createElement("div");e.className="emoji-picker-grid",kn.forEach((t=>{const n=document.createElement("button");n.type="button",n.className="emoji-picker-item",n.textContent=t,n.setAttribute("aria-label",`Emoji ${t}`),n.addEventListener("click",(e=>{e.stopPropagation(),this.insertEmoji(t),this.closeEmojiPicker()})),e.appendChild(n)})),this.emojiPicker.appendChild(e),document.body.appendChild(this.emojiPicker)}positionEmojiPicker(){this.emojiPicker&&this.emojiButton&&setTimeout((()=>{if(!this.emojiPicker||!this.emojiButton)return;const e=this.emojiButton.getBoundingClientRect(),t=this.emojiPicker.getBoundingClientRect(),n=t.height||300,i=t.width||280;let s=e.top-n-8,o=e.left-i/2+e.width/2;s<8&&(s=e.bottom+8),o<8&&(o=8);const r=window.innerWidth-i-8;o>r&&(o=r),this.emojiPicker.style.position="fixed",this.emojiPicker.style.top=`${Math.max(8,s)}px`,this.emojiPicker.style.left=`${Math.max(8,o)}px`,this.emojiPicker.style.zIndex="10000"}),0)}insertEmoji(e){if(!this.inputField)return;const t=this.inputField.selectionStart||0,n=this.inputField.selectionEnd||0,i=this.inputField.value;this.inputField.value=i.substring(0,t)+e+i.substring(n);const s=t+e.length;this.inputField.setSelectionRange(s,s),this.inputField.dispatchEvent(new Event("input",{bubbles:!0})),this.inputField.focus()}submitMessage(){if(!this.inputField||this.isThrottled)return;const e=this.inputField.value.trim();if(!e)return;if(this.detectMessageFlood())return this.activateThrottle(),void(this.inputField.value="");const t=new CustomEvent("message-submit",{bubbles:!0,composed:!0,detail:{message:e}});this.dispatchEvent(t),this.inputField.value="",this.inputField.style.height="auto",this.sendButton&&(this.sendButton.disabled=!0),this.inputField.focus()}detectMessageFlood(){const e=Date.now();return this.messageTimestamps=this.messageTimestamps.filter((t=>e-t<this.FLOOD_WINDOW)),this.messageTimestamps.push(e),this.messageTimestamps.length>this.FLOOD_THRESHOLD}activateThrottle(){if(this.isThrottled)return;if(this.isThrottled=!0,this.setAttribute("throttled",""),!this.inputField||!this.sendButton)return;this.inputField.disabled=!0,this.sendButton.disabled=!0;const e=this.inputField.placeholder;let t=Math.ceil(this.THROTTLE_DURATION/1e3);this.inputField.placeholder=`⏳ Espera ${t}s para enviar más mensajes...`;const n=setInterval((()=>{t--,t>0&&this.inputField&&(this.inputField.placeholder=`⏳ Espera ${t}s para enviar más mensajes...`)}),1e3);this.throttleTimeout=window.setTimeout((()=>{clearInterval(n),this.deactivateThrottle(e)}),this.THROTTLE_DURATION)}deactivateThrottle(e="Escribe un mensaje..."){this.isThrottled=!1,this.messageTimestamps=[],this.removeAttribute("throttled"),this.throttleTimeout&&(clearTimeout(this.throttleTimeout),this.throttleTimeout=null),this.inputField&&this.sendButton&&(this.inputField.disabled=!1,this.inputField.placeholder=e,this.inputField.focus())}getValue(){return this.inputField?.value.trim()||""}setValue(e){this.inputField&&(this.inputField.value=e,this.handleInputChange())}clear(){this.inputField&&(this.inputField.value="",this.inputField.style.height="auto",this.handleInputChange())}focus(){this.inputField?.focus()}setSelectorActive(e){this.selectorButton||(this.selectorButton=this.querySelector(".selector-btn")),this.selectorButton&&(e?(this.selectorButton.classList.add("active"),this.selectorButton.setAttribute("aria-pressed","true")):(this.selectorButton.classList.remove("active"),this.selectorButton.setAttribute("aria-pressed","false")))}escapeHTML(e){return Ce(e)}initializeSpeechRecognition(){const e=new mn;this.speechService=new vn(e);const t=this.speechService.checkSupport();this.isSpeechSupported=t.isSupported,t.isSupported&&this.setupSpeechCallbacks()}setupSpeechCallbacks(){this.speechService&&(this.speechService.onTranscription(((e,t)=>{this.inputField&&(this.inputField.value=e,this.handleInputChange())})),this.speechService.onError((e=>{this.updateMicrophoneButtonState("error"),this.showTemporaryMessage(e.message,"error"),setTimeout((()=>{this.updateMicrophoneButtonState("idle")}),3e3)})),this.speechService.onStateChange((e=>{e===un.LISTENING?(this.updateMicrophoneButtonState("listening"),this.isListening=!0):e===un.IDLE&&(this.updateMicrophoneButtonState("idle"),this.isListening=!1)})),this.speechService.onEnd((()=>{this.updateMicrophoneButtonState("idle"),this.isListening=!1})),this.speechService.onUnavailable((()=>{this.hideMicrophoneButton()})))}handleMicrophoneClick(e){e.stopPropagation(),this.speechService&&(this.isListening?(this.speechService.stopListening(),this.updateMicrophoneButtonState("idle"),this.isListening=!1):this.speechService.startListening({language:"es-ES",continuous:!1,interimResults:!0,maxAlternatives:1}))}updateMicrophoneButtonState(e){this.microphoneButton&&(this.microphoneButton.classList.remove("mic-idle","mic-listening","mic-error"),this.microphoneButton.classList.add(`mic-${e}`),"listening"===e?(this.microphoneButton.innerHTML=wn.MICROPHONE_LISTENING,this.microphoneButton.title="Detener reconocimiento de voz",this.microphoneButton.setAttribute("aria-label","Detener reconocimiento de voz")):(this.microphoneButton.innerHTML=wn.MICROPHONE,this.microphoneButton.title="Reconocimiento de voz",this.microphoneButton.setAttribute("aria-label","Activar reconocimiento de voz")))}hideMicrophoneButton(){this.microphoneButton&&(this.microphoneButton.style.display="none")}showTemporaryMessage(e,t){const n=document.createElement("div");n.className=`chat-input-notification notification-${t}`,n.textContent=e,n.setAttribute("role","alert"),n.setAttribute("aria-live","polite"),this.insertBefore(n,this.form),setTimeout((()=>{n.parentNode&&n.remove()}),5e3)}}Ee("chat-input",xn);const En="<svg class=\"chat-icon-open\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"25\" height=\"25\" viewBox=\"-2 -2 18.11 23.85\"><defs><style> .cls-1 { fill: url(#Degradado_sin_nombre_82); } .cls-1, .cls-2 { stroke-width: 0px; } .cls-2 { fill: url(#Degradado_sin_nombre_82-2); } </style><linearGradient id='Degradado_sin_nombre_82' data-name='Degradado sin nombre 82' x1='-1.78' y1='16.81' x2='9.92' y2='1.35' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='#00beff'/><stop offset='.02' stop-color='#03b4fe'/><stop offset='.12' stop-color='#108bfa'/><stop offset='.22' stop-color='#1b6bf8'/><stop offset='.32' stop-color='#2254f6'/><stop offset='.41' stop-color='#2746f5'/><stop offset='.49' stop-color='#2942f5'/><stop offset='.56' stop-color='#2f3ef5'/><stop offset='.66' stop-color='#4235f6'/><stop offset='.77' stop-color='#6126f9'/><stop offset='.9' stop-color='#8c11fc'/><stop offset='1' stop-color='#b100ff'/><animateTransform attributeName='gradientTransform' type='rotate' values='0 6 9; 360 6 9' dur='3s' repeatCount='indefinite' begin='1s'/><animate attributeName='x1' values='-1.78; 5; -1.78' dur='2s' repeatCount='indefinite' begin='1s'/><animate attributeName='x2' values='9.92; 15; 9.92' dur='2s' repeatCount='indefinite' begin='1s'/></linearGradient><linearGradient id='Degradado_sin_nombre_82-2' data-name='Degradado sin nombre 82' x1='3.81' y1='21.04' x2='15.52' y2='5.59' xlink:href='#Degradado_sin_nombre_82'/></defs>\x3c!-- Forma superior con animación --\x3e<path class='cls-1' d='M11.88,2.94l.22.22.22.22v3.59h-5.73l-3.59-2.91v-1.11h8.89M12.85.6H.66v4.66l5.19,4.02h7.6c.47-.47.73-.73,1.2-1.2V2.4c-.7-.7-1.1-1.1-1.8-1.8h0Z'><animateTransform attributeName='transform' type='translate' values='-2,0; 0,0' dur='1s' fill='freeze' calcMode='spline' keySplines='0.25 0.1 0.25 1' keyTimes='0;1'/><animate attributeName='opacity' values='1; 0.8; 1' dur='2s' repeatCount='indefinite'/></path>\x3c!-- Forma inferior con animación --\x3e<path class='cls-2' d='M12.31,12.85v3.59l-.22.22-.22.22H2.99v-1.11l3.59-2.91h5.73M13.45,10.52h-7.6L.66,14.54v4.66h12.18c.7-.7,1.1-1.1,1.8-1.8v-5.69c-.47-.47-.73-.73-1.2-1.2h0Z'><animateTransform attributeName='transform' type='translate' values='2,0; 0,0' dur='1s' fill='freeze' calcMode='spline' keySplines='0.25 0.1 0.25 1' keyTimes='0;1'/><animate attributeName='opacity' values='1; 0.8; 1' dur='2s' repeatCount='indefinite' begin='0.6s'/></path></svg>",Sn='<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>';class Cn extends HTMLElement{constructor(){super(),r(this,"buttonElement",null),r(this,"badgeElement",null),r(this,"iconWrapper",null),r(this,"transitionEndHandler",null),r(this,"animationEndHandler",null),r(this,"isAnimating",!1),r(this,"pendingIconState",null),r(this,"handleClick",(e=>{e.preventDefault(),e.stopPropagation(),this.dispatchEvent(new CustomEvent("button-click",{bubbles:!0,cancelable:!0,composed:!0}))}))}static get observedAttributes(){return["hidden","badge-count","aria-label","is-open"]}connectedCallback(){this.render(),this.attachEventListeners()}disconnectedCallback(){this.removeEventListeners(),this.removeAnimationListeners(),this.isAnimating=!1,this.pendingIconState=null}attributeChangedCallback(e,t,n){if(t!==n)switch(e){case"hidden":this.updateVisibility();break;case"badge-count":this.updateBadge();break;case"aria-label":this.updateAriaLabel();break;case"is-open":this.buttonElement&&this.updateIcon()}}render(){const e=Se(this.getAttribute("hidden"),!1),t=this.getAttribute("badge-count"),n=this.getAttribute("aria-label")||"Abrir chat",i=this.hasAttribute("is-open");this.removeAnimationListeners();const s=document.createElement("button");s.className="chat-widget-button",s.setAttribute("type","button"),s.setAttribute("aria-label",n),e&&s.classList.add("hidden");const o=document.createElement("div");if(o.className="icon-wrapper",o.innerHTML=i?Sn:En,s.appendChild(o),t&&parseInt(t)>0){const e=document.createElement("span");e.className="notification-badge",e.textContent=t,e.style.display="flex",s.appendChild(e),this.badgeElement=e}this.innerHTML="",this.appendChild(s),this.buttonElement=s,this.iconWrapper=null}attachEventListeners(){this.buttonElement&&this.buttonElement.addEventListener("click",this.handleClick)}removeEventListeners(){this.buttonElement&&this.buttonElement.removeEventListener("click",this.handleClick)}updateVisibility(){if(!this.buttonElement)return;Se(this.getAttribute("hidden"),!1)?this.buttonElement.classList.add("hidden"):this.buttonElement.classList.remove("hidden")}updateBadge(){if(!this.buttonElement)return;const e=this.getAttribute("badge-count"),t=e?parseInt(e):0;if(t>0)if(this.badgeElement)this.badgeElement.textContent=t.toString(),this.badgeElement.style.display="flex";else{const e=document.createElement("span");e.className="notification-badge",e.textContent=t.toString(),e.style.display="flex",this.buttonElement.appendChild(e),this.badgeElement=e}else this.badgeElement&&(this.badgeElement.style.display="none")}updateAriaLabel(){if(this.buttonElement){const e=this.getAttribute("aria-label")||"Abrir chat";this.buttonElement.setAttribute("aria-label",e)}}updateIcon(){if(!this.buttonElement)return;const e=this.hasAttribute("is-open");if(this.isAnimating)return void(this.pendingIconState=e);let t=this.iconWrapper;if(!t){if(t=this.buttonElement.querySelector(".icon-wrapper"),!t){t=document.createElement("div"),t.className="icon-wrapper";const n=this.buttonElement.querySelector("svg");Array.from(this.buttonElement.childNodes).forEach((e=>{e!==this.badgeElement&&e.remove()})),n?t.appendChild(n.cloneNode(!0)):t.innerHTML=e?Sn:En,this.badgeElement?this.buttonElement.insertBefore(t,this.badgeElement):this.buttonElement.appendChild(t)}this.iconWrapper=t}this.isAnimating=!0,this.transitionEndHandler=e=>{if(e.target!==t||!t.classList.contains("icon-exit")||"transform"!==e.propertyName)return;if(!this.isConnected||!t||!this.buttonElement)return void(this.isAnimating=!1);const n=this.hasAttribute("is-open");t.innerHTML=n?Sn:En,t.classList.remove("icon-exit"),t.classList.add("icon-enter")},this.animationEndHandler=e=>{if(e.target===t&&t.classList.contains("icon-enter")&&"iconEnter"===e.animationName)if(this.isConnected&&t){if(t.classList.remove("icon-enter"),this.removeAnimationListeners(),this.isAnimating=!1,null!==this.pendingIconState){const e=this.pendingIconState;this.pendingIconState=null;e!==this.hasAttribute("is-open")?e?this.setAttribute("is-open",""):this.removeAttribute("is-open"):requestAnimationFrame((()=>this.updateIcon()))}}else this.isAnimating=!1},t.addEventListener("transitionend",this.transitionEndHandler),t.addEventListener("animationend",this.animationEndHandler),requestAnimationFrame((()=>{t&&this.isConnected?t.classList.add("icon-exit"):this.isAnimating=!1}))}removeAnimationListeners(){this.iconWrapper&&(this.transitionEndHandler&&(this.iconWrapper.removeEventListener("transitionend",this.transitionEndHandler),this.transitionEndHandler=null),this.animationEndHandler&&(this.iconWrapper.removeEventListener("animationend",this.animationEndHandler),this.animationEndHandler=null))}show(){this.removeAttribute("hidden")}hide(){this.setAttribute("hidden","")}setBadgeCount(e){e&&e>0?this.setAttribute("badge-count",e.toString()):this.removeAttribute("badge-count")}getBadgeCount(){const e=this.getAttribute("badge-count");return e?parseInt(e):0}}Ee("chat-widget-button",Cn);class Tn extends HTMLElement{constructor(){super(),r(this,"shadow"),r(this,"darkModeObserver",null),this.shadow=this.attachShadow({mode:"open"})}static get observedAttributes(){return["tag","selector","text"]}connectedCallback(){this.render(),this.observeDarkMode()}disconnectedCallback(){this.darkModeObserver&&(this.darkModeObserver.disconnect(),this.darkModeObserver=null)}attributeChangedCallback(){this.isConnected&&this.render()}checkDarkMode(){if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector(".selected-element-container");if(!e)return;this.closest(".dark-mode")||document.querySelector(".dark-mode")?e.classList.add("dark-mode"):e.classList.remove("dark-mode")}observeDarkMode(){this.darkModeObserver=new MutationObserver((()=>{this.checkDarkMode()}));const e=document.querySelector(".chat-widget-container");e&&this.darkModeObserver.observe(e,{attributes:!0,attributeFilter:["class"]}),this.checkDarkMode()}render(){if(!this.shadowRoot)return;const e=this.getAttribute("tag")||"",t=this.getAttribute("selector")||"",n=this.getAttribute("text")||"";if(!e&&!t)return;const i=Ce(e),s=Ce(t),o=Ce(n);this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: flex;\n          align-self: flex-end;\n          max-width: 80%;\n          min-width: 0;\n        }\n        .selected-element-container {\n          display: inline-flex;\n          align-items: center;\n          gap: 8px;\n          padding: 10px 14px;\n          background-color: var(--chat-user-message-bg, #FEF3C7);\n          color: var(--chat-primary-color, #111827);\n          border-radius: 18px;\n          border-bottom-right-radius: 4px;\n          font-family: var(--chat-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif);\n          font-size: 0.85rem;\n          line-height: 1.4;\n          word-break: break-word;\n          overflow-wrap: break-word;\n          font-weight: 400;\n          position: relative;\n          margin-right: 0px;\n          width: 100%;\n          max-width: 100%;\n          box-sizing: border-box;\n          overflow: hidden;\n        }\n        .selected-element-container.dark-mode {\n          background-color: var(--chat-user-message-bg, #FEF3C7);\n          color: #F3F4F6;\n        }\n        .icon-container {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          flex-shrink: 0;\n          width: 20px;\n          height: 20px;\n          background: var(--chat-accent-color, #4F46E5);\n          border-radius: 50%;\n          padding: 2px;\n        }\n        .selected-element-container.dark-mode .icon-container {\n          background: var(--chat-accent-color, #6366F1);\n        }\n        .icon-container svg {\n          width: 12px;\n          height: 12px;\n          color: white;\n        }\n        .content {\n          display: flex;\n          flex-direction: column;\n          gap: 4px;\n          flex: 1;\n          min-width: 0;\n        }\n        .tag-selector {\n          display: flex;\n          align-items: center;\n          gap: 6px;\n          font-weight: 400;\n          font-size: 0.85rem;\n          flex-wrap: wrap;\n          min-width: 0;\n          max-width: 100%;\n        }\n        .tag {\n          background: var(--chat-background, #FFFFFF);\n          color: var(--chat-text-color, #1F2937);\n          padding: 2px 6px;\n          border-radius: 4px;\n          font-family: 'Courier New', monospace;\n          font-size: 0.7rem;\n          white-space: nowrap;\n          border: 1px solid var(--chat-border-color, #E5E7EB);\n        }\n        .selected-element-container.dark-mode .tag {\n          background: var(--chat-background, #1F2937);\n          color: var(--chat-text-color, #E5E7EB);\n          border-color: var(--chat-border-color, #374151);\n        }\n        .selector {\n          font-family: 'Courier New', monospace;\n          font-size: 0.75rem;\n          color: var(--chat-text-secondary-color, #6B7280);\n          word-break: break-word;\n          overflow-wrap: break-word;\n          max-width: 100%;\n        }\n        .selected-element-container.dark-mode .selector {\n          color: var(--chat-text-secondary-color, #9CA3AF);\n        }\n        .text {\n          font-size: 0.75rem;\n          color: var(--chat-text-secondary-color, #6B7280);\n          white-space: nowrap;\n          overflow: hidden;\n          text-overflow: ellipsis;\n          max-width: 100%;\n          min-width: 0;\n        }\n        .selected-element-container.dark-mode .text {\n          color: var(--chat-text-secondary-color, #9CA3AF);\n        }\n        .separator {\n          margin: 0 4px;\n          color: var(--chat-text-secondary-color, #6B7280);\n          opacity: 0.6;\n        }\n        .selected-element-container.dark-mode .separator {\n          color: var(--chat-text-secondary-color, #9CA3AF);\n        }\n      </style>\n      <div class="selected-element-container">\n        <div class="icon-container">\n          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n      <circle cx="12" cy="12" r="10"></circle>\n      <path d="M9 12l2 2 4-4"></path>\n    </svg>\n        </div>\n        <div class="content">\n          <div class="tag-selector">\n            ${i?`<span class="tag">${i}</span>`:""}\n            ${i&&s?'<span class="separator">•</span>':""}\n            ${s?`<span class="selector">${s}</span>`:""}\n          </div>\n          ${o?`<div class="text">${o}</div>`:""}\n        </div>\n      </div>\n    `,setTimeout((()=>this.checkDarkMode()),0)}updateElement(e,t,n=""){this.setAttribute("tag",e),this.setAttribute("selector",t),this.setAttribute("text",n)}}Ee("selected-element",Tn);class An extends HTMLElement{constructor(){super(),r(this,"typingTimeout",null),r(this,"hideTimeout",null),r(this,"hasRendered",!1),r(this,"isElementConnected",!1),r(this,"AUTO_HIDE_DELAY",5e3),r(this,"FADE_OUT_DURATION",300)}static get observedAttributes(){return["visible"]}connectedCallback(){this.isElementConnected=!0,this.hasRendered||this.render()}attributeChangedCallback(e,t,n){"visible"===e&&t!==n&&this.isElementConnected&&this.updateVisibilityFromAttribute()}show(){this.isElementConnected&&(this.clearTimeouts(),this.setAttribute("visible",""),this.applyVisibleStyles(),this.typingTimeout=window.setTimeout((()=>{this.hide()}),this.AUTO_HIDE_DELAY))}hide(){this.isElementConnected&&(this.clearTimeouts(),this.removeAttribute("visible"),this.applyHiddenStyles(),this.hideTimeout=window.setTimeout((()=>{this.hasAttribute("visible")||(this.style.display="none")}),this.FADE_OUT_DURATION))}isVisible(){return this.hasAttribute("visible")&&"none"!==this.style.display}updateVisibilityFromAttribute(){this.hasAttribute("visible")?this.applyVisibleStyles():(this.applyHiddenStyles(),this.hideTimeout=window.setTimeout((()=>{this.hasAttribute("visible")||(this.style.display="none")}),this.FADE_OUT_DURATION))}applyVisibleStyles(){this.style.display="flex",this.style.opacity="1"}applyHiddenStyles(){this.style.opacity="0"}clearTimeouts(){this.typingTimeout&&(clearTimeout(this.typingTimeout),this.typingTimeout=null),this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}render(){if(!this.hasRendered){if(this.hasRendered=!0,this.innerHTML='\n      <div class="typing-bubble">\n        <span class="typing-text">Typing</span>\n        <span class="typing-dots">\n          <span class="dot"></span>\n          <span class="dot"></span>\n          <span class="dot"></span>\n        </span>\n      </div>\n    ',!this.querySelector("style")){const e=document.createElement("style");e.textContent=this.getStyles(),this.appendChild(e)}this.style.position="absolute",this.style.bottom="60px",this.style.left="50%",this.style.transform="translateX(-50%)",this.style.zIndex="100",this.style.transition=`opacity ${this.FADE_OUT_DURATION}ms ease`,this.style.display="none",this.style.opacity="0"}}getStyles(){return"\n      .typing-bubble {\n        display: flex;\n        align-items: center;\n        padding: 8px 16px;\n        background-color: #e6f7e6;\n        border: 1px solid #c3e6cb;\n        border-radius: 18px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n        animation: typing-float 2s infinite ease-in-out;\n      }\n\n      .typing-text {\n        font-weight: var(--chat-font-weight-semibold, 600);\n        font-size: var(--chat-font-size-base, 14px);\n        color: #28a745;\n        margin-right: 8px;\n      }\n\n      .typing-dots {\n        display: inline-flex;\n        align-items: center;\n        gap: 2px;\n      }\n\n      .typing-dots .dot {\n        display: inline-block;\n        width: 6px;\n        height: 6px;\n        border-radius: 50%;\n        background-color: #28a745;\n        opacity: 0.8;\n      }\n\n      .typing-dots .dot:nth-child(1) {\n        animation: typing-bounce 1.3s infinite 0.2s;\n      }\n\n      .typing-dots .dot:nth-child(2) {\n        animation: typing-bounce 1.3s infinite 0.4s;\n      }\n\n      .typing-dots .dot:nth-child(3) {\n        animation: typing-bounce 1.3s infinite 0.6s;\n      }\n\n      @keyframes typing-bounce {\n        0%, 100% {\n          transform: translateY(0);\n        }\n        30% {\n          transform: translateY(-4px);\n        }\n      }\n\n      @keyframes typing-float {\n        0%, 100% {\n          transform: translateY(0);\n        }\n        50% {\n          transform: translateY(-5px);\n        }\n      }\n    "}disconnectedCallback(){this.isElementConnected=!1,this.clearTimeouts()}}Ee("typing-indicator",An);class Mn{constructor(e){r(this,"isActive",!1),r(this,"overlay",null),r(this,"infoBox",null),r(this,"highlightedElement",null),r(this,"onSelectCallback",null),r(this,"IGNORED_CLASSES",["chat-widget-container","chat-widget-button","element-selector-overlay","element-selector-info"]),this.onSelectCallback=e||null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleClick=this.handleClick.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}activate(){this.isActive||(this.isActive=!0,this.createOverlay(),this.attachEventListeners(),document.body.style.cursor="crosshair")}deactivate(){this.isActive&&(this.isActive=!1,this.removeOverlay(),this.removeEventListeners(),document.body.style.cursor="")}get active(){return this.isActive}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="element-selector-overlay",this.overlay.style.cssText="\n      position: fixed;\n      pointer-events: none;\n      border: 2px solid #4CAF50;\n      background-color: rgba(76, 175, 80, 0.1);\n      z-index: 999999;\n      transition: all 0.1s ease;\n    ",document.body.appendChild(this.overlay),this.infoBox=document.createElement("div"),this.infoBox.className="element-selector-info",this.infoBox.style.cssText="\n      position: fixed;\n      background: #2c3e50;\n      color: white;\n      padding: 8px 12px;\n      border-radius: 4px;\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      z-index: 1000000;\n      pointer-events: none;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      max-width: 300px;\n      word-break: break-all;\n    ",document.body.appendChild(this.infoBox)}removeOverlay(){this.overlay&&(this.overlay.remove(),this.overlay=null),this.infoBox&&(this.infoBox.remove(),this.infoBox=null)}attachEventListeners(){document.addEventListener("mousemove",this.handleMouseMove,!0),document.addEventListener("click",this.handleClick,!0),document.addEventListener("keydown",this.handleKeyDown,!0)}removeEventListeners(){document.removeEventListener("mousemove",this.handleMouseMove,!0),document.removeEventListener("click",this.handleClick,!0),document.removeEventListener("keydown",this.handleKeyDown,!0)}handleMouseMove(e){if(!this.isActive)return;const t=this.getElementFromPoint(e.clientX,e.clientY);t&&!this.shouldIgnoreElement(t)?(this.highlightedElement=t,this.updateOverlay(t),this.updateInfoBox(t,e.clientX,e.clientY)):this.hideOverlay()}handleClick(e){if(!this.isActive)return;e.preventDefault(),e.stopPropagation();const t=this.getElementFromPoint(e.clientX,e.clientY);if(!t||this.shouldIgnoreElement(t))return;const n=this.getElementInfo(t);this.onSelectCallback&&this.onSelectCallback(n),this.deactivate()}handleKeyDown(e){"Escape"===e.key&&this.deactivate()}getElementFromPoint(e,t){this.overlay&&(this.overlay.style.display="none"),this.infoBox&&(this.infoBox.style.display="none");const n=document.elementFromPoint(e,t);return this.overlay&&(this.overlay.style.display="block"),this.infoBox&&(this.infoBox.style.display="block"),n}shouldIgnoreElement(e){return this.IGNORED_CLASSES.some((t=>e.classList.contains(t)||e.closest(`.${t}`)))}updateOverlay(e){if(!this.overlay)return;const t=e.getBoundingClientRect();this.overlay.style.top=`${t.top}px`,this.overlay.style.left=`${t.left}px`,this.overlay.style.width=`${t.width}px`,this.overlay.style.height=`${t.height}px`,this.overlay.style.display="block"}hideOverlay(){this.overlay&&(this.overlay.style.display="none"),this.infoBox&&(this.infoBox.style.display="none")}updateInfoBox(e,t,n){if(!this.infoBox)return;let i=`<strong>${e.tagName.toLowerCase()}${e.id?`#${e.id}`:""}${Array.from(e.classList).map((e=>`.${e}`)).join("")}</strong>`;const s=e.textContent?.trim().substring(0,50);s&&(i+=`<br/><small>${s}${s.length>=50?"...":""}</small>`),this.infoBox.innerHTML=i;let o=t+15,r=n+15;const a=this.infoBox.getBoundingClientRect();o+a.width>window.innerWidth&&(o=t-a.width-15),r+a.height>window.innerHeight&&(r=n-a.height-15),this.infoBox.style.left=`${o}px`,this.infoBox.style.top=`${r}px`,this.infoBox.style.display="block"}getElementInfo(e){const t=e.tagName.toLowerCase(),n=e.id||"",i=Array.from(e.classList),s=e.textContent?.trim()||"",o={};Array.from(e.attributes).forEach((e=>{o[e.name]=e.value}));let r=t;n?r+=`#${n}`:i.length>0&&(r+=i.map((e=>`.${e}`)).join(""));const a=this.getXPath(e);return{tagName:t,id:n,classes:i,text:s.substring(0,200),attributes:o,xpath:a,selector:r}}getXPath(e){if(e.id)return`//*[@id="${e.id}"]`;const t=[];let n=e;for(;n&&n.nodeType===Node.ELEMENT_NODE;){let e=0,i=n;for(;i;)i=i.previousElementSibling,i&&i.nodeName===n.nodeName&&e++;const s=n.nodeName.toLowerCase(),o=e>0?`[${e+1}]`:"";t.unshift(`${s}${o}`),n=n.parentElement}return t.length?`/${t.join("/")}`:""}destroy(){this.deactivate(),this.onSelectCallback=null}}const Rn={primary:"#111827",secondary:"#4B5563",text:"#1F2937",textSecondary:"#6B7280",background:"#FFFFFF",backgroundChat:"#F9FAFB",userMessageBg:"#FEF3C7",userMessageText:"#92400E",agentMessageBg:"#F3F4F6",agentMessageText:"#1F2937",border:"#E5E7EB",hover:"#D1D5DB",accent:"#4F46E5",timestamp:"#9CA3AF",icon:"#6B7280",sendButton:"#4F46E5",sendButtonHover:"#ffffff",inputBackground:"#FFFFFF",inputPlaceholder:"#9CA3AF"},Bn={xsmall:"11px",small:"13px",base:"14px",large:"16px",header:"16px"},_n={regular:400,medium:500,semibold:600,bold:700},Ln={fontFamily:'"Rubik", sans-serif',fontUrl:void 0,fontSize:Bn,fontWeight:_n,lineHeight:"1.5"},On={borderRadius:"16px",messageBorderRadius:"12px",buttonBorderRadius:"50%",containerPadding:"16px",messagePadding:"12px 16px",messageGap:"12px"},In={small:"0 1px 2px rgba(0, 0, 0, 0.05)",medium:"0 4px 12px rgba(0, 0, 0, 0.1)",large:"0 4px 20px rgba(0, 0, 0, 0.1)"},Fn={name:"default",mode:"light",inheritSystemTheme:!1};class Nn{constructor(e={}){r(this,"colors"),r(this,"typography"),r(this,"spacing"),r(this,"shadows"),r(this,"options"),r(this,"_cssVariablesCache",null),r(this,"_cssVariablesHash",null),this.colors={...Rn,...e.colors||{}},this.typography={...Ln,fontSize:{...Bn,...e.typography?.fontSize||{}},fontWeight:{..._n,...e.typography?.fontWeight||{}},fontFamily:e.typography?.fontFamily||Ln.fontFamily,fontUrl:e.typography?.fontUrl,lineHeight:e.typography?.lineHeight||Ln.lineHeight},this.spacing={...On,...e.spacing||{}},this.shadows={...In,...e.shadows||{}},this.options={...Fn,...e.options||{}},this.validate()}isValidColor(e){if(/^#[0-9A-Fa-f]{3}$|^#[0-9A-Fa-f]{6}$|^#[0-9A-Fa-f]{8}$/.test(e))return!0;const t=e.match(/^rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([\d.]+))?\s*\)$/);if(t){const e=parseInt(t[1],10),n=parseInt(t[2],10),i=parseInt(t[3],10),s=t[4]?parseFloat(t[4]):1;return e>=0&&e<=255&&n>=0&&n<=255&&i>=0&&i<=255&&s>=0&&s<=1}const n=e.match(/^hsla?\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%(?:\s*,\s*([\d.]+))?\s*\)$/);if(n){const e=parseInt(n[1],10),t=parseInt(n[2],10),i=parseInt(n[3],10),s=n[4]?parseFloat(n[4]):1;return e>=0&&e<=360&&t>=0&&t<=100&&i>=0&&i<=100&&s>=0&&s<=1}return!!["transparent","currentColor","inherit","initial","unset","black","white","red","green","blue","yellow","cyan","magenta"].includes(e.toLowerCase())}validate(){for(const[t,n]of Object.entries(this.colors))if(!this.isValidColor(n))throw new Error(`Color inválido para ${t}: ${n}. Debe ser un formato válido (hex, rgb, rgba, hsl, hsla o nombre CSS).`);const e=/^\d+(\.\d+)?(px|rem|em|%)$/;for(const[t,n]of Object.entries(this.typography.fontSize))if(!e.test(n))throw new Error(`Tamaño de fuente inválido para ${t}: ${n}. Debe incluir una unidad (px, rem, em o %).`);for(const[t,n]of Object.entries(this.typography.fontWeight))if(n<100||n>900||n%100!=0)throw new Error(`Peso de fuente inválido para ${t}: ${n}. Debe ser entre 100 y 900 en múltiplos de 100.`)}merge(e){const t={colors:{...this.colors,...e.colors||{}},typography:{fontFamily:e.typography?.fontFamily||this.typography.fontFamily,fontUrl:void 0!==e.typography?.fontUrl?e.typography.fontUrl:this.typography.fontUrl,lineHeight:e.typography?.lineHeight||this.typography.lineHeight,fontSize:{...this.typography.fontSize,...e.typography?.fontSize||{}},fontWeight:{...this.typography.fontWeight,...e.typography?.fontWeight||{}}},spacing:{...this.spacing,...e.spacing||{}},shadows:{...this.shadows,...e.shadows||{}},options:{...this.options,...e.options||{}}};return new Nn(t)}generateThemeHash(){return JSON.stringify({colors:this.colors,typography:{fontFamily:this.typography.fontFamily,fontSize:this.typography.fontSize,fontWeight:this.typography.fontWeight,lineHeight:this.typography.lineHeight},spacing:this.spacing,shadows:this.shadows})}toCSSVariables(){const e=this.generateThemeHash();if(this._cssVariablesCache&&this._cssVariablesHash===e)return this._cssVariablesCache;const t={"--chat-primary-color":this.colors.primary,"--chat-secondary-color":this.colors.secondary,"--chat-text-color":this.colors.text,"--chat-text-secondary-color":this.colors.textSecondary,"--chat-background":this.colors.background,"--chat-background-chat":this.colors.backgroundChat,"--chat-white":this.colors.background,"--chat-user-message-bg":this.colors.userMessageBg,"--chat-user-message-text":this.colors.userMessageText,"--chat-agent-message-bg":this.colors.agentMessageBg,"--chat-agent-message-text":this.colors.agentMessageText,"--chat-border-color":this.colors.border,"--chat-hover-color":this.colors.hover,"--chat-accent-color":this.colors.accent,"--chat-time-color":this.colors.timestamp,"--chat-icon-color":this.colors.icon,"--chat-send-button":this.colors.sendButton,"--chat-send-button-hover":this.colors.sendButtonHover,"--chat-input-background":this.colors.inputBackground,"--chat-input-placeholder":this.colors.inputPlaceholder,"--chat-font-family":this.typography.fontFamily,"--chat-line-height":this.typography.lineHeight,"--chat-border-radius":this.spacing.borderRadius,"--chat-message-border-radius":this.spacing.messageBorderRadius,"--chat-button-border-radius":this.spacing.buttonBorderRadius,"--chat-container-padding":this.spacing.containerPadding,"--chat-message-padding":this.spacing.messagePadding,"--chat-message-gap":this.spacing.messageGap,"--chat-shadow-sm":this.shadows.small,"--chat-shadow-md":this.shadows.medium,"--chat-shadow-lg":this.shadows.large};return this.typography.fontSize.xsmall&&(t["--chat-font-size-xsmall"]=this.typography.fontSize.xsmall),this.typography.fontSize.small&&(t["--chat-font-size-small"]=this.typography.fontSize.small),this.typography.fontSize.base&&(t["--chat-font-size-base"]=this.typography.fontSize.base),this.typography.fontSize.large&&(t["--chat-font-size-large"]=this.typography.fontSize.large),this.typography.fontSize.header&&(t["--chat-font-size-header"]=this.typography.fontSize.header),this.typography.fontWeight.regular&&(t["--chat-font-weight-regular"]=String(this.typography.fontWeight.regular)),this.typography.fontWeight.medium&&(t["--chat-font-weight-medium"]=String(this.typography.fontWeight.medium)),this.typography.fontWeight.semibold&&(t["--chat-font-weight-semibold"]=String(this.typography.fontWeight.semibold)),this.typography.fontWeight.bold&&(t["--chat-font-weight-bold"]=String(this.typography.fontWeight.bold)),this._cssVariablesHash=e,this._cssVariablesCache=t,t}clone(){return new Nn({colors:{...this.colors},typography:{fontFamily:this.typography.fontFamily,fontUrl:this.typography.fontUrl,lineHeight:this.typography.lineHeight,fontSize:{...this.typography.fontSize},fontWeight:{...this.typography.fontWeight}},spacing:{...this.spacing},shadows:{...this.shadows},options:{...this.options}})}toJSON(){return{colors:{...this.colors},typography:{fontFamily:this.typography.fontFamily,fontUrl:this.typography.fontUrl,lineHeight:this.typography.lineHeight,fontSize:{...this.typography.fontSize},fontWeight:{...this.typography.fontWeight}},spacing:{...this.spacing},shadows:{...this.shadows},options:{...this.options}}}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;return new Nn(t)}}const jn=class e{constructor(){r(this,"currentTheme",null),r(this,"presets",new Map),r(this,"appliedElements",new WeakMap),Be.debug("ThemeManager","Instancia de ThemeManager creada")}static getInstance(){return e.instance||(e.instance=new e),e.instance}async applyTheme(e,t){const n=t||document.documentElement;if(t&&"undefined"!=typeof document&&!document.contains(t)){const e="Target element is not in the DOM";throw Be.warn("ThemeManager:applyTheme",e,{element:t}),new Error(e)}const i=e.toCSSVariables();if(Be.debug("ThemeManager:applyTheme",`Aplicando tema "${e.options.name}"`,{target:t?"custom element":"document root",variablesCount:Object.keys(i).length,hasFontUrl:!!e.typography.fontUrl}),e.typography.fontUrl)try{Be.info("ThemeManager:applyTheme",`Cargando fuente: ${e.typography.fontUrl}`),await je(e.typography.fontUrl)}catch(r){Be.debug("ThemeManager:applyTheme","Continuando sin la fuente personalizada")}const s=new Map,o=this.appliedElements.get(n);try{for(const e of Object.keys(i)){const t=n.style.getPropertyValue(e);s.set(e,t)}const o=Object.entries(i);await new Promise(((e,i)=>{requestAnimationFrame((()=>{try{if(t&&"undefined"!=typeof document&&!document.contains(t))throw new Error("Target element was removed from DOM during theme application");for(const[e,t]of o)n.style.setProperty(e,t);e()}catch(r){i(r)}}))})),this.appliedElements.set(n,e),t||(this.currentTheme=e),Be.info("ThemeManager:applyTheme",`Tema "${e.options.name}" aplicado correctamente`)}catch(r){Be.error("ThemeManager:applyTheme","Error durante aplicación del tema, realizando rollback",r);try{for(const[e,t]of s.entries())t?n.style.setProperty(e,t):n.style.removeProperty(e);o?this.appliedElements.set(n,o):this.appliedElements.delete(n),!t&&o?this.currentTheme=o:t||(this.currentTheme=null),Be.info("ThemeManager:applyTheme","Rollback completado correctamente")}catch(a){Be.error("ThemeManager:applyTheme","Error durante rollback",a)}throw r}}getCurrentTheme(){return this.currentTheme}getThemeForElement(e){return this.appliedElements.get(e)||null}registerPreset(e,t){Be.debug("ThemeManager:registerPreset",`Registrando preset "${e}"`),this.presets.set(e.toLowerCase(),t)}getPreset(e){const t=this.presets.get(e.toLowerCase());return t?t.clone():(Be.warn("ThemeManager:getPreset",`Preset "${e}" no encontrado`),null)}getAvailablePresets(){return Array.from(this.presets.keys())}hasPreset(e){return this.presets.has(e.toLowerCase())}unregisterPreset(e){const t=this.presets.delete(e.toLowerCase());return t&&Be.debug("ThemeManager:unregisterPreset",`Preset "${e}" eliminado`),t}reset(e){const t=e||document.documentElement;Be.debug("ThemeManager:reset","Restaurando tema por defecto");const n=e?this.appliedElements.get(t):this.currentTheme;if(n){const e=n.toCSSVariables();for(const n of Object.keys(e))t.style.removeProperty(n)}this.appliedElements.delete(t),e||(this.currentTheme=null),Be.info("ThemeManager:reset","Tema restaurado correctamente")}createTheme(e){if("string"==typeof e){const t=this.getPreset(e);if(!t)throw new Error(`El preset "${e}" no existe`);return t}return new Nn(e)}async applyThemeFromConfig(e,t){const n=this.createTheme(e);await this.applyTheme(n,t)}static resetInstance(){e.instance=null}};r(jn,"instance",null);let Dn=jn;function Hn(){return Dn.getInstance()}class Pn{constructor(){r(this,"config",{})}setColors(e){return this.config.colors={...this.config.colors,...e},this}setColor(e,t){return this.config.colors||(this.config.colors={}),this.config.colors[e]=t,this}setTypography(e){return this.config.typography={...this.config.typography,...e,fontSize:{...this.config.typography?.fontSize,...e.fontSize},fontWeight:{...this.config.typography?.fontWeight,...e.fontWeight}},this}setFontFamily(e){return this.config.typography||(this.config.typography={}),this.config.typography.fontFamily=e,this}setFontSizes(e){return this.config.typography||(this.config.typography={}),this.config.typography.fontSize={...this.config.typography.fontSize,...e},this}setFontWeights(e){return this.config.typography||(this.config.typography={}),this.config.typography.fontWeight={...this.config.typography.fontWeight,...e},this}setSpacing(e){return this.config.spacing={...this.config.spacing,...e},this}setShadows(e){return this.config.shadows={...this.config.shadows,...e},this}setOptions(e){return this.config.options={...this.config.options,...e},this}fromPreset(e){return this.config=e.toJSON(),this}fromConfig(e){return this.config={colors:{...this.config.colors,...e.colors},typography:{...this.config.typography,...e.typography,fontSize:{...this.config.typography?.fontSize,...e.typography?.fontSize},fontWeight:{...this.config.typography?.fontWeight,...e.typography?.fontWeight}},spacing:{...this.config.spacing,...e.spacing},shadows:{...this.config.shadows,...e.shadows},options:{...this.config.options,...e.options}},this}reset(){return this.config={},this}build(){return new Nn(this.config)}}const $n=(new Pn).setColors({primary:"#111827",secondary:"#4B5563",text:"#1F2937",textSecondary:"#6B7280",background:"#FFFFFF",backgroundChat:"#F9FAFB",userMessageBg:"#FEF3C7",userMessageText:"#92400E",agentMessageBg:"#F3F4F6",agentMessageText:"#1F2937",border:"#E5E7EB",hover:"#D1D5DB",accent:"#4F46E5",timestamp:"#9CA3AF",icon:"#6B7280",sendButton:"#4F46E5",sendButtonHover:"#ffffff",inputBackground:"#FFFFFF",inputPlaceholder:"#9CA3AF"}).setOptions({name:"light",mode:"light"}).build(),zn=(new Pn).setColors({primary:"#4F46E5",secondary:"#9CA3AF",text:"#E5E7EB",textSecondary:"#9CA3AF",background:"#1F2937",backgroundChat:"#111827",userMessageBg:"#4F46E5",userMessageText:"#FFFFFF",agentMessageBg:"#374151",agentMessageText:"#E5E7EB",border:"#374151",hover:"#4B5563",accent:"#6366F1",timestamp:"#9CA3AF",icon:"#9CA3AF",sendButton:"#4F46E5",sendButtonHover:"#6366F1",inputBackground:"#374151",inputPlaceholder:"#6B7280"}).setShadows({small:"0 1px 2px rgba(0, 0, 0, 0.3)",medium:"0 4px 12px rgba(0, 0, 0, 0.4)",large:"0 4px 20px rgba(0, 0, 0, 0.5)"}).setOptions({name:"dark",mode:"dark"}).build(),qn=(new Pn).fromPreset($n).setColors({primary:"#1F2937",secondary:"#6B7280",text:"#111827",userMessageBg:"#FEF3C7",userMessageText:"#92400E",agentMessageBg:"#F9FAFB",agentMessageText:"#1F2937",sendButton:"#1F2937",sendButtonHover:"#111827"}).setTypography({fontFamily:"'Playfair Display', serif",fontUrl:"https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"}).setOptions({name:"playfair",mode:"light"}).build(),Un=(new Pn).fromPreset($n).setColors({primary:"#0F172A",secondary:"#64748B",text:"#1E293B",userMessageBg:"#E0E7FF",userMessageText:"#ffffff",agentMessageBg:"#F1F5F9",agentMessageText:"#334155",sendButton:"#4F46E5",sendButtonHover:"#ffffff"}).setTypography({fontFamily:"'Open Sans', sans-serif",fontUrl:"https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"}).setOptions({name:"opensans",mode:"light"}).build(),Wn=(new Pn).fromPreset($n).setTypography({fontFamily:"'Segoe UI This', sans-serif"}).setOptions({name:"segoe-ui-this",mode:"light"}).build(),Vn=new Map([["light",$n],["dark",zn],["playfair",qn],["opensans",Un],["segoe-ui-this",Wn]]);class Qn{constructor(e){r(this,"messageQueue",[]),r(this,"userMessageQueue",[]),r(this,"isProcessingQueue",!1),r(this,"isProcessingUserQueue",!1),r(this,"MAX_QUEUE_SIZE",100),r(this,"callbacks"),this.callbacks=e}addMessage(e){e.isUser?(this.userMessageQueue.length>=this.MAX_QUEUE_SIZE&&this.userMessageQueue.shift(),this.userMessageQueue.push(e),this.processUserQueue()):(this.messageQueue.length>=this.MAX_QUEUE_SIZE&&this.messageQueue.shift(),this.messageQueue.push(e),this.processQueue())}async processUserQueue(){if(!this.isProcessingUserQueue){for(this.isProcessingUserQueue=!0;this.userMessageQueue.length>0;){const e=this.userMessageQueue.shift();e&&await this.callbacks.onRenderMessage(e,!0)}this.isProcessingUserQueue=!1}}async processQueue(){if(!this.isProcessingQueue){for(this.isProcessingQueue=!0;this.messageQueue.length>0;){const e=this.messageQueue.shift();e&&(await this.callbacks.onRenderMessage(e,!1),await new Promise((e=>setTimeout(e,100))))}this.isProcessingQueue=!1}}clear(){this.messageQueue=[],this.userMessageQueue=[],this.isProcessingQueue=!1,this.isProcessingUserQueue=!1}getTotalQueueSize(){return this.messageQueue.length+this.userMessageQueue.length}isProcessing(){return this.isProcessingQueue||this.isProcessingUserQueue}}class Jn{constructor(e,t){r(this,"chatService"),r(this,"callbacks"),r(this,"watchdogCanceler",null),r(this,"visibilityChangeHandler",null),r(this,"onlineHandler",null),r(this,"offlineHandler",null),this.chatService=e,this.callbacks=t,this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleOnline=this.handleOnline.bind(this),this.handleOffline=this.handleOffline.bind(this)}updateChatService(e){this.chatService=e}setupWatchdog(){this.cleanupWatchdog();const e=setInterval((()=>{this.chatService.verifyConnection&&this.chatService.verifyConnection().catch((()=>{Be.warn("ConnectionManager","Connection check failed, will retry...")}))}),3e4);this.watchdogCanceler=()=>{clearInterval(e),this.watchdogCanceler=null}}cleanupWatchdog(){this.watchdogCanceler&&(this.watchdogCanceler(),this.watchdogCanceler=null)}setupVisibilityListeners(){this.visibilityChangeHandler||(this.visibilityChangeHandler=this.handleVisibilityChange,document.addEventListener("visibilitychange",this.visibilityChangeHandler))}setupNetworkListeners(){this.onlineHandler||(this.onlineHandler=this.handleOnline,window.addEventListener("online",this.onlineHandler)),this.offlineHandler||(this.offlineHandler=this.handleOffline,window.addEventListener("offline",this.offlineHandler))}cleanup(){this.cleanupWatchdog(),this.cleanupVisibilityListeners(),this.cleanupNetworkListeners()}cleanupVisibilityListeners(){this.visibilityChangeHandler&&(document.removeEventListener("visibilitychange",this.visibilityChangeHandler),this.visibilityChangeHandler=null)}cleanupNetworkListeners(){this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null)}handleVisibilityChange(){"visible"===document.visibilityState&&this.chatService.verifyConnection&&(Be.info("ConnectionManager","Page became visible, verifying connection..."),this.chatService.verifyConnection().catch((()=>{})))}handleOnline(){Be.info("ConnectionManager","Network online, verifying connection..."),this.chatService.verifyConnection?this.chatService.verifyConnection().then((e=>{this.callbacks.onConnectionChange(e)})).catch((()=>{})):this.callbacks.onConnectionChange(!0)}handleOffline(){Be.warn("ConnectionManager","Network offline"),this.callbacks.onConnectionChange(!1)}}class Gn{constructor(){r(this,"typingIndicatorTimeout",null),r(this,"typingIndicatorElement",null)}show(){if(this.typingIndicatorTimeout&&(clearTimeout(this.typingIndicatorTimeout),this.typingIndicatorTimeout=null),!this.typingIndicatorElement)return;const e=this.typingIndicatorElement;"function"==typeof e.show?e.show():(this.typingIndicatorElement.style.opacity="1",this.typingIndicatorElement.style.display="flex"),this.typingIndicatorTimeout=window.setTimeout((()=>{this.hide()}),5e3)}hide(){if(this.typingIndicatorTimeout&&(clearTimeout(this.typingIndicatorTimeout),this.typingIndicatorTimeout=null),!this.typingIndicatorElement)return;const e=this.typingIndicatorElement;"function"==typeof e.hide?e.hide():(this.typingIndicatorElement.style.opacity="0",setTimeout((()=>{this.typingIndicatorElement&&(this.typingIndicatorElement.style.display="none")}),300))}setElement(e){this.typingIndicatorElement=e}cleanup(){this.typingIndicatorTimeout&&(clearTimeout(this.typingIndicatorTimeout),this.typingIndicatorTimeout=null),this.typingIndicatorElement=null}isVisible(){if(!this.typingIndicatorElement)return!1;const e=this.typingIndicatorElement;return"function"==typeof e.isVisible?e.isVisible():"flex"===this.typingIndicatorElement.style.display}}class Yn{constructor(e,t){if(r(this,"options"),r(this,"state"),r(this,"elements"),r(this,"chatService"),r(this,"isDarkMode",!1),r(this,"theme","auto"),r(this,"matchMediaListener",null),r(this,"matchMediaQuery",null),r(this,"themeObserver",null),r(this,"showButtonTimeout",null),r(this,"isMounted",!1),r(this,"isMounting",!1),r(this,"messageQueueManager"),r(this,"connectionManager",null),r(this,"typingIndicatorManager"),r(this,"elementSelector",null),r(this,"themeManager",Hn()),r(this,"customTheme",null),r(this,"shadowRoot",null),r(this,"widgetContainerElement",null),r(this,"boundHandlers",new Map),!e.companyName)throw new Error("companyName is required");if(!e.id)throw new Error("id is required");this.options={companyName:e.companyName,id:e.id,from:e.from,name:e.name,webSocketUrl:e.webSocketUrl,faqQuestions:e.faqQuestions||[],subtitle:e.subtitle,theme:e.theme,avatarSrc:e.avatarSrc,avatarInitials:e.avatarInitials},this.options.companyName=fe(this.options.companyName),this.chatService=t||this.createEmptyChatService(),this.processThemeConfig(),this.state={isOpen:!1,hasUnread:!1,isTyping:!1,messages:[],isConnected:!1},this.elements={container:null,button:null,chatWindow:null,messagesContainer:null,inputField:null,sendButton:null,form:null,typingIndicator:null},this.toggleChat=this.toggleChat.bind(this),this.sendMessage=this.sendMessage.bind(this),this.closeChat=this.closeChat.bind(this),this.handleTypingEvent=this.handleTypingEvent.bind(this),this.handleConnectionChange=this.handleConnectionChange.bind(this),this.messageQueueManager=new Qn({onRenderMessage:this.renderMessage.bind(this),onScrollToBottom:this.scrollToBottom.bind(this)}),this.typingIndicatorManager=new Gn,this.elementSelector=new Mn(this.handleElementSelected.bind(this))}updateChatService(e){this.chatService=e,this.connectionManager?this.connectionManager.updateChatService(e):this.connectionManager=new Jn(e,{onConnectionChange:this.handleConnectionChange.bind(this)}),this.chatService.onMessage(this.onMessage),this.chatService.onTyping(this.handleTypingEvent),this.chatService.onConnectionChange&&this.chatService.onConnectionChange(this.handleConnectionChange.bind(this)),this.chatService.onConnectionFailed&&this.chatService.onConnectionFailed(this.handleConnectionFailed.bind(this)),this.connectionManager&&(this.connectionManager.setupWatchdog(),this.connectionManager.setupVisibilityListeners(),this.connectionManager.setupNetworkListeners()),this.loadChatHistory(),this.chatService.verifyConnection&&this.chatService.verifyConnection().then((e=>{e&&this.handleConnectionChange(!0)})).catch((e=>{})),this.scheduleShowButton()}scheduleShowButton(){this.showButtonTimeout&&(clearTimeout(this.showButtonTimeout),this.showButtonTimeout=null)}handleElementSelected(e){const t=JSON.stringify({type:"selected-element",tag:e.tagName,selector:e.selector,text:e.text?e.text.substring(0,200):""});this.sendMessage(t),this.state.isOpen||this.toggleChat()}handleConnectionChange(e){this.updateConnectionStatus(e),e?this.showChatButton():this.hideChatButton()}handleConnectionFailed(e){this.connectionManager&&this.connectionManager.cleanup(),this.addSystemMessage(e)}createEmptyChatService(){return{sendMessage:async()=>{},onMessage:()=>{},formatTime:()=>"",onTyping:()=>{},onConnectionChange:()=>{}}}async loadChatHistory(){if(this.chatService&&this.chatService.getMessageHistory&&this.options.id&&this.options.from)try{const e=await this.chatService.getMessageHistory(this.options.id,this.options.from);if(0===e.length)return;for(const t of e)await this.renderHistoryMessage(t);this.scrollToBottom()}catch(e){Be.warn("ChatWidget","Error al cargar historial de mensajes",e)}}async renderHistoryMessage(e){if(!this.elements.messagesContainer)return;this.state.messages.push(e);const t=document.createElement("message-wrapper"),n=e.isUser?this.options.name?.charAt(0)||"U":this.options.companyName?.charAt(0)||"S";t.setAttribute("is-user",e.isUser?"true":"false"),t.setAttribute("avatar",n),t.setAttribute("animate","false");let i=e.text,s=null;if(i){const e=/<iframe>\[(https?:\/\/[^\]]+)\]<\/iframe>/g,t=e.exec(i);t&&(s=t[1],i=i.replace(e,"").trim())}if(i)try{const e=JSON.parse(i);e&&"selected-element"===e.type?(e.tag&&t.setAttribute("selected-element-tag",e.tag),e.selector&&t.setAttribute("selected-element-selector",e.selector),e.text&&t.setAttribute("selected-element-text",e.text)):t.setAttribute("text",i)}catch(a){t.setAttribute("text",i)}s&&t.setAttribute("media",`__WEB__IFRAME__${s}`),e.media&&t.setAttribute("media",e.media),e.timestamp&&t.setAttribute("timestamp",e.timestamp.toISOString());const o=e.isUser?this.options.name||"Tú":this.options.companyName||"Agente";t.setAttribute("author",o);const r=this.options.locale||"es";t.setAttribute("locale",r),e.isUser||t.setAttribute("show-timestamp","false"),this.elements.messagesContainer.appendChild(t)}async onMessage(e){}handleTypingEvent(e,t){this.options.from===t&&(this.state.isTyping=e,e?(this.showTypingIndicator(),this.typingIndicatorManager.show()):(this.hideTypingIndicator(),this.typingIndicatorManager.hide()))}showTypingIndicator(){if(!this.elements.messagesContainer)return;if(this.elements.typingIndicator){const e=this.elements.typingIndicator;return void("function"==typeof e.show&&e.show())}const e=document.createElement("typing-indicator");this.elements.chatWindow?this.elements.chatWindow.appendChild(e):this.elements.messagesContainer?this.elements.messagesContainer.appendChild(e):this.elements.container&&this.elements.container.appendChild(e),this.elements.typingIndicator=e,this.typingIndicatorManager.setElement(e),"function"==typeof e.show&&e.show()}hideTypingIndicator(){if(this.elements.typingIndicator){const e=this.elements.typingIndicator;"function"==typeof e.hide?e.hide():(e.style.opacity="0",setTimeout((()=>{this.elements.typingIndicator&&(this.elements.typingIndicator.style.display="none")}),300))}this.state.isTyping=!1}async mount(){if(this.isMounting||this.isMounted)Be.debug("ChatWidget:mount","Ya está montando o montado, ignorando llamada duplicada");else{this.isMounting=!0;try{if("undefined"==typeof document)return void(this.isMounting=!1);if(await this.createChatWidget(),!this.elements.container)return void(this.isMounting=!1);this.createChatButton(),this.addEventListeners(),this.setupThemeObserver(),this.isMounted=!0,this.isMounting=!1}catch(e){this.isMounting=!1}}}createChatButton(){if(!document.body)return;const e=document.querySelector("chat-widget-button");if(e)return Be.debug("ChatWidget:createChatButton","Botón ya existe en el DOM, reutilizando"),this.elements.button=e,void e.addEventListener("button-click",this.toggleChat);const t=document.createElement("chat-widget-button");t.setAttribute("hidden",""),t.setAttribute("aria-label","Abrir chat"),document.body.appendChild(t),this.elements.button=t,t.addEventListener("button-click",this.toggleChat)}showChatButton(){this.showButtonTimeout&&(clearTimeout(this.showButtonTimeout),this.showButtonTimeout=null),this.elements.button&&"function"==typeof this.elements.button.show?this.elements.button.show():this.elements.button&&this.elements.button.classList.remove("hidden")}hideChatButton(){this.showButtonTimeout&&(clearTimeout(this.showButtonTimeout),this.showButtonTimeout=null),this.elements.button&&"function"==typeof this.elements.button.hide?this.elements.button.hide():this.elements.button&&this.elements.button.classList.add("hidden")}updateButtonState(){this.elements.button&&(this.state.isOpen?(this.elements.button.setAttribute("is-open",""),this.elements.button.setAttribute("aria-label","Cerrar chat")):(this.elements.button.removeAttribute("is-open"),this.elements.button.setAttribute("aria-label","Abrir chat")))}async createChatWidget(){if(!document.body)return;const e=document.querySelector("chat-widget-container");if(e){Be.debug("ChatWidget:createChatWidget","Contenedor ya existe en el DOM, reutilizando"),this.widgetContainerElement=e,this.shadowRoot=e.getShadowRoot();const t=e.getContainer();if(t){this.elements.container=t,this.elements.chatWindow=this.shadowRoot.querySelector(".chat-messages"),this.elements.messagesContainer=this.shadowRoot.querySelector(".messages-container");const e=this.shadowRoot.querySelector("chat-input");e&&(this.elements.inputField=e.querySelector(".input-field"),this.elements.sendButton=e.querySelector(".send-button"),this.elements.form=e.querySelector("form")),this.checkForThemeAttribute(),await this.applyTheme()}return}const t=document.createElement("chat-widget-container");t.injectStyles("/**\n * Estilos para el chat widget\n */\n\n:root,\n:host {\n  /* ========================================\n   * TIPOGRAFÍA\n   * ======================================== */\n  --chat-font-family: \"Rubik\", sans-serif;\n  --chat-font-size-xsmall: 11px;\n  --chat-font-size-small: 13px;\n  --chat-font-size-base: 14px;\n  --chat-font-size-large: 16px;\n  --chat-font-size-header: 16px;\n  --chat-font-weight-regular: 400;\n  --chat-font-weight-medium: 500;\n  --chat-font-weight-semibold: 600;\n  --chat-font-weight-bold: 700;\n  --chat-line-height: 1.5;\n  \n  /* ========================================\n   * COLORES - MODO CLARO\n   * ======================================== */\n  --chat-primary-color: #111827;\n  --chat-secondary-color: #4B5563;\n  --chat-text-color: #1F2937;\n  --chat-text-secondary-color: #6B7280;\n  --chat-background: #FFFFFF;\n  --chat-background-chat: #F9FAFB;\n  --chat-white: #FFFFFF;\n  --chat-user-message-bg: #FEF3C7;\n  --chat-user-message-text: #92400E;\n  --chat-agent-message-bg: #F3F4F6;\n  --chat-agent-message-text: #1F2937;\n  --chat-border-color: #E5E7EB;\n  --chat-hover-color: #D1D5DB;\n  --chat-accent-color: #4F46E5;\n  --chat-time-color: #9CA3AF;\n  --chat-icon-color: #6B7280;\n  --chat-send-button: #4F46E5;\n  --chat-send-button-hover: #ffffff;\n  --chat-input-background: #FFFFFF;\n  --chat-input-placeholder: #E5E7EB;\n  \n  /* Colores legacy (mantener retrocompatibilidad) */\n  --chat-light-gray: #f5f5f5;\n  --chat-lighter-gray: #F9FAFB;\n  \n  /* ========================================\n   * ESPACIADO Y BORDES\n   * ======================================== */\n  --chat-border-radius: 16px;\n  --chat-message-border-radius: 12px;\n  --chat-button-border-radius: 50%;\n  --chat-container-padding: 16px;\n  --chat-message-padding: 12px 16px;\n  --chat-message-gap: 12px;\n  \n  /* ========================================\n   * SOMBRAS\n   * ======================================== */\n  --chat-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);\n  --chat-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);\n  --chat-shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.1);\n  \n  /* ========================================\n   * VARIABLES PARA COMPONENTES ESPECÍFICOS\n   * ======================================== */\n  /* Chat poll */\n  --poll-bg: #f5f5f5;\n  --question-color: inherit;\n  --option-bg: white;\n  --option-hover-bg: #eee;\n  --radio-border: #ccc;\n  --radio-selected: #007bff;\n  --stats-color: #666;\n  \n  /* Audio player */\n  --audio-bg: #f5f5f5;\n  --button-bg: #007bff;\n  --button-hover-bg: #0056b3;\n  --progress-bg: #ddd;\n  --progress-color: #007bff;\n  --time-color: #666;\n}\n\n/* ========================================\n * MODO OSCURO\n * ======================================== */\n.dark-mode {\n  /* Colores modo oscuro */\n  --chat-primary-color: #4F46E5;\n  --chat-secondary-color: #9CA3AF;\n  --chat-text-color: #E5E7EB;\n  --chat-text-secondary-color: #9CA3AF;\n  --chat-background: #1F2937;\n  --chat-background-chat: #111827;\n  --chat-white: #1F2937;\n  --chat-user-message-bg: #4F46E5;\n  --chat-user-message-text: #FFFFFF;\n  --chat-agent-message-bg: #374151;\n  --chat-agent-message-text: #E5E7EB;\n  --chat-border-color: #374151;\n  --chat-hover-color: #4B5563;\n  --chat-accent-color: #6366F1;\n  --chat-time-color: #9CA3AF;\n  --chat-icon-color: #9CA3AF;\n  --chat-send-button: #4F46E5;\n  --chat-send-button-hover: #6366F1;\n  --chat-input-background: #374151;\n  --chat-input-placeholder: #6B7280;\n  \n  /* Colores legacy (mantener retrocompatibilidad) */\n  --chat-light-gray: #1F2937;\n  --chat-lighter-gray: #111827;\n\n  /* Sombras para el modo oscuro */\n  --chat-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);\n  --chat-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);\n  --chat-shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.5);\n  \n  /* Variables para el chat poll - Modo oscuro */\n  --poll-bg: #1F2937;\n  --question-color: #E5E7EB;\n  --option-bg: #111827;\n  --option-hover-bg: #374151;\n  --radio-border: #4B5563;\n  --radio-selected: #4F46E5;\n  --stats-color: #9CA3AF;\n  \n  /* Variables para el audio player - Modo oscuro */\n  --audio-bg: #1F2937;\n  --button-bg: #4F46E5;\n  --button-hover-bg: #6366F1;\n  --progress-bg: #4B5563;\n  --progress-color: #4F46E5;\n  --time-color: #9CA3AF;\n}\n\n\n\n/* Aplicar la fuente Rubik a todos los elementos del chat */\n.chat-button,\n.chat-widget-container,\n.chat-widget-container * {\n  font-family: var(--chat-font-family);\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  text-rendering: optimizeLegibility;\n}\n\n/* Chat Button */\n.chat-button,\n.chat-widget-button {\n  position: fixed;\n  bottom: 20px;\n  right: 20px;\n  width: 50px;\n  height: 50px;\n  border-radius: 50%;\n  background-color: var(--chat-white);\n  color: var(--chat-text-color);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  cursor: pointer;\n  box-shadow: var(--chat-shadow-md);\n  z-index: 9998;\n  transition: all 0.3s ease;\n  border: none;\n  padding: 0;\n  margin: 0;\n  outline: none;\n  text-decoration: none;\n  font-size: inherit;\n  line-height: 1;\n  min-width: 50px;\n  min-height: 50px;\n  max-width: 50px;\n  max-height: 50px;\n}\n\n/* Wrapper del icono para animaciones */\n.chat-widget-button .icon-wrapper {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 25px;\n  height: 25px;\n  transition: opacity 0.15s ease, transform 0.15s ease;\n  /* Optimización de rendimiento: avisar al navegador qué propiedades van a cambiar */\n  will-change: opacity, transform;\n}\n\n/* Margen izquierdo solo para el icono de apertura */\n.chat-widget-button .icon-wrapper:has(.chat-icon-open) {\n  margin-left: -4px;\n}\n\n/* Estilos específicos para el SVG de apertura */\n.chat-widget-button .icon-wrapper .chat-icon-open {\n  width: 25px;\n  height: 25px;\n  display: block;\n}\n\n/* Asegurar que el SVG dentro del wrapper tenga el tamaño correcto */\n.chat-widget-button .icon-wrapper svg {\n  width: 25px;\n  height: 25px;\n  display: block;\n}\n\n/* Animación de salida del icono */\n.chat-widget-button .icon-wrapper.icon-exit {\n  opacity: 0;\n  /* Forzar hardware acceleration con translateZ(0) */\n  transform: rotate(-90deg) scale(0.8) translateZ(0);\n}\n\n/* Animación de entrada del icono */\n.chat-widget-button .icon-wrapper.icon-enter {\n  animation: iconEnter 0.2s ease forwards;\n}\n\n@keyframes iconEnter {\n  from {\n    opacity: 0;\n    transform: rotate(90deg) scale(0.8) translateZ(0);\n  }\n  to {\n    opacity: 1;\n    transform: rotate(0deg) scale(1) translateZ(0);\n  }\n}\n\n/* Estado inicial: oculto hasta verificar que está activo */\n.chat-widget-button.hidden {\n  opacity: 0;\n  visibility: hidden;\n  pointer-events: none;\n}\n\n.chat-button:hover,\n.chat-widget-button:hover {\n  transform: scale(1.05);\n}\n\n.notification-badge {\n  position: absolute;\n  top: -5px;\n  right: -5px;\n  width: 20px;\n  height: 20px;\n  border-radius: 50%;\n  background-color: #ef4444;\n  color: var(--chat-white);\n  font-size: 12px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n/* Chat Widget */\n.chat-widget-container {\n  position: fixed;\n  bottom: 85px;\n  right: 20px;\n  width: 450px;\n  height: 700px;\n  background-color: var(--chat-white);\n  border-radius: 16px;\n  box-shadow: var(--chat-shadow-lg);\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n  z-index: 9999;\n  opacity: 0;\n  transform: translateY(20px) scale(0.9);\n  pointer-events: none;\n  transition: all 0.3s ease;\n}\n\n.chat-widget-container.visible {\n  opacity: 1;\n  transform: translateY(0) scale(1);\n  pointer-events: all;\n}\n\n.chat-widget-container.expanded {\n  width: 500px;\n  height: 800px;\n}\n\n/* Chat Header */\n.chat-header {\n  display: flex;\n  align-items: center;\n  padding: 14px;\n  background-color: var(--chat-white);\n  color: var(--chat-text-color);\n  border-bottom: 1px solid var(--chat-border-color);\n}\n\n/* Web component chat-header */\nchat-header {\n  display: flex;\n  width: 100%;\n  min-width: 0;\n  align-items: center;\n  gap: 2px;\n}\n\n.header-title {\n  display: flex;\n  align-items: center;\n  gap: 5px;\n  flex: 1;\n  min-width: 0;\n}\n\n.back-button {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: none;\n  border: none;\n  cursor: pointer;\n  padding: 4px;\n  margin-right: 4px;\n  color: var(--chat-secondary-color);\n  flex-shrink: 0;\n  width: 32px;\n  height: 32px;\n}\n\n.back-button:hover {\n  opacity: 0.7;\n}\n\n.back-button svg {\n  width: 20px;\n  height: 20px;\n  display: block;\n}\n\n.clear-button {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: none;\n  border: none;\n  cursor: pointer;\n  padding: 6px;\n  color: var(--chat-secondary-color);\n  flex-shrink: 0;\n  width: 32px;\n  height: 32px;\n  border-radius: 6px;\n  transition: all 0.2s ease;\n}\n\n.clear-button:hover {\n  background-color: var(--chat-hover-color);\n  color: #EF4444;\n}\n\n.clear-button svg {\n  width: 18px;\n  height: 18px;\n  display: block;\n}\n\n.resize-button {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: none;\n  border: none;\n  cursor: pointer;\n  padding: 6px;\n  color: var(--chat-secondary-color);\n  flex-shrink: 0;\n  width: 32px;\n  height: 32px;\n  border-radius: 6px;\n  transition: all 0.2s ease;\n}\n\n.resize-button:hover {\n  background-color: var(--chat-hover-color);\n  color: var(--chat-accent-color);\n}\n\n.resize-button svg {\n  width: 18px;\n  height: 18px;\n  display: block;\n}\n\n.meeting-info {\n  display: flex;\n  flex-direction: column;\n  min-width: 0;\n  flex: 1;\n  overflow: hidden;\n}\n\n.meeting-name {\n  font-size: 16px;\n  font-weight: 500;\n  margin: 0;\n  color: var(--chat-text-color);\n}\n\n.truncate-title {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  min-width: 0;\n}\n\n.meeting-subtitle {\n  font-size: 12px;\n  font-weight: 400;\n  margin: 2px 0 0 0;\n  color: var(--chat-secondary-color);\n}\n\n.truncate-subtitle {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  min-width: 0;\n}\n\n\n.connection-status {\n  display: flex;\n  align-items: center;\n  flex-shrink: 0;\n}\n\n.status-indicator {\n  width: 8px;\n  height: 8px;\n  border-radius: 50%;\n  position: relative;\n  transition: all 0.3s ease;\n}\n\n.status-indicator.connected {\n  background-color: #28a745;\n  box-shadow: 0 0 8px #28a745;\n  animation: pulse-green 2s infinite;\n}\n\n.status-indicator.disconnected {\n  background-color: #dc3545;\n  box-shadow: 0 0 8px #dc3545;\n  animation: pulse-red 2s infinite;\n}\n\n@keyframes pulse-green {\n  0% {\n    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);\n  }\n  70% {\n    box-shadow: 0 0 0 6px rgba(40, 167, 69, 0);\n  }\n  100% {\n    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);\n  }\n}\n\n@keyframes pulse-red {\n  0% {\n    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);\n  }\n  70% {\n    box-shadow: 0 0 0 6px rgba(220, 53, 69, 0);\n  }\n  100% {\n    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);\n  }\n}\n\n.more-options {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: none;\n  border: none;\n  padding: 4px;\n  margin-left: 4px;\n  cursor: pointer;\n  color: var(--chat-secondary-color);\n  width: 28px;\n  height: 28px;\n  min-width: 28px;\n  flex-shrink: 0;\n}\n\n.more-options:hover {\n  opacity: 0.7;\n}\n\n.more-options svg {\n  width: 20px;\n  height: 20px;\n  display: block;\n}\n\n/* Chat Messages Container */\n.chat-messages {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n  background-color: var(--chat-white);\n  display: flex;\n  flex-direction: column;\n  position: relative;\n  \n  /* Personalización del scrollbar */\n  scrollbar-width: thin;\n  scrollbar-color: var(--chat-border-color) transparent;\n}\n\n/* Para navegadores webkit (Chrome, Safari, etc.) */\n.chat-messages::-webkit-scrollbar {\n  width: 6px;\n}\n\n.chat-messages::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.chat-messages::-webkit-scrollbar-thumb {\n  background-color: var(--chat-border-color);\n  border-radius: 6px;\n}\n\n.chat-messages::-webkit-scrollbar-thumb:hover {\n  background-color: var(--chat-secondary-color);\n}\n\n/* Personalización del scrollbar en modo oscuro */\n.dark-mode .chat-messages {\n  scrollbar-color: var(--chat-secondary-color) rgba(0, 0, 0, 0.2);\n}\n\n.dark-mode .chat-messages::-webkit-scrollbar-thumb {\n  background-color: var(--chat-secondary-color);\n}\n\n.dark-mode .chat-messages::-webkit-scrollbar-track {\n  background-color: rgba(0, 0, 0, 0.2);\n}\n\n.dark-mode .chat-messages::-webkit-scrollbar-thumb:hover {\n  background-color: var(--chat-accent-color);\n}\n\n.messages-container {\n  display: flex;\n  flex-direction: column;\n  gap: 3px;\n}\n\n/* Timestamp */\n.timestamp {\n  align-self: center;\n  font-size: 12px;\n  font-weight: 400;\n  color: var(--chat-time-color);\n  background-color: var(--chat-white);\n  padding: 4px 12px;\n  border-radius: 12px;\n  margin: 8px 0;\n  box-shadow: var(--chat-shadow-sm);\n}\n\n/* Chat Messages */\n.message-wrapper {\n  display: flex;\n  max-width: 100%;\n  margin-bottom: 0;\n  border-radius: 16px;\n}\n\n.message-wrapper.user {\n  align-self: flex-end;\n  flex-direction: row-reverse;\n}\n\n.message-wrapper.agent {\n  align-self: flex-start;\n  display: grid;\n}\n\n.avatar-container {\n  width: 32px;\n  height: 32px;\n  margin: 0 0px;\n  flex-shrink: 0;\n}\n\n.participant-avatar {\n  width: 100%;\n  height: 100%;\n  border-radius: 50%;\n  background-color: var(--chat-light-gray);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 14px;\n  font-weight: 600;\n  color: var(--chat-secondary-color);\n}\n\n.message-content {\n  display: flex;\n  flex-direction: column;\n  gap: 5px;\n  min-width: 0;\n}\n\n.message-timestamp {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  font-size: 0.7rem;\n  color: var(--chat-time-color);\n  margin-top: 4px;\n  padding: 0 4px;\n  min-width: 0;\n}\n\n.message-author {\n  font-weight: 500;\n  color: var(--chat-secondary-color);\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  flex-shrink: 1;\n  min-width: 0;\n}\n\n.message-time-separator {\n  color: var(--chat-time-color);\n  font-weight: 300;\n  flex-shrink: 0;\n}\n\n.message-time {\n  color: var(--chat-time-color);\n  font-weight: 400;\n  flex-shrink: 0;\n}\n\n.message-wrapper.user .message-timestamp {\n  justify-content: flex-end;\n}\n\n.message-wrapper.agent .message-timestamp {\n  justify-content: flex-start;\n}\n\n.message-bubble {\n  padding: 10px 14px;\n  border-radius: 18px;\n  font-optical-sizing: auto;\n  font-size: .85rem;\n  line-height: 1.4;\n  word-break: break-word;\n  font-weight: 400;\n  position: relative;\n}\n\n.message-bubble p, .message-bubble ul, .message-bubble ol {\n  margin: 0;\n  padding: 0;\n  list-style: none;\n}\n\n.message-bubble.user {\n  background-color: var(--chat-user-message-bg);\n  color: var(--chat-primary-color);\n  border-bottom-right-radius: 4px;\n  margin-right: 0px;\n}\n\n.dark-mode .message-bubble.user {\n  color: #F3F4F6;\n}\n\n.message-bubble.agent {\n  background-color: var(--chat-light-gray);\n  color: var(--chat-text-color);\n  margin-left: 0px;\n  width: fit-content;\n}\n\n/* Cualquier mensaje del agente que tenga otro mensaje del agente inmediatamente después: sin radius bottom-left */\n.message-wrapper.agent:has(+ .message-wrapper.agent) .message-bubble.agent {\n  border-bottom-left-radius: 0;\n}\n\n/* Cualquier mensaje del agente que tenga otro mensaje del agente inmediatamente antes: sin radius top-left */\n.message-wrapper.agent + .message-wrapper.agent .message-bubble.agent {\n  border-top-left-radius: 0;\n}\n\n.message-status {\n  display: flex;\n  align-items: center;\n  justify-content: flex-end;\n  margin-top: 4px;\n}\n\n.status-icon {\n  width: 16px;\n  height: 16px;\n  color: var(--chat-secondary-color);\n}\n\n/* Typing Indicator */\n.typing-indicator {\n  display: flex;\n  align-items: center;\n  margin: 0;\n}\n\n.typing-indicator .message-bubble.typing {\n  min-width: 40px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 8px 12px;\n}\n\n.typing-indicator .dot {\n  display: inline-block;\n  width: 8px;\n  height: 8px;\n  border-radius: 50%;\n  background-color: var(--chat-secondary-color);\n  margin: 0 2px;\n  animation: typing-dot 1.4s infinite ease-in-out both;\n}\n\n.typing-indicator .dot:nth-child(1) { animation-delay: 0s; }\n.typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }\n.typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }\n\n@keyframes typing-dot {\n  0%, 80%, 100% { transform: scale(0.8); opacity: 0.6; }\n  40% { transform: scale(1.2); opacity: 1; }\n}\n\n/* Chat Input */\n.chat-input {\n  padding: 12px 16px;\n  background-color: var(--chat-white);\n  border-top: 1px solid var(--chat-border-color);\n}\n\n.input-container {\n  display: flex;\n  align-items: flex-end;\n  gap: 2px;\n  border-radius: 28px;\n  padding: 5px;\n  transition: background-color 0.2s ease;\n}\n\n.dark-mode .input-container {\n  background-color: #111827;\n  border: 1px solid var(--chat-border-color);\n}\n\n.dark-mode .input-container:focus-within {\n  background-color: #1F2937;\n}\n\n.input-actions {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n  padding-right: 4px;\n}\n\n.action-button {\n  background: none;\n  border: none;\n  color: var(--chat-secondary-color);\n  cursor: pointer;\n  padding: 6px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: 50%;\n  transition: all 0.2s ease;\n  width: 30px;\n  height: 30px;\n  flex-shrink: 0;\n}\n\n.action-button:hover {\n  background-color: var(--chat-light-gray);\n}\n\n.dark-mode .action-button:hover {\n  background-color: var(--chat-border-color);\n}\n\n/* Selector button styles */\n.selector-btn {\n  position: relative;\n  transition: all 0.2s ease;\n}\n\n.selector-btn.active {\n  color: #4CAF50;\n  background-color: rgba(76, 175, 80, 0.1);\n  animation: pulse-selector 2s ease-in-out infinite;\n}\n\n.selector-btn.active svg {\n  transform: rotate(15deg);\n}\n\n/* Pulse animation for selector when active */\n@keyframes pulse-selector {\n  0%, 100% {\n    transform: scale(1);\n  }\n  50% {\n    transform: scale(1.05);\n  }\n}\n\n/* Add an active indicator dot */\n.selector-btn.active::after {\n  content: '';\n  position: absolute;\n  top: 4px;\n  right: 4px;\n  width: 8px;\n  height: 8px;\n  background-color: #4CAF50;\n  border-radius: 50%;\n  animation: blink-dot 1s ease-in-out infinite;\n}\n\n/* Microphone button styles */\n.mic-btn {\n  position: relative;\n}\n\n.mic-btn.mic-idle {\n  color: var(--chat-secondary-color);\n}\n\n.mic-btn.mic-listening {\n  color: #EF4444; /* Red color for recording */\n  animation: pulse-microphone 1.5s ease-in-out infinite;\n}\n\n.mic-btn.mic-error {\n  color: #EF4444;\n}\n\n/* Pulse animation for microphone when listening */\n@keyframes pulse-microphone {\n  0%, 100% {\n    transform: scale(1);\n    opacity: 1;\n  }\n  50% {\n    transform: scale(1.1);\n    opacity: 0.8;\n  }\n}\n\n/* Add a recording indicator dot */\n.mic-btn.mic-listening::after {\n  content: '';\n  position: absolute;\n  top: 4px;\n  right: 4px;\n  width: 8px;\n  height: 8px;\n  background-color: #EF4444;\n  border-radius: 50%;\n  animation: blink-dot 1s ease-in-out infinite;\n}\n\n@keyframes blink-dot {\n  0%, 100% {\n    opacity: 1;\n  }\n  50% {\n    opacity: 0.3;\n  }\n}\n\n/* Notification styles for chat input */\n.chat-input-notification {\n  position: absolute;\n  bottom: 100%;\n  left: 0;\n  right: 0;\n  margin-bottom: 8px;\n  padding: 12px 16px;\n  border-radius: 8px;\n  font-size: 14px;\n  line-height: 1.4;\n  box-shadow: var(--chat-shadow-md);\n  animation: slide-up 0.3s ease-out;\n  z-index: 1000;\n}\n\n.notification-info {\n  background-color: #DBEAFE;\n  color: #1E40AF;\n  border-left: 4px solid #3B82F6;\n}\n\n.notification-error {\n  background-color: #FEE2E2;\n  color: #991B1B;\n  border-left: 4px solid #EF4444;\n}\n\n/* Dark mode notifications */\n.dark-mode .notification-info {\n  background-color: #1E3A8A;\n  color: #BFDBFE;\n  border-left-color: #60A5FA;\n}\n\n.dark-mode .notification-error {\n  background-color: #7F1D1D;\n  color: #FECACA;\n  border-left-color: #F87171;\n}\n\n@keyframes slide-up {\n  from {\n    transform: translateY(10px);\n    opacity: 0;\n  }\n  to {\n    transform: translateY(0);\n    opacity: 1;\n  }\n}\n\n.input-actions-container {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n  justify-content: space-between;\n}\n\n.input-field {\n  flex: 1;\n  border: none;\n  background: none;\n  padding: 0;\n  font-size: 14px;\n  color: var(--chat-text-color);\n  outline: none;\n  font-weight: 400;\n  min-width: 0;\n  resize: none;\n  font-family: var(--chat-font-family);\n  line-height: 1.5;\n  min-height: 24px;\n  max-height: 120px;\n  overflow-y: hidden;\n  box-sizing: border-box;\n}\n\n.input-field::placeholder {\n  color: var(--chat-input-placeholder);\n  font-weight: 400;\n}\n\n.send-button {\n  background-color: var(--chat-primary-color);\n  color: var(--chat-white);\n  border: none;\n  border-radius: 50%;\n  width: 40px;\n  height: 40px;\n  min-width: 40px;\n  min-height: 40px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  flex-shrink: 0;\n}\n\n.send-button:hover:not(:disabled) {\n  transform: scale(1.05);\n}\n\n.send-button:active:not(:disabled) {\n  transform: scale(0.95);\n}\n\n.send-button:disabled {\n  background-color: var(--chat-time-color);\n  opacity: 0.15;\n  cursor: not-allowed;\n}\n\n.dark-mode .send-button {\n  background-color: var(--chat-accent-color);\n}\n\n.dark-mode .send-button:hover:not(:disabled) {\n  background-color: #6366F1;\n}\n\n/* FAQ Questions Container */\n.faq-questions-container {\n  padding: 0;\n  padding-top: 0;\n  display: none;\n  margin-top: auto;\n  margin-bottom: 0;\n}\n\n.faq-title {\n  font-size: 15px;\n  font-weight: 600;\n  color: var(--chat-text-color);\n  margin-bottom: 16px;\n}\n\n.faq-buttons {\n  display: flex;\n  flex-direction: row;\n  gap: 12px;\n  flex-wrap: wrap;\n  justify-content: flex-start;\n}\n\n.faq-button {\n  background-color: var(--chat-white);\n  color: var(--chat-text-color);\n  border: none;\n  border-radius: 50px;\n  padding: 12px 20px;\n  font-size: 14px;\n  font-weight: 400;\n  text-align: center;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);\n  white-space: nowrap;\n}\n\n.faq-button:hover {\n  background-color: var(--chat-white);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);\n}\n\n.faq-button:active {\n  transform: scale(0.98);\n}\n\n/* Dark mode FAQ styles */\n.dark-mode .faq-button {\n  background-color: var(--chat-white);\n  color: var(--chat-primary-color);\n}\n\n.dark-mode .faq-button:hover {\n  background-color: var(--chat-white);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);\n}\n\n/* Typewriter Effect */\n.typewriter-cursor {\n  display: inline-block;\n  color: var(--chat-primary-color);\n  margin-left: 2px;\n  animation: blink-cursor 1s step-end infinite;\n  font-weight: 400;\n}\n\n@keyframes blink-cursor {\n  0%, 50% {\n    opacity: 1;\n  }\n  51%, 100% {\n    opacity: 0;\n  }\n}\n\n.dark-mode .typewriter-cursor {\n  color: var(--chat-white);\n}\n\n/* Emoji Picker Styles */\n.emoji-picker {\n  background-color: var(--chat-white);\n  border: 1px solid var(--chat-border-color);\n  border-radius: 12px;\n  box-shadow: var(--chat-shadow-lg);\n  padding: 12px;\n  max-width: 280px;\n  max-height: 300px;\n  overflow-y: auto;\n  overflow-x: hidden;\n}\n\n.dark-mode .emoji-picker {\n  background-color: var(--chat-lighter-gray);\n  border-color: var(--chat-border-color);\n}\n\n.emoji-picker-grid {\n  display: grid;\n  grid-template-columns: repeat(8, 1fr);\n  gap: 4px;\n  width: 100%;\n}\n\n.emoji-picker-item {\n  background: none;\n  border: none;\n  cursor: pointer;\n  font-size: 24px;\n  padding: 4px;\n  border-radius: 6px;\n  transition: all 0.2s ease;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 32px;\n  height: 32px;\n  line-height: 1;\n}\n\n.emoji-picker-item:hover {\n  background-color: var(--chat-light-gray);\n  transform: scale(1.2);\n}\n\n.dark-mode .emoji-picker-item:hover {\n  background-color: var(--chat-border-color);\n}\n\n.emoji-picker-item:active {\n  transform: scale(1.1);\n}\n\n.emoji-picker::-webkit-scrollbar {\n  width: 6px;\n}\n\n.emoji-picker::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.emoji-picker::-webkit-scrollbar-thumb {\n  background-color: var(--chat-border-color);\n  border-radius: 3px;\n}\n\n.emoji-picker::-webkit-scrollbar-thumb:hover {\n  background-color: var(--chat-secondary-color);\n}\n\n/* Toast Notification Styles */\n.bb-notification-container {\n  font-family: var(--chat-font-family);\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n.bb-notification {\n  font-family: var(--chat-font-family);\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n.bb-notification-content {\n  font-family: var(--chat-font-family);\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n.bb-notification-close {\n  font-family: var(--chat-font-family);\n}\n\n/* Responsive Styles */\n@media (max-width: 480px) {\n  .chat-widget-container {\n    width: 100%;\n    height: 100%;\n    bottom: 0;\n    right: 0;\n    border-radius: 0;\n  }\n  \n  .chat-header {\n    border-radius: 0;\n  }\n} "),this.shadowRoot=t.getShadowRoot();const n=t.getContainer();if(!n)return void Be.error("ChatWidget:createChatWidget","No se pudo obtener el contenedor del Shadow DOM");this.checkForThemeAttribute(),n.innerHTML='\n      <div class="chat-header">\n        <chat-header></chat-header>\n      </div>\n      \n      <div class="chat-messages">\n        <div class="messages-container"></div>\n        <div class="faq-questions-container"></div>\n      </div>\n      \n      <chat-input placeholder="Escribe un mensaje..."></chat-input>\n    ',document.body.appendChild(t),this.widgetContainerElement=t,this.elements.container=n;const i=this.shadowRoot.querySelector("chat-header");i&&(i.setAttribute("company-name",this.options.companyName),i.setAttribute("connected","false"),this.options.subtitle&&i.setAttribute("subtitle",this.options.subtitle),this.options.avatarSrc&&i.setAttribute("avatar-src",this.options.avatarSrc),this.options.avatarInitials&&i.setAttribute("avatar-initials",this.options.avatarInitials)),this.elements.chatWindow=this.shadowRoot.querySelector(".chat-messages"),this.elements.messagesContainer=this.shadowRoot.querySelector(".messages-container");const s=this.shadowRoot.querySelector("chat-input");s&&(this.elements.inputField=s.querySelector(".input-field"),this.elements.sendButton=s.querySelector(".send-button"),this.elements.form=s.querySelector("form")),await this.applyTheme()}checkForThemeAttribute(){const e=document.querySelector("script[data-builderbot-chat]");if(e){const t=e.getAttribute("data-theme");t&&("dark"!==t&&"light"!==t&&"auto"!==t||(this.theme=t))}}processThemeConfig(){if(this.options.theme)try{if("string"==typeof this.options.theme){const e=this.themeManager.getPreset(this.options.theme);if(e)this.customTheme=e,Be.info("ChatWidget:processThemeConfig",`Tema preset "${this.options.theme}" cargado desde ThemeManager`);else{const e=Vn.get(this.options.theme.toLowerCase());e?(this.customTheme=e.clone(),Be.info("ChatWidget:processThemeConfig",`Tema preset "${this.options.theme}" cargado desde PRESET_THEMES`)):Be.warn("ChatWidget:processThemeConfig",`Preset "${this.options.theme}" no encontrado, usando tema por defecto`)}}else this.customTheme=new Nn(this.options.theme),Be.info("ChatWidget:processThemeConfig","Tema personalizado cargado",{hasColors:!!this.options.theme.colors,hasTypography:!!this.options.theme.typography,hasSpacing:!!this.options.theme.spacing})}catch(e){Be.error("ChatWidget:processThemeConfig","Error al procesar configuración de tema",e),this.customTheme=null}}async applyCustomTheme(){this.customTheme&&this.elements.container&&(Be.debug("ChatWidget:applyCustomTheme","Aplicando tema personalizado al widget"),await this.themeManager.applyTheme(this.customTheme,this.elements.container),this.elements.button&&await this.themeManager.applyTheme(this.customTheme,this.elements.button))}async applyTheme(){if(!this.customTheme)return"light"===this.theme?this.disableDarkMode():"dark"===this.theme?this.enableDarkMode():void this.loadThemePreference();await this.applyCustomTheme()}loadThemePreference(){try{this.cleanupMatchMediaListener(),"auto"===this.theme&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?this.enableDarkMode():this.disableDarkMode(),this.matchMediaQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.matchMediaListener=e=>{"auto"===this.theme&&(e.matches?this.enableDarkMode():this.disableDarkMode())},this.matchMediaQuery.addEventListener("change",this.matchMediaListener))}catch(e){}}cleanupMatchMediaListener(){this.matchMediaQuery&&this.matchMediaListener&&(this.matchMediaQuery.removeEventListener("change",this.matchMediaListener),this.matchMediaQuery=null,this.matchMediaListener=null)}setTheme(e){this.theme=e,"dark"===e?this.enableDarkMode():"light"===e?this.disableDarkMode():this.loadThemePreference()}enableDarkMode(){this.elements.container&&(this.elements.container.classList.add("dark-mode"),this.isDarkMode=!0)}disableDarkMode(){this.elements.container&&(this.elements.container.classList.remove("dark-mode"),this.isDarkMode=!1)}addEventListeners(){if(!this.elements.chatWindow)return;const e=this.shadowRoot?.querySelector(".close-button"),t=this.shadowRoot?.querySelector("chat-header"),n=this.shadowRoot?.querySelector("chat-input"),i=this.closeChat,s=this.closeChat,o=this.handleClearConversation.bind(this),r=this.handleResizeToggle.bind(this),a=e=>{const t=e.detail.message;t&&this.sendMessage(t)},c=()=>{this.captureAndUploadScreenshot()};if(e&&(e.addEventListener("click",i),this.boundHandlers.set("closeButton",i)),t&&(t.addEventListener("back-click",s),t.addEventListener("clear-conversation",o),t.addEventListener("resize-toggle",r),this.boundHandlers.set("backClick",s),this.boundHandlers.set("clearConversation",o),this.boundHandlers.set("resizeToggle",r)),n){const e=e=>{this.handleSelectorToggle(e.detail.active)};n.addEventListener("message-submit",a),n.addEventListener("screenshot-click",c),n.addEventListener("selector-toggle",e),this.boundHandlers.set("messageSubmit",a),this.boundHandlers.set("screenshot",c),this.boundHandlers.set("selectorToggle",e)}}removeEventListeners(){const e=this.shadowRoot?.querySelector(".close-button"),t=this.shadowRoot?.querySelector("chat-header"),n=this.shadowRoot?.querySelector("chat-input");e&&this.boundHandlers.has("closeButton")&&e.removeEventListener("click",this.boundHandlers.get("closeButton")),t&&(this.boundHandlers.has("backClick")&&t.removeEventListener("back-click",this.boundHandlers.get("backClick")),this.boundHandlers.has("clearConversation")&&t.removeEventListener("clear-conversation",this.boundHandlers.get("clearConversation")),this.boundHandlers.has("resizeToggle")&&t.removeEventListener("resize-toggle",this.boundHandlers.get("resizeToggle"))),n&&(this.boundHandlers.has("messageSubmit")&&n.removeEventListener("message-submit",this.boundHandlers.get("messageSubmit")),this.boundHandlers.has("screenshot")&&n.removeEventListener("screenshot-click",this.boundHandlers.get("screenshot")),this.boundHandlers.has("selectorToggle")&&n.removeEventListener("selector-toggle",this.boundHandlers.get("selectorToggle"))),this.boundHandlers.clear()}async sendMessage(e){if(!e)return;const t=new Date,n=this.chatService.formatTime?this.chatService.formatTime(t):t.toLocaleTimeString(),i={text:e,from:this.options.from,name:this.options.name,timestamp:t,isUser:!0,sender:"user",formattedTime:n,projectId:this.options.id};this.addMessageToQueue(i),this.chatService&&this.chatService.saveToStorage&&this.chatService.saveToStorage(i);const s=this.shadowRoot?.querySelector(".faq-questions-container");s&&(s.style.display="none");try{await this.chatService.sendMessage(i)}catch(o){if(o instanceof Error&&o.message.includes("límite")){const e=this.shadowRoot?.querySelector("chat-input");e&&e.activateThrottle&&e.activateThrottle()}}}hideNotification(){if(this.elements.button){if("function"==typeof this.elements.button.setBadgeCount)this.elements.button.setBadgeCount(null);else{const e=this.elements.button.querySelector(".notification-badge");e&&(e.style.display="none")}this.state.hasUnread=!1}}addUserMessage(e){const t=new Date,n=this.chatService.formatTime?this.chatService.formatTime(t):t.toLocaleTimeString(),i={text:e,from:this.options.from,name:this.options.name,timestamp:t,isUser:!0,sender:"user",formattedTime:n,projectId:this.options.id};this.addMessageToQueue(i);const s=this.shadowRoot?.querySelector(".faq-questions-container");s&&(s.style.display="none")}addSystemMessage(e,t){const n=t?.timestamp||new Date,i=this.chatService.formatTime?this.chatService.formatTime(n):n.toLocaleTimeString(),s={text:e,from:this.options.from,name:this.options.companyName,timestamp:n,isUser:!1,sender:"agent",formattedTime:i,projectId:this.options.id,media:t?.media};this.addMessageToQueue(s),this.chatService&&this.chatService.saveToStorage&&this.chatService.saveToStorage(s)}addMessageToQueue(e){this.messageQueueManager.addMessage(e)}async renderMessage(e,t=!1){if(!this.elements.messagesContainer)return;if(!e.isUser){const e=this.elements.messagesContainer.querySelectorAll("message-wrapper.agent");if(e.length>0){e[e.length-1].setAttribute("show-timestamp","false")}}const n=document.createElement("message-wrapper"),i=e.isUser?this.options.name?.charAt(0)||"U":this.options.companyName?.charAt(0)||"S";n.setAttribute("is-user",e.isUser?"true":"false"),n.setAttribute("avatar",i);const s=!e.isUser&&!t;n.setAttribute("animate",s?"true":"false");let o=e.text,r=null;if(o){const e=/<iframe>\[(https?:\/\/[^\]]+)\]<\/iframe>/g,t=e.exec(o);t&&(r=t[1],o=o.replace(e,"").trim())}if(o)try{const e=JSON.parse(o);e&&"selected-element"===e.type?(e.tag&&n.setAttribute("selected-element-tag",e.tag),e.selector&&n.setAttribute("selected-element-selector",e.selector),e.text&&n.setAttribute("selected-element-text",e.text)):n.setAttribute("text",o)}catch(l){n.setAttribute("text",o)}r&&n.setAttribute("media",`__WEB__IFRAME__${r}`),e.media&&n.setAttribute("media",e.media),e.timestamp&&n.setAttribute("timestamp",e.timestamp.toISOString());const a=e.isUser?this.options.name||"Tú":this.options.companyName||"Agente";n.setAttribute("author",a);const c=this.options.locale||"es";n.setAttribute("locale",c),e.isUser||n.setAttribute("show-timestamp","false"),this.elements.messagesContainer.appendChild(n),this.scrollToBottom(),this.state.messages.push(e),s&&n.waitForAnimation&&(await n.waitForAnimation(),n.setAttribute("show-timestamp","true"))}scrollToBottom(){this.elements.chatWindow&&(this.elements.chatWindow.scrollTop=this.elements.chatWindow.scrollHeight)}renderFAQQuestions(){const e=this.shadowRoot?.querySelector(".faq-questions-container");if(!e||!this.options.faqQuestions||0===this.options.faqQuestions.length)return;if(e.innerHTML="",this.state.messages.length>0)return void(e.style.display="none");e.style.display="block";const t=document.createElement("div");t.className="faq-buttons",this.options.faqQuestions.forEach((n=>{const i=document.createElement("button");i.className="faq-button",i.textContent=n,i.type="button",i.addEventListener("click",(()=>{const t=this.shadowRoot?.querySelector("chat-input");t&&(t.setValue(n),this.sendMessage(n),t.clear(),e.style.display="none")})),t.appendChild(i)})),e.appendChild(t)}toggleChat(){this.elements.container&&(this.state.isOpen=!this.state.isOpen,this.updateButtonState(),this.state.isOpen?(this.elements.container.classList.add("visible"),this.hideNotification(),this.renderFAQQuestions(),setTimeout((()=>{const e=this.shadowRoot?.querySelector("chat-input");e&&e.focus&&e.focus()}),300),this.scrollToBottom()):this.elements.container.classList.remove("visible"))}closeChat(){this.elements.container&&(this.state.isOpen=!1,this.updateButtonState(),this.elements.container.classList.remove("visible"))}handleSelectorToggle(e){if(!this.elementSelector)return;e?(this.elementSelector.activate(),this.state.isOpen&&this.closeChat()):this.elementSelector.deactivate();const t=this.shadowRoot?.querySelector("chat-input");t&&t.setSelectorActive&&t.setSelectorActive(this.elementSelector.active)}handleResizeToggle(){if(!this.elements.container)return;this.elements.container.classList.toggle("expanded");const e=this.shadowRoot?.querySelector("chat-header");if(e){this.elements.container.classList.contains("expanded")?e.setAttribute("expanded","true"):e.removeAttribute("expanded")}}async handleClearConversation(){if(confirm("¿Estás seguro de que quieres limpiar toda la conversación? Esta acción no se puede deshacer."))try{this.chatService&&this.chatService.clearHistory&&this.options.id&&this.options.from&&await this.chatService.clearHistory(this.options.id,this.options.from),this.elements.messagesContainer&&(this.elements.messagesContainer.innerHTML=""),this.state.messages=[],this.renderFAQQuestions(),Be.debug("ChatWidget","Conversación limpiada correctamente")}catch(e){Be.error("ChatWidget","Error al limpiar la conversación",e instanceof Error?e:void 0,{error:e}),alert("Hubo un error al limpiar la conversación. Por favor intenta de nuevo.")}}unmount(){this.connectionManager&&(this.connectionManager.cleanup(),this.connectionManager=null),this.typingIndicatorManager.cleanup(),this.messageQueueManager.clear(),this.removeEventListeners(),this.cleanupMatchMediaListener(),this.cleanupThemeObserver(),this.showButtonTimeout&&(clearTimeout(this.showButtonTimeout),this.showButtonTimeout=null),this.elementSelector&&(this.elementSelector.destroy(),this.elementSelector=null),null!==ke&&(clearTimeout(ke),ke=null),ve=null,we=0,this.hideChatButton(),this.elements.button&&(this.elements.button.removeEventListener("button-click",this.toggleChat),this.elements.button.parentNode&&this.elements.button.remove()),this.widgetContainerElement&&this.widgetContainerElement.parentNode&&this.widgetContainerElement.remove(),this.elements={container:null,button:null,chatWindow:null,messagesContainer:null,inputField:null,sendButton:null,form:null,typingIndicator:null},this.widgetContainerElement=null,this.isMounted=!1,this.isMounting=!1,"undefined"!=typeof window&&window.BuilderBotChat?._clearGlobalInstance&&window.BuilderBotChat._clearGlobalInstance()}async captureAndUploadScreenshot(){try{const e=await navigator.mediaDevices.getDisplayMedia(),t=document.createElement("video");t.srcObject=e,await new Promise((e=>{t.onloadedmetadata=()=>{t.play(),e(null)}}));const n=document.createElement("canvas");n.width=t.videoWidth,n.height=t.videoHeight;const i=n.getContext("2d");i?.drawImage(t,0,0),e.getTracks().forEach((e=>e.stop()));const s=n.toDataURL("image/jpeg").split(",")[1],o=this.options.imgbbApiKey||"";if(!o)return void this.addSystemMessage("Screenshot feature requires API key configuration.");const r=new FormData;r.append("key",o),r.append("image",s);const a=await fetch("https://api.imgbb.com/1/upload",{method:"POST",body:r}),c=await a.json();c.success?this.addSystemMessage("Screenshot captured:",{media:c.data.url}):this.addSystemMessage("Failed to upload screenshot.")}catch(e){this.addSystemMessage("Failed to capture screenshot.")}}updateConnectionStatus(e){this.state.isConnected=e,this.updateConnectionStatusUI()}updateConnectionStatusUI(){if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector("chat-header");e&&e.setAttribute("connected",this.state.isConnected?"true":"false")}setupThemeObserver(){this.cleanupThemeObserver();const e=document.querySelector("script[data-builderbot-chat]");e&&"MutationObserver"in window&&(this.themeObserver=new MutationObserver((t=>{t.forEach((t=>{if("attributes"===t.type&&"data-theme"===t.attributeName){const t=e.getAttribute("data-theme");!t||"dark"!==t&&"light"!==t&&"auto"!==t||this.setTheme(t)}}))})),this.themeObserver.observe(e,{attributes:!0}))}cleanupThemeObserver(){this.themeObserver&&(this.themeObserver.disconnect(),this.themeObserver=null)}}const Kn="",Zn="script[data-builderbot-chat]",Xn="data-company",ei="data-id",ti="data-websocket-url",ni="data-locale",ii="builderbot_name",si="builderbot_from",oi={DEFAULT_URL:"wss://s1.socket.builderbot.cloud",MAX_RECONNECT_ATTEMPTS:5,RECONNECT_DELAY:2e3,CONNECTION_TIMEOUT:1e4,HEARTBEAT_INTERVAL:6e4,AUTO_RECONNECT:!0,MAX_MESSAGE_SIZE:1048576},ri=5,ai=10,ci=20,li=2e3;class hi{constructor(e=Kn,t,n,i){r(this,"id"),r(this,"webSocketService"),r(this,"webSocketUrl"),r(this,"typingHandler",null),r(this,"connectionHandler",null),r(this,"connectionFailedHandler",null),r(this,"storageRepository",null),r(this,"hasConnectionFailedPermanently",!1),Be.info("ChatService","Iniciando servicio de chat",{id:e,hasWebSocketService:!!t,webSocketUrl:n}),this.id=e,this.webSocketService=t,this.webSocketUrl=n,this.storageRepository=i||null,this.id&&this.webSocketService&&this.webSocketUrl?(Be.info("ChatService","Intentando inicializar WebSocket"),this.initializeWebSocket()):(Be.warn("ChatService","No se cumplen condiciones para inicializar WebSocket",{id:!!this.id,webSocketService:!!this.webSocketService,webSocketUrl:!!this.webSocketUrl},Me.BOTH),this.connectionHandler&&this.connectionHandler(!1)),this.webSocketService&&this.webSocketService.onEvent("typing",(e=>{if(this.typingHandler&&e&&"object"==typeof e){const t=!!e.isTyping,n=e.from||"";Be.debug("ChatService","Evento typing recibido",{isTyping:t,from:n}),this.typingHandler(t,n)}}))}onMessage(e){this.webSocketService.onMessageReceived(e)}onTyping(e){this.typingHandler=e}onConnectionChange(e){this.connectionHandler=e,this.webSocketService?this.webSocketService.onEvent("connection",(t=>{t&&"object"==typeof t&&"boolean"==typeof t.isConnected&&e(t.isConnected)})):e(!1)}onConnectionFailed(e){this.connectionFailedHandler=e,this.webSocketService&&this.webSocketService.onEvent("connectionFailed",(t=>{t&&"object"==typeof t&&"string"==typeof t.errorMessage&&(Be.error("ChatService","Falla permanente de conexión detectada",void 0,{errorMessage:t.errorMessage}),this.hasConnectionFailedPermanently=!0,e(t.errorMessage))}))}async initializeWebSocket(){if(Be.debug("ChatService","Iniciando inicialización de WebSocket"),this.webSocketService&&this.webSocketUrl&&this.id)try{Be.debug("ChatService",`Intentando conectar a: ${this.webSocketUrl}`),await this.webSocketService.initialize(this.webSocketUrl,this.id),Be.info("ChatService",`WebSocket inicializado correctamente para ID: ${this.id}`);const e=this.webSocketService.isConnected();this.webSocketService.joinProject().then((()=>{Be.info("ChatService",`Unido exitosamente al proyecto ${this.id}`)})).catch((e=>{const t=e instanceof Error?e.message:String(e);t.toLowerCase().includes("deploy not found")||t.toLowerCase().includes("project deployment not found")||t.toLowerCase().includes("eaddrnotavail")||t.toLowerCase().includes("falló después de")?Be.error("ChatService",`Error fatal al unirse al proyecto (no se reintentará): ${t}`,e instanceof Error?e:void 0,{rawError:e},Me.BOTH):Be.warn("ChatService",`Error temporal al unirse al proyecto: ${t}`,e instanceof Error?e:void 0)})),this.connectionHandler&&this.connectionHandler(e),e?Be.info("ChatService","Conexión WebSocket establecida y lista"):Be.error("ChatService","WebSocket no conectado correctamente después de inicialización",void 0,{},Me.BOTH)}catch(e){this.connectionHandler&&this.connectionHandler(!1),e instanceof Error?Be.error("ChatService",`Error al inicializar WebSocket: ${e.message}`,e,{},Me.BOTH):Be.error("ChatService","Error desconocido al inicializar WebSocket",void 0,{error:e},Me.BOTH)}else this.connectionHandler&&this.connectionHandler(!1),Be.warn("ChatService","Faltan datos necesarios para inicializar WebSocket",{webSocketService:!!this.webSocketService,webSocketUrl:this.webSocketUrl,id:this.id})}async sendMessage(e){if(!this.webSocketService)throw Be.error("ChatService","No hay servicio WebSocket disponible",void 0,{},Me.BOTH),new Error("No hay servicio WebSocket disponible");if(e.text)try{if(!this.webSocketService.isConnected())throw this.connectionHandler&&this.connectionHandler(!1),Be.error("ChatService","No se puede enviar mensaje: No hay conexión WebSocket",void 0,{},Me.BOTH),new Error("No hay conexión WebSocket disponible");Be.debug("ChatService","Enviando mensaje",{text:e.text}),await this.webSocketService.sendMessage(e),Be.debug("ChatService","Mensaje enviado correctamente")}catch(t){throw this.connectionHandler&&this.connectionHandler(!1),Be.error("ChatService","Error al enviar mensaje",t instanceof Error?t:void 0,{rawError:t},Me.BOTH),t}else Be.warn("ChatService","Mensaje vacío no enviado")}formatTime(e){return e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}dispose(){this.webSocketService&&(this.webSocketService.close(),this.connectionHandler&&this.connectionHandler(!1))}async handleReconnection(){if(this.hasConnectionFailedPermanently)return Be.warn("ChatService","No se intentará reconectar: la conexión ha fallado permanentemente"),!1;if(Be.debug("ChatService","Iniciando intento de reconexión"),!this.webSocketService||!this.webSocketUrl||!this.id)return Be.warn("ChatService","No se puede reconectar: faltan datos necesarios",{webSocketService:!!this.webSocketService,webSocketUrl:this.webSocketUrl,id:this.id},Me.BOTH),this.connectionHandler&&this.connectionHandler(!1),!1;Be.debug("ChatService",`Intentando reconectar al servidor WebSocket: ${this.webSocketUrl}`);try{await this.webSocketService.initialize(this.webSocketUrl,this.id);const e=this.webSocketService.isConnected();return Be.debug("ChatService","Estado después de intento de reconexión",{isConnected:e}),this.connectionHandler&&this.connectionHandler(e),e?(Be.info("ChatService","Reconexión exitosa al servidor WebSocket"),!0):(Be.error("ChatService","Reconexión falló - WebSocket no está conectado después de initialize()",void 0,{},Me.BOTH),!1)}catch(e){return this.connectionHandler&&this.connectionHandler(!1),Be.error("ChatService","ERROR al intentar reconectar:",e instanceof Error?e:void 0,{rawError:e},Me.BOTH),!1}}async checkConnection(){if(!this.webSocketService)return this.connectionHandler&&this.connectionHandler(!1),!1;const e=this.webSocketService.isConnected();return this.connectionHandler&&this.connectionHandler(e),e}async verifyConnection(){if(this.hasConnectionFailedPermanently)return Be.warn("ChatService","No se verificará la conexión: ha fallado permanentemente"),!1;if(Be.info("ChatService","Verificando estado de conexión WebSocket"),!this.webSocketService||!this.webSocketUrl||!this.id)return Be.warn("ChatService","No se puede verificar la conexión: faltan datos necesarios",{webSocketService:!!this.webSocketService,webSocketUrl:!!this.webSocketUrl,id:!!this.id}),this.connectionHandler&&this.connectionHandler(!1),!1;if(this.webSocketService.isConnected())return Be.debug("ChatService","Conexión WebSocket verificada - Activa"),this.connectionHandler&&this.connectionHandler(!0),!0;Be.info("ChatService","Conexión WebSocket inactiva, intentando reconectar");const e=await this.handleReconnection();return this.connectionHandler&&this.connectionHandler(e),e?Be.info("ChatService","Conexión WebSocket restablecida correctamente"):Be.error("ChatService","No se pudo restablecer la conexión WebSocket",void 0,{},Me.BOTH),e}setupConnectionWatchdog(e=6e4){Be.info("ChatService",`Configurando verificador periódico de conexión (intervalo: ${e}ms)`);const t=setInterval((()=>{this.verifyConnection().catch((e=>{const t=e instanceof Error?e.message:"Error desconocido";Be.error("ChatService",`Error en verificador periódico de conexión: ${t}`,e instanceof Error?e:void 0)}))}),e);return()=>{Be.debug("ChatService","Cancelando verificador periódico de conexión"),clearInterval(t)}}chatMessageToStoredMessage(e){return{id:"",projectId:e.projectId,text:e.text,from:e.from,media:e.media,name:e.name,sender:e.sender,timestamp:e.timestamp.getTime(),isUser:e.isUser}}saveToStorage(e){this.saveMessageToStorage(e)}saveMessageToStorage(e){if(this.storageRepository)try{const t=this.chatMessageToStoredMessage(e);Be.debug("ChatService","Guardando mensaje en storage",{projectId:t.projectId,from:t.from,sender:t.sender,text:t.text.substring(0,50)}),this.storageRepository.saveMessage(t).catch((e=>{Be.warn("ChatService","Error al guardar mensaje en storage (no crítico)",{error:e})}))}catch(t){Be.warn("ChatService","Error al preparar mensaje para storage (no crítico)",{error:t})}else Be.debug("ChatService","No hay storage repository disponible")}async getMessageHistory(e,t){if(!this.storageRepository)return[];try{const n=await this.storageRepository.getMessages(e,t,25);return this.storageRepository.clearOldMessages(e,t,7).catch((e=>{Be.warn("ChatService","Error al limpiar mensajes antiguos (no crítico)",{error:e})})),n.map((e=>({projectId:e.projectId,text:e.text,from:e.from,media:e.media,name:e.name,sender:e.sender,timestamp:new Date(e.timestamp),isUser:e.isUser,formattedTime:this.formatTime(new Date(e.timestamp))})))}catch(n){return Be.error("ChatService","Error al obtener historial de mensajes",n instanceof Error?n:void 0),[]}}async clearHistory(e,t){if(this.storageRepository)try{Be.info("ChatService","Limpiando historial de conversación",{projectId:e,from:t}),await this.storageRepository.clearAll(e,t),Be.info("ChatService","Historial de conversación limpiado correctamente")}catch(n){throw Be.error("ChatService","Error al limpiar historial de conversación",n instanceof Error?n:void 0),n}else Be.debug("ChatService","No hay storage repository disponible para limpiar")}}class di{constructor(e,t,n){r(this,"repository"),r(this,"projectId",""),r(this,"eventHandlers",{}),r(this,"messageCounters",new Map),r(this,"messageRateLimit",5),r(this,"customEventHandlers",new Map),r(this,"lastConnectionState",!1),r(this,"MAX_EVENT_HANDLERS_PER_TYPE",ai),r(this,"MAX_EVENT_TYPES",ci),r(this,"rateLimitCleanupInterval",null),this.repository=e,this.eventHandlers=t,n?.messageRateLimit&&(this.messageRateLimit=n.messageRateLimit)}emitCustomEvent(e,t){if(this.customEventHandlers.has(e)){const n=this.customEventHandlers.get(e);n&&n.forEach((n=>{try{n(t)}catch(i){Be.error("WebSocketService",`Error al emitir evento personalizado ${e}:`,i instanceof Error?i:new Error(String(i)))}}))}}validateWebSocketUrl(e){if(!e||"string"!=typeof e)throw new Error("URL inválida: La URL debe ser una cadena no vacía");if(!e.startsWith("wss://")&&!e.startsWith("ws://"))throw new Error("URL inválida: La URL debe comenzar con wss:// o ws://");if(e.length<9)throw new Error("URL inválida: La URL es demasiado corta");return e}async initialize(e,t){try{const n=this.validateWebSocketUrl(e);if(!t||"string"!=typeof t)throw new Error("ID de chat inválido: El ID debe ser una cadena no vacía");if(this.projectId=t,this.setupGlobalHandlers(),this.startRateLimitCleanup(),!this.repository)throw new Error("Repositorio WebSocket no disponible");return await this.repository.connect(n,this.eventHandlers,t),this.checkAndNotifyConnectionChange(),Promise.resolve()}catch(n){throw Be.error("WebSocketService","Error al inicializar",n instanceof Error?n:void 0),this.emitCustomEvent("connection",{isConnected:!1}),this.lastConnectionState=!1,n}}startRateLimitCleanup(){this.stopRateLimitCleanup(),this.rateLimitCleanupInterval=setInterval((()=>{const e=Date.now(),t=Math.floor(e/1e3);this.messageCounters.forEach(((e,n)=>{t-n>10&&this.messageCounters.delete(n)}))}),3e4)}stopRateLimitCleanup(){null!==this.rateLimitCleanupInterval&&(clearInterval(this.rateLimitCleanupInterval),this.rateLimitCleanupInterval=null)}checkAndNotifyConnectionChange(){const e=this.isConnected();e!==this.lastConnectionState&&(this.emitCustomEvent("connection",{isConnected:e}),this.lastConnectionState=e,Be.info("WebSocketService","Estado de conexión cambiado a: "+(e?"conectado":"desconectado")))}setupGlobalHandlers(){const e={...this.eventHandlers};this.eventHandlers={...e,onOpen:()=>{Be.info("WebSocketService","Conexión WebSocket abierta"),this.emitCustomEvent("connection",{isConnected:!0}),this.lastConnectionState=!0,this.projectId&&this.joinProject().then((()=>{Be.info("WebSocketService",`Vuelto a unir al proyecto ${this.projectId} después de reconectar`)})).catch((e=>{const t=e instanceof Error?e.message:String(e);t.toLowerCase().includes("deploy not found")||t.toLowerCase().includes("project deployment not found")||t.toLowerCase().includes("eaddrnotavail")||t.toLowerCase().includes("falló después de")?Be.error("WebSocketService",`Error fatal al unirse al proyecto (no se reintentará): ${t}`,e instanceof Error?e:void 0):Be.warn("WebSocketService",`Error temporal al unirse al proyecto: ${t}`,e instanceof Error?e:void 0)})),e.onOpen&&e.onOpen()},onError:t=>{Be.error("WebSocketService","Error en WebSocket",t);const n=t instanceof Error?t.message:String(t);n.includes("No se pudo conectar al servidor después de")&&n.includes("intentos")&&(this.emitCustomEvent("connectionFailed",{isConnected:!1,errorMessage:n}),Be.error("WebSocketService","Falla permanente de conexión",t)),this.checkAndNotifyConnectionChange(),e.onError&&e.onError(t)},onClose:()=>{Be.info("WebSocketService","Conexión WebSocket cerrada"),this.emitCustomEvent("connection",{isConnected:!1}),this.lastConnectionState=!1,e.onClose&&e.onClose()},onMessage:(t,n)=>{e.onMessage&&e.onMessage(t,n,this.projectId)},onTyping:(t,n)=>{Be.debug("WebSocketService","Evento de typing recibido",{isTyping:t,from:n}),e.onTyping&&e.onTyping(t,n)}}}close(){this.stopRateLimitCleanup(),this.repository&&(this.repository.disconnect(),this.emitCustomEvent("connection",{isConnected:!1}),this.lastConnectionState=!1),this.clearAllEventHandlers(),this.messageCounters.clear()}isConnected(){return!!this.repository&&this.repository.isConnected()}validateMessage(e){if(!e||"object"!=typeof e)throw new Error("Mensaje inválido: El mensaje debe ser un objeto");if(!e.text||"string"!=typeof e.text)throw new Error("Mensaje inválido: El texto del mensaje es requerido y debe ser una cadena");if(e.text.length>li)throw new Error(`Mensaje inválido: El texto excede la longitud máxima permitida (${li} caracteres)`);if(!e.from||"string"!=typeof e.from)throw new Error('Mensaje inválido: El campo "from" es requerido y debe ser una cadena');if(!e.projectId||"string"!=typeof e.projectId)throw new Error('Mensaje inválido: El campo "projectId" es requerido y debe ser una cadena');const t=1048576;if(JSON.stringify(e).length>t)throw new Error("Mensaje inválido: El tamaño total del mensaje excede el límite permitido (1048576 bytes)")}async sendMessage(e){try{this.validateMessage(e)}catch(i){throw Be.error("WebSocketService","Error de validación de mensaje",i instanceof Error?i:void 0),i}if(!this.checkRateLimit())throw new Error(`Se ha excedido el límite de ${this.messageRateLimit} mensajes por segundo`);if(!this.isConnected())throw this.emitCustomEvent("connection",{isConnected:!1}),this.lastConnectionState=!1,new Error("No hay conexión WebSocket disponible");const t=((e=!1)=>{if("undefined"==typeof window||"undefined"==typeof document)return null;const t=Date.now()-we;return!e&&ve&&t<6e4?ve:(null!==ke&&(clearTimeout(ke),ke=null),e||t>=6e4?xe():(ke=setTimeout((()=>{xe(),ke=null}),1e3),ve))})(),n={type:"text",content:e.text,projectId:this.projectId,name:e.name,from:e.from,emitter:"user",metadata:{url:t?.url,browserInfo:t},timestamp:Date.now()};try{return Be.info("WebSocketService","Enviando mensaje",n),await this.repository.sendMessage(n),this.checkAndNotifyConnectionChange(),Promise.resolve()}catch(i){throw this.checkAndNotifyConnectionChange(),i}}onMessageReceived(e){if(!e||"function"!=typeof e)throw new Error("Manejador inválido: Debe ser una función");Be.debug("WebSocketService","Registrando manejador para mensajes recibidos",e)}checkRateLimit(){const e=Date.now(),t=Math.floor(e/1e3);this.messageCounters.size>20&&this.messageCounters.forEach(((e,n)=>{t-n>10&&this.messageCounters.delete(n)}));const n=this.messageCounters.get(t)||0;return!(n>=this.messageRateLimit)&&(this.messageCounters.set(t,n+1),!0)}joinProject(){return this.repository.joinProject(this.projectId)}cleanupOldHandlers(e){const t=this.customEventHandlers.get(e);t&&t.length>this.MAX_EVENT_HANDLERS_PER_TYPE&&(t.shift(),Be.warn("WebSocketService",`Límite de handlers alcanzado para ${e}, eliminando handler más antiguo`))}cleanupOldEventTypes(){if(this.customEventHandlers.size>=this.MAX_EVENT_TYPES){const e=this.customEventHandlers.keys().next().value;e&&(this.customEventHandlers.delete(e),Be.warn("WebSocketService",`Límite de tipos de eventos alcanzado, eliminando tipo: ${e}`))}}clearEventHandlers(e){this.customEventHandlers.has(e)&&(this.customEventHandlers.delete(e),Be.debug("WebSocketService",`Handlers eliminados para evento: ${e}`))}clearAllEventHandlers(){this.customEventHandlers.clear(),Be.debug("WebSocketService","Todos los handlers de eventos personalizados eliminados")}onEvent(e,t){if(!e||!t||"function"!=typeof t)throw new Error("Datos inválidos: Se requiere un tipo de evento y una función manejadora");Be.debug("WebSocketService",`Registrando manejador para evento: ${e}`),this.customEventHandlers.has(e)||(this.cleanupOldEventTypes(),this.customEventHandlers.set(e,[]));const n=this.customEventHandlers.get(e);if(n&&(n.push(t),this.cleanupOldHandlers(e)),"connection"===e)try{t({isConnected:this.isConnected()})}catch(s){Be.error("WebSocketService","Error al emitir estado de conexión inicial:",s instanceof Error?s:new Error(String(s)))}const i=this.eventHandlers.onMessage;i&&(this.eventHandlers.onMessage=(t,n)=>{if(i(t,n,this.projectId),t.type===e&&this.customEventHandlers.has(e)){const n=this.customEventHandlers.get(e);n&&n.forEach((n=>{try{n(t.metadata||{})}catch(s){Be.error("WebSocketService",`Error al procesar evento ${e}:`,s instanceof Error?s:new Error(String(s)))}}))}})}async verifyConnection(){if(Be.info("WebSocketService","Verificando estado de conexión WebSocket"),this.isConnected())return Be.info("WebSocketService","Conexión WebSocket verificada - Activa"),!0;if(this.projectId)try{return Be.info("WebSocketService","Intentando restablecer conexión WebSocket"),this.repository.disconnect(),await new Promise((e=>setTimeout(e,500))),this.isConnected()?(await this.joinProject(),Be.info("WebSocketService","Conexión WebSocket restablecida con éxito"),!0):(Be.warn("WebSocketService","No se puede verificar conexión - WebSocket no está conectado"),!1)}catch(e){const t=e instanceof Error?e.message:"Error desconocido";return t.toLowerCase().includes("deploy not found")||t.toLowerCase().includes("project deployment not found")||t.toLowerCase().includes("eaddrnotavail")||t.toLowerCase().includes("falló después de")?Be.error("WebSocketService",`Error fatal al verificar conexión (no se reintentará): ${t}`,e instanceof Error?e:void 0):Be.error("WebSocketService",`Error al restablecer conexión WebSocket: ${t}`,e instanceof Error?e:void 0),!1}return Be.warn("WebSocketService","No se puede verificar la conexión WebSocket - No inicializada"),!1}setupConnectionWatchdog(e=6e4){const t=setInterval((()=>{this.verifyConnection().catch((e=>{const t=e instanceof Error?e.message:"Error desconocido";Be.error("WebSocketService",`Error en el watchdog de conexión: ${t}`,e instanceof Error?e:void 0)}))}),e);return()=>clearInterval(t)}}function ui(e){if(Be.debug("OptionsValidator","Validando opciones",e),e.id?(Be.debug("OptionsValidator",`Validando ID: ${e.id}`),function(e){if(!e)throw new Error("No se proporcionó ID. Para habilitar WebSocket, proporcione un ID válido.");if("string"!=typeof e||e.length>100)throw new Error("ID de chat inválido: Debe ser una cadena de menos de 100 caracteres")}(e.id)):Be.debug("OptionsValidator","No se proporcionó ID"),e.webSocketUrl){if(Be.debug("OptionsValidator",`Validando URL de WebSocket: ${e.webSocketUrl}`),"string"!=typeof e.webSocketUrl)throw Be.error("OptionsValidator","URL de WebSocket no es una cadena",void 0,{},Me.BOTH),new Error("URL de WebSocket inválida: Debe ser una cadena");if(!e.webSocketUrl.startsWith("wss://")&&!e.webSocketUrl.startsWith("ws://"))throw Be.error("OptionsValidator","URL de WebSocket no comienza con wss:// o ws://",void 0,{},Me.BOTH),new Error("URL de WebSocket inválida: Debe comenzar con wss:// o ws://");e.webSocketUrl.startsWith("ws://")&&!e.webSocketUrl.includes("localhost")&&Be.warn("OptionsValidator","Se está utilizando una conexión WebSocket no cifrada (ws://). Considere usar wss:// para conexiones seguras.",void 0,Me.BOTH)}else Be.debug("OptionsValidator","No se proporcionó URL de WebSocket");Be.debug("OptionsValidator","Validación de opciones completada con éxito")}function pi(e){const t=e.getAttribute(Xn),n=e.getAttribute("data-subtitle"),i=e.getAttribute(ei),s=e.getAttribute(ti),o=e.getAttribute("data-faq"),r=e.getAttribute(ni);let a=Le(ii),c=Le(si);a||(a=(()=>{const e=e=>{let t="";const n="abcdefghijklmnopqrstuvwxyz";for(let i=0;i<e;i++)t+=n.charAt(Math.floor(26*Math.random()));return t};return e(10)+e(10)})(),_e(ii,a)),c||(c=(()=>{const e=e=>{let t="";const n="0123456789";for(let i=0;i<e;i++)t+=n.charAt(Math.floor(10*Math.random()));return t};return e(10)+e(10)})(),_e(si,c));let l=[];if(o)try{l=JSON.parse(o)}catch(p){Be.warn("ScriptTagParser","No se pudo parsear data-faq como JSON, ignorando FAQ questions",p)}const h=e.getAttribute("data-theme-config");let d;if(h)try{d=JSON.parse(h),Be.debug("ScriptTagParser","Configuración de tema personalizada parseada",d)}catch(p){d=h,Be.debug("ScriptTagParser",`Usando tema preset: ${h}`)}Be.debug("ScriptTagParser","Atributos extraídos del script tag",{companyName:t,subtitle:n,id:i,webSocketUrl:s,name:a,from:c,faqQuestions:l,locale:r,theme:d});const u={name:a,from:c};return s&&(u.webSocketUrl=s),i&&(u.id=i),t&&(u.companyName=t),n&&(u.subtitle=n),l.length>0&&(u.faqQuestions=l),r&&["es","pt","en"].includes(r)&&(u.locale=r),d&&(u.theme=d),u}const mi=class e{constructor(){r(this,"modal",null),r(this,"styleSheet",null),r(this,"escHandler",null),r(this,"closeButtonHandler",null),r(this,"overlayHandler",null),r(this,"closeModal",(()=>{if(this.escHandler&&(document.removeEventListener("keydown",this.escHandler),this.escHandler=null),this.closeButtonHandler&&this.modal){const e=this.modal.querySelector(".bb-media-modal-close");e&&e.removeEventListener("click",this.closeButtonHandler),this.closeButtonHandler=null}if(this.overlayHandler&&this.modal){const e=this.modal.querySelector(".bb-media-modal-overlay");e&&e.removeEventListener("click",this.overlayHandler),this.overlayHandler=null}this.modal&&(this.modal.classList.add("modal-closing"),this.modal.classList.remove("modal-open"),setTimeout((()=>{this.modal&&document.body.contains(this.modal)&&(document.body.removeChild(this.modal),this.modal=null)}),300))})),this.injectModalStyles()}static getInstance(){return e.instance||(e.instance=new e),e.instance}injectModalStyles(){const e="bb-media-modal-styles";document.getElementById(e)||(this.styleSheet=document.createElement("style"),this.styleSheet.id=e,this.styleSheet.textContent="\n        @keyframes modalFadeIn {\n          from {\n            opacity: 0;\n          }\n          to {\n            opacity: 1;\n          }\n        }\n\n        @keyframes modalFadeOut {\n          from {\n            opacity: 1;\n          }\n          to {\n            opacity: 0;\n          }\n        }\n\n        @keyframes modalContentIn {\n          from {\n            opacity: 0;\n            transform: scale(0.8);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1);\n          }\n        }\n\n        @keyframes modalContentOut {\n          from {\n            opacity: 1;\n            transform: scale(1);\n          }\n          to {\n            opacity: 0;\n            transform: scale(0.8);\n          }\n        }\n\n        .bb-media-modal {\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background: rgba(0, 0, 0, 0.8);\n          z-index: 999999;\n          display: none;\n          opacity: 0;\n        }\n\n        .bb-media-modal.modal-open {\n          display: flex !important;\n          opacity: 1;\n          align-items: center;\n          justify-content: center;\n          animation: modalFadeIn 0.3s ease forwards;\n        }\n\n        .bb-media-modal.modal-closing {\n          animation: modalFadeOut 0.3s ease forwards;\n        }\n\n        .bb-media-modal-overlay {\n          position: absolute;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          cursor: pointer;\n        }\n\n        .bb-media-modal-content {\n          position: relative;\n          z-index: 1000000;\n          background: white;\n          border-radius: 8px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n          max-width: 90vw;\n          max-height: 90vh;\n          overflow: hidden;\n          opacity: 0;\n          transform: scale(0.8);\n        }\n\n        /* Soporte para modo oscuro */\n        .dark-mode .bb-media-modal-content {\n          background: #1F2937;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        }\n\n        .modal-open .bb-media-modal-content {\n          animation: modalContentIn 0.3s ease forwards;\n        }\n\n        .modal-closing .bb-media-modal-content {\n          animation: modalContentOut 0.3s ease forwards;\n        }\n\n        .bb-media-modal-content img {\n          display: block;\n          max-width: 100%;\n          max-height: 90vh;\n          object-fit: contain;\n        }\n\n        .bb-media-modal-content.video video {\n          display: block;\n          max-width: 100%;\n          max-height: 90vh;\n        }\n\n        .bb-media-modal-content.audio {\n          padding: 20px;\n          width: 400px;\n        }\n\n        .dark-mode .bb-media-modal-content.audio {\n          color: #E5E7EB;\n        }\n\n        .bb-media-modal-content.file {\n          width: 90vw;\n          height: 90vh;\n          padding: 0;\n          overflow: hidden;\n        }\n\n        .bb-media-modal-content.file iframe {\n          width: 100%;\n          height: 100%;\n          border: none;\n        }\n\n        .bb-media-modal-close {\n          position: absolute;\n          top: 10px;\n          right: 10px;\n          width: 30px;\n          height: 30px;\n          background: rgba(0, 0, 0, 0.5);\n          border: none;\n          border-radius: 50%;\n          color: white;\n          font-size: 20px;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          z-index: 1000001;\n          opacity: 0;\n          transform: scale(0.8);\n          transition: background-color 0.2s, opacity 0.3s, transform 0.3s;\n        }\n\n        .dark-mode .bb-media-modal-close {\n          background: rgba(255, 255, 255, 0.2);\n          color: #F3F4F6;\n        }\n\n        .modal-open .bb-media-modal-close {\n          opacity: 1;\n          transform: scale(1);\n        }\n\n        .bb-media-modal-close:hover {\n          background: rgba(0, 0, 0, 0.7);\n          transform: scale(1.1);\n        }\n\n        .dark-mode .bb-media-modal-close:hover {\n          background: rgba(255, 255, 255, 0.3);\n        }\n      ",document.head.appendChild(this.styleSheet))}setupModal(e){this.injectModalStyles(),this.modal=document.createElement("div"),this.modal.className="bb-media-modal",this.modal.innerHTML=`\n      <button class="bb-media-modal-close" aria-label="Cerrar modal">×</button>\n      <div class="bb-media-modal-overlay"></div>\n      ${e}\n    `,document.body.appendChild(this.modal),this.modal.offsetHeight,requestAnimationFrame((()=>{this.modal?.classList.add("modal-open")})),this.closeButtonHandler=this.closeModal,this.overlayHandler=this.closeModal,this.modal.querySelector(".bb-media-modal-close")?.addEventListener("click",this.closeButtonHandler),this.modal.querySelector(".bb-media-modal-overlay")?.addEventListener("click",this.overlayHandler),this.escHandler=e=>{"Escape"===e.key&&this.closeModal()},document.addEventListener("keydown",this.escHandler)}openImageModal(e){this.modal||this.setupModal(`\n      <div class="bb-media-modal-content">\n        <img src="${e}" alt="Media fullscreen">\n      </div>\n    `)}openVideoModal(e){this.modal||this.setupModal(`\n      <div class="bb-media-modal-content video">\n        <video src="${e}" controls autoplay>\n          <p>Tu navegador no soporta la reproducción de video.</p>\n        </video>\n      </div>\n    `)}openAudioModal(e){this.modal||this.setupModal(`\n      <div class="bb-media-modal-content audio">\n        <audio src="${e}" controls autoplay>\n          <p>Tu navegador no soporta la reproducción de audio.</p>\n        </audio>\n      </div>\n    `)}openFileModal(e,t){this.modal||this.setupModal(`\n      <div class="bb-media-modal-content file">\n        <iframe src="${e}" title="${t}"></iframe>\n      </div>\n    `)}cleanup(){this.escHandler&&(document.removeEventListener("keydown",this.escHandler),this.escHandler=null),this.closeModal(),this.styleSheet&&document.head.contains(this.styleSheet)&&(document.head.removeChild(this.styleSheet),this.styleSheet=null),e.instance=null}};r(mi,"instance",null);let gi=mi;class fi extends HTMLElement{constructor(){super(),r(this,"modalManager"),r(this,"darkModeObserver",null),this.attachShadow({mode:"open"}),this.modalManager=gi.getInstance()}static get observedAttributes(){return["src","modal"]}hasModalAttribute(){return this.hasAttribute("modal")}getSrc(){return this.getAttribute("src")}connectedCallback(){this.render()}attributeChangedCallback(){this.render()}disconnectedCallback(){setTimeout((()=>{0===document.querySelectorAll("media-image, media-video, media-audio").length&&this.modalManager.cleanup()}),0),this.darkModeObserver&&(this.darkModeObserver.disconnect(),this.darkModeObserver=null)}checkDarkMode(e){if(!this.shadowRoot)return;this.closest(".dark-mode")||document.querySelector(".dark-mode")?e.forEach((e=>{const t=this.shadowRoot?.querySelectorAll(e);t?.forEach((e=>{e.classList.add("dark-mode")}))})):e.forEach((e=>{const t=this.shadowRoot?.querySelectorAll(e);t?.forEach((e=>{e.classList.remove("dark-mode")}))}))}observeDarkMode(e){this.darkModeObserver=new MutationObserver((t=>{t.forEach((t=>{"attributes"===t.type&&"class"===t.attributeName&&this.checkDarkMode(e)}))}));const t=document.querySelector(".chat-widget-container");t&&this.darkModeObserver.observe(t,{attributes:!0})}}Ee("media-image",class extends fi{constructor(){super()}render(){const e=this.getSrc();if(!e||!this.shadowRoot)return;const t=this.hasModalAttribute();if(this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: block;\n        }\n        img {\n          max-width: 200px;\n          border-radius: 8px;\n          cursor: ${t?"pointer":"default"};\n          transition: transform 0.2s ease;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        }\n        .dark-mode img {\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n          border: 1px solid rgba(255, 255, 255, 0.1);\n        }\n        img:hover {\n          transform: ${t?"scale(1.02)":"none"};\n        }\n        a {\n          text-decoration: none;\n          color: inherit;\n        }\n      </style>\n      <div class="media-preview">\n        ${t?`<img src="${e}" alt="Imagen del mensaje" role="img" aria-label="Imagen del mensaje">`:`<a href="${e}" target="_blank" rel="noopener noreferrer" aria-label="Abrir imagen en nueva pestaña"><img src="${e}" alt="Imagen del mensaje" role="img"></a>`}\n      </div>\n    `,t){const t=this.shadowRoot.querySelector("img");t&&t.addEventListener("click",(()=>this.modalManager.openImageModal(e)))}this.checkDarkMode([".media-preview","img"]),this.observeDarkMode([".media-preview","img"])}});Ee("media-video",class extends fi{constructor(){super()}render(){const e=this.getSrc();if(!e||!this.shadowRoot)return;const t=this.hasModalAttribute();if(this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: block;\n        }\n        .media-preview {\n          cursor: ${t?"pointer":"default"};\n        }\n        video {\n          max-width: 200px;\n          border-radius: 8px;\n          background: rgba(0, 0, 0, 0.05);\n          transition: transform 0.2s ease;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        }\n        .dark-mode video {\n          background: rgba(0, 0, 0, 0.3);\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n          border: 1px solid rgba(255, 255, 255, 0.1);\n        }\n        .media-preview:hover video {\n          transform: ${t?"scale(1.02)":"none"};\n        }\n      </style>\n      <div class="media-preview" role="application" aria-label="Reproductor de video">\n        <video src="${e}" controls preload="metadata" aria-label="Video del mensaje">\n          <p>Tu navegador no soporta la reproducción de video.</p>\n        </video>\n      </div>\n    `,t){const t=this.shadowRoot.querySelector(".media-preview");t&&t.addEventListener("click",(()=>this.modalManager.openVideoModal(e)))}this.checkDarkMode([".media-preview","video"]),this.observeDarkMode([".media-preview","video"])}});Ee("media-audio",class extends fi{constructor(){super(),r(this,"audio",null),r(this,"progressBar",null),r(this,"playButton",null),r(this,"timeDisplay",null),r(this,"progressFill",null),r(this,"updateInterval",null),r(this,"handlePlay",null),r(this,"handlePause",null),r(this,"boundTogglePlay"),r(this,"boundUpdateProgress"),r(this,"boundResetPlayer"),r(this,"boundUpdateDuration"),r(this,"boundSeek"),this.boundTogglePlay=this.togglePlay.bind(this),this.boundUpdateProgress=this.updateProgress.bind(this),this.boundResetPlayer=this.resetPlayer.bind(this),this.boundUpdateDuration=this.updateDuration.bind(this),this.boundSeek=this.seek.bind(this)}connectedCallback(){super.connectedCallback(),this.setupEventListeners()}disconnectedCallback(){super.disconnectedCallback(),this.cleanupEventListeners()}setupEventListeners(){this.shadowRoot&&setTimeout((()=>{this.audio=this.shadowRoot.querySelector("audio"),this.progressBar=this.shadowRoot.querySelector(".progress-indicator"),this.progressFill=this.shadowRoot.querySelector(".progress-fill"),this.playButton=this.shadowRoot.querySelector(".play-button"),this.timeDisplay=this.shadowRoot.querySelector(".time-display"),this.audio&&this.playButton&&(this.playButton.addEventListener("click",this.boundTogglePlay),this.audio.addEventListener("timeupdate",this.boundUpdateProgress),this.audio.addEventListener("ended",this.boundResetPlayer),this.audio.addEventListener("loadedmetadata",this.boundUpdateDuration),this.handlePlay=()=>{this.playButton?.classList.add("playing")},this.handlePause=()=>{this.playButton?.classList.remove("playing")},this.audio.addEventListener("play",this.handlePlay),this.audio.addEventListener("pause",this.handlePause)),this.progressBar&&this.progressBar.addEventListener("click",this.boundSeek)}),0)}cleanupEventListeners(){this.audio&&(this.audio.removeEventListener("timeupdate",this.boundUpdateProgress),this.audio.removeEventListener("ended",this.boundResetPlayer),this.audio.removeEventListener("loadedmetadata",this.boundUpdateDuration),this.handlePlay&&(this.audio.removeEventListener("play",this.handlePlay),this.handlePlay=null),this.handlePause&&(this.audio.removeEventListener("pause",this.handlePause),this.handlePause=null)),this.playButton&&this.playButton.removeEventListener("click",this.boundTogglePlay),this.progressBar&&this.progressBar.removeEventListener("click",this.boundSeek),null!==this.updateInterval&&(window.clearInterval(this.updateInterval),this.updateInterval=null)}togglePlay(){this.audio&&(this.audio.paused?this.audio.play():this.audio.pause())}updateProgress(){if(!this.audio||!this.progressFill)return;const e=this.audio.currentTime/this.audio.duration*100;if(this.progressFill.style.transform=`translateX(${e-100}%)`,this.timeDisplay){const e=this.formatTime(this.audio.currentTime);this.timeDisplay.textContent=`${e}`}}seek(e){if(!this.audio||!this.progressBar)return;const t=this.progressBar.getBoundingClientRect(),n=(e.clientX-t.left)/t.width;this.audio.currentTime=n*this.audio.duration,this.updateProgress()}resetPlayer(){this.audio&&this.playButton&&(this.audio.currentTime=0,this.playButton.classList.remove("playing"))}updateDuration(){if(!this.audio||!this.timeDisplay)return;const e=this.formatTime(this.audio.duration);this.timeDisplay.textContent=e}formatTime(e){if(isNaN(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}getAudioFormat(e){const t=e.split(".").pop()?.toLowerCase()||"";return{mp3:"MP3",wav:"WAV",ogg:"OGG",aac:"AAC",mp4:"M4A",m4a:"M4A",flac:"FLAC",mpg:"MPEG",mpeg:"MPEG"}[t]||t.toUpperCase()}render(){const e=this.getSrc();if(!e||!this.shadowRoot)return;const t=this.hasModalAttribute(),n=this.getAudioFormat(e);this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: block;\n        }\n        .audio-player {\n          display: flex;\n          align-items: center;\n          background-color: #f9e8d8;\n          border-radius: 999px;\n          padding: 8px 14px;\n          max-width: 300px;\n          position: relative;\n          margin-bottom: 4px;\n          user-select: none;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n          border: 1px solid rgba(0, 0, 0, 0.03);\n        }\n        .dark-mode.audio-player {\n          background-color: #374151;\n          border-color: rgba(255, 255, 255, 0.1);\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);\n        }\n        .play-button {\n          background-color: #000;\n          color: white;\n          border-radius: 50%;\n          width: 30px;\n          height: 30px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          cursor: pointer;\n          margin-right: 12px;\n          flex-shrink: 0;\n          position: relative;\n        }\n        .dark-mode.play-button {\n          background-color: #4F46E5;\n          color: #F3F4F6;\n        }\n        .play-button::before {\n          content: '';\n          width: 0;\n          height: 0;\n          border-top: 6px solid transparent;\n          border-bottom: 6px solid transparent;\n          border-left: 10px solid white;\n          margin-left: 2px;\n        }\n        .play-button.playing::before {\n          content: '';\n          width: 8px;\n          height: 8px;\n          border: none;\n          background-color: white;\n          margin-left: 0;\n        }\n        .progress-container {\n          flex-grow: 1;\n          margin-right: 12px;\n          display: flex;\n          align-items: center;\n          height: 30px;\n        }\n        .progress-indicator {\n          width: 100%;\n          height: 4px;\n          background-color: rgba(0, 0, 0, 0.1);\n          border-radius: 2px;\n          overflow: hidden;\n          cursor: pointer;\n          position: relative;\n        }\n        .dark-mode .progress-indicator {\n          background-color: rgba(255, 255, 255, 0.1);\n        }\n        .progress-fill {\n          position: absolute;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background-color: #000;\n          transform: translateX(-100%);\n          transition: transform 0.1s linear;\n        }\n        .dark-mode .progress-fill {\n          background-color: #4F46E5;\n        }\n        .time-display-container {\n          display: flex;\n          flex-direction: column;\n          align-items: flex-end;\n        }\n        .time-display {\n          font-size: 12px;\n          color: #333;\n          white-space: nowrap;\n          min-width: 35px;\n          text-align: right;\n        }\n        .dark-mode .time-display {\n          color: #E5E7EB;\n        }\n        .format-display {\n          font-size: 9px;\n          color: #666;\n          text-transform: uppercase;\n          white-space: nowrap;\n        }\n        .dark-mode .format-display {\n          color: #9CA3AF;\n        }\n        audio {\n          display: none;\n        }\n        .modal-trigger {\n          font-size: 12px;\n          color: #555;\n          text-decoration: underline;\n          cursor: pointer;\n          margin-top: 2px;\n          display: inline-block;\n          text-align: center;\n          width: 100%;\n        }\n        .dark-mode .modal-trigger {\n          color: #9CA3AF;\n        }\n      </style>\n      <div class="audio-container">\n        <div class="audio-player">\n          <div class="play-button"></div>\n          <div class="progress-container">\n            <div class="progress-indicator">\n              <div class="progress-fill"></div>\n            </div>\n          </div>\n          <div class="time-display-container">\n            <span class="time-display">0:00</span>\n            <span class="format-display">${n}</span>\n          </div>\n        </div>\n        ${t?'<div class="modal-trigger">Ver en pantalla completa</div>':""}\n        <audio src="${e}"></audio>\n      </div>\n    `,t&&this.shadowRoot.querySelector(".modal-trigger")?.addEventListener("click",(()=>this.modalManager.openAudioModal(e))),this.checkDarkMode([".audio-player",".play-button",".progress-indicator",".progress-fill",".time-display",".format-display",".modal-trigger"]),this.observeDarkMode([".audio-player",".play-button",".progress-indicator",".progress-fill",".time-display",".format-display",".modal-trigger"])}});Ee("media-file",class extends fi{constructor(){super()}getFileIcon(){return'\n      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>\n        <polyline points="14 2 14 8 20 8"></polyline>\n        <line x1="9" y1="15" x2="15" y2="15"></line>\n      </svg>\n    '}getFileName(e){try{const t=new URL(e).pathname.split("/"),n=t[t.length-1];return decodeURIComponent(n)}catch(t){const n=e.split("/");return n[n.length-1]}}getFileExtension(e){const t=e.split(".");return t.length<2?"":t[t.length-1].toUpperCase()}getFormattedFileSize(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}render(){const e=this.getSrc();if(!e||!this.shadowRoot)return;const t=this.hasModalAttribute(),n=this.getFileName(e),i=this.getFileExtension(n);this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: block;\n        }\n        .file-attachment {\n          display: flex;\n          align-items: center;\n          background-color: #f5f5f5;\n          border-radius: 12px;\n          padding: 10px 16px;\n          max-width: 300px;\n          margin-bottom: 4px;\n          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\n          transition: background-color 0.2s;\n          cursor: pointer;\n          max-width: 200px;\n          text-decoration: none;\n        }\n        .dark-mode.file-attachment {\n          background-color: #1F2937;\n          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);\n        }\n        .file-attachment:hover {\n          background-color: #efefef;\n        }\n        .dark-mode.file-attachment:hover {\n          background-color: #111827;\n        }\n        .file-icon {\n          display: flex;\n          justify-content: center;\n          align-items: center;\n          width: 32px;\n          height: 32px;\n          border-radius: 50%;\n          background-color: #e6e6e6;\n          margin-right: 12px;\n          flex-shrink: 0;\n        }\n        .dark-mode .file-icon {\n          background-color: #374151;\n        }\n        .file-icon svg {\n          width: 18px;\n          height: 18px;\n          color: #666;\n        }\n        .dark-mode .file-icon svg {\n          color: #9CA3AF;\n        }\n        .file-info {\n          flex-grow: 1;\n          overflow: hidden;\n        }\n        .file-name {\n          font-size: 14px;\n          font-weight: 500;\n          color: #333;\n          white-space: nowrap;\n          overflow: hidden;\n          text-overflow: ellipsis;\n          margin: 0;\n        }\n        .dark-mode .file-name {\n          color: #E5E7EB;\n        }\n        .file-meta {\n          display: flex;\n          font-size: 10px;\n          color: #666;\n          margin-top: 2px;\n        }\n        .dark-mode .file-meta {\n          color: #9CA3AF;\n        }\n        .file-extension {\n          text-transform: uppercase;\n          margin-right: 4px;\n        }\n      </style>\n      <a href="${e}" target="_blank" download="${n}" class="file-attachment" aria-label="Descargar archivo: ${n}" role="link">\n        <div class="file-icon" aria-hidden="true">\n          ${this.getFileIcon()}\n        </div>\n        <div class="file-info">\n          <p class="file-name">${n}</p>\n          <div class="file-meta">\n            <span class="file-extension">${i}</span>\n          </div>\n        </div>\n      </a>\n    `;const s=this.shadowRoot.querySelector(".file-attachment");s&&t&&s.addEventListener("click",(t=>{t.preventDefault(),this.modalManager.openFileModal(e,n)})),this.checkDarkMode([".file-attachment",".file-icon",".file-name",".file-meta"]),this.observeDarkMode([".file-attachment",".file-icon",".file-name",".file-meta"])}});Ee("media-iframe",class extends fi{constructor(){super()}render(){const e=this.getSrc();if(!e||!this.shadowRoot)return;const t=e.replace(/^__WEB__IFRAME__/,"");this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: block;\n        }\n        .iframe-container {\n          position: relative;\n          width: 100%;\n          max-width: 100%;\n          border-radius: 8px;\n          overflow: hidden;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n          background: #ffffff;\n        }\n        .dark-mode .iframe-container {\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n          border: 1px solid rgba(255, 255, 255, 0.1);\n          background: #1F2937;\n        }\n        .iframe-wrapper {\n          position: relative;\n          width: 100%;\n          padding-bottom: 75%; /* 4:3 aspect ratio por defecto */\n          overflow: hidden;\n        }\n        iframe {\n          position: absolute;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          border: none;\n        }\n        .iframe-header {\n          display: flex;\n          align-items: center;\n          padding: 8px 12px;\n          background: #f5f5f5;\n          border-bottom: 1px solid #e0e0e0;\n          font-size: 12px;\n          color: #666;\n        }\n        .dark-mode .iframe-header {\n          background: #374151;\n          border-bottom: 1px solid #4B5563;\n          color: #9CA3AF;\n        }\n        .iframe-icon {\n          width: 16px;\n          height: 16px;\n          margin-right: 8px;\n        }\n        .iframe-url {\n          flex: 1;\n          white-space: nowrap;\n          overflow: hidden;\n          text-overflow: ellipsis;\n        }\n        .open-link {\n          display: inline-flex;\n          align-items: center;\n          padding: 4px 8px;\n          background: #e0e0e0;\n          border-radius: 4px;\n          text-decoration: none;\n          color: #333;\n          font-size: 11px;\n          transition: background 0.2s;\n          margin-left: 8px;\n        }\n        .dark-mode .open-link {\n          background: #4B5563;\n          color: #E5E7EB;\n        }\n        .open-link:hover {\n          background: #d0d0d0;\n        }\n        .dark-mode .open-link:hover {\n          background: #374151;\n        }\n        .open-icon {\n          width: 12px;\n          height: 12px;\n          margin-left: 4px;\n        }\n      </style>\n      <div class="iframe-container">\n        <div class="iframe-header">\n          <svg class="iframe-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>\n            <line x1="8" y1="21" x2="16" y2="21"></line>\n            <line x1="12" y1="17" x2="12" y2="21"></line>\n          </svg>\n          <span class="iframe-url" title="${t}">${t}</span>\n          <a href="${t}" target="_blank" rel="noopener noreferrer" class="open-link" aria-label="Abrir en nueva pestaña">\n            Abrir\n            <svg class="open-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n              <polyline points="15 3 21 3 21 9"></polyline>\n              <line x1="10" y1="14" x2="21" y2="3"></line>\n            </svg>\n          </a>\n        </div>\n        <div class="iframe-wrapper">\n          <iframe \n            src="${t}" \n            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"\n            loading="lazy"\n            title="Contenido embebido"\n            aria-label="Frame embebido de ${t}"\n          ></iframe>\n        </div>\n      </div>\n    `,this.checkDarkMode([".iframe-container",".iframe-header",".open-link"]),this.observeDarkMode([".iframe-container",".iframe-header",".open-link"])}});class bi extends HTMLElement{constructor(){super(),r(this,"shadow"),this.shadow=this.attachShadow({mode:"open"});const e=document.createElement("div");e.className="chat-widget-container",this.shadow.appendChild(e)}connectedCallback(){}disconnectedCallback(){}injectStyles(e){const t=document.createElement("style");t.textContent=e,this.shadow.insertBefore(t,this.shadow.firstChild)}getContainer(){return this.shadow.querySelector(".chat-widget-container")}getShadowRoot(){return this.shadow}}Ee("chat-widget-container",bi);const yi=()=>{const e=()=>`toast-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t=(t,n="info")=>{const i=e();switch(n){case"info":Be.info("Toast",t,void 0,Me.CONSOLE);break;case"success":Be.info("Toast",`✓ ${t}`,void 0,Me.CONSOLE);break;case"warning":Be.warn("Toast",t,void 0,Me.CONSOLE);break;case"error":Be.error("Toast",t,void 0,void 0,Me.CONSOLE)}return i};return t.info=t=>{const n=e();return Be.info("Toast",t,void 0,Me.CONSOLE),n},t.success=t=>{const n=e();return Be.info("Toast",`✓ ${t}`,void 0,Me.CONSOLE),n},t.warning=t=>{const n=e();return Be.warn("Toast",t,void 0,Me.CONSOLE),n},t.error=t=>{const n=e();return Be.error("Toast",t,void 0,void 0,Me.CONSOLE),n},t},vi=()=>{if("undefined"==typeof window)return;const e="undefined"!=typeof window&&"true"===window.localStorage?.getItem("builderbot_debug");Be.configure({minLevel:e?Ae.DEBUG:Ae.WARN,userMessageHandler:(e,t)=>{t>=Ae.ERROR&&Be.log(t,"GlobalErrorHandler",e,void 0,void 0,Me.CONSOLE)}})},wi=()=>"undefined"!=typeof document&&"undefined"!=typeof window;let ki=null,xi=null;const Ei=()=>{ki=null,xi=null},Si=(e,t)=>{Be.debug("BuilderBotChat:createWebSocketService","Configurando Socket.IO");const n={maxReconnectAttempts:oi.MAX_RECONNECT_ATTEMPTS,reconnectDelay:oi.RECONNECT_DELAY,connectionTimeout:oi.CONNECTION_TIMEOUT,autoReconnect:oi.AUTO_RECONNECT,maxMessageSize:oi.MAX_MESSAGE_SIZE,socketUrl:oi.DEFAULT_URL,heartbeatTimeout:oi.HEARTBEAT_INTERVAL};Be.debug("BuilderBotChat:createWebSocketService","Creando SocketIoRepository",n);const i=new hn(n),s={messageRateLimit:e.performance?.messageRateLimit||ri},o=((e,t)=>({onMessage:(n,i,s)=>{if(e.id!==s||e.from!==i)return;const o=n.timestamp?new Date(n.timestamp):new Date;t.addSystemMessage(n.content,{media:n.media,timestamp:o})},onUnmountWebchat:e=>{e.enabled?t.showChatButton():t.unmount()},onTyping:(n,i)=>{e.from===i&&t.handleTypingEvent(!0,i)}}))(e,t);Be.debug("BuilderBotChat:createWebSocketService","Creando WebSocketService",s);const r=new di(i,o,s),a=e.webSocketUrl||oi.DEFAULT_URL;return Be.info("BuilderBotChat:createWebSocketService",`Usando URL de WebSocket: ${a}`),{webSocketService:r,webSocketUrl:a}},Ci=async e=>{Be.info("BuilderBotChat","Iniciando con opciones",e);try{if(vi(),await je("https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"),!wi())return Be.error("BuilderBotChat","Este componente solo puede ejecutarse en un entorno de navegador.",void 0,{},Me.BOTH),null;if(ki)return Be.warn("BuilderBotChat","Ya existe una instancia de chat inicializada. Retornando instancia existente."),ki;if(xi)return Be.warn("BuilderBotChat","Ya hay una inicialización en curso. Esperando a que termine..."),await xi;if("undefined"!=typeof document){const e=document.querySelector("chat-widget-button"),t=document.querySelector("chat-widget-container");if(e||t)return Be.warn("BuilderBotChat","Ya existe un widget de chat montado en el DOM. Ignorando nueva inicialización para prevenir duplicados."),null}try{ui(e),Be.debug("BuilderBotChat","Opciones validadas correctamente")}catch(t){throw t instanceof Error&&Be.error("BuilderBotChat",`Opciones inválidas: ${t.message}`,t,{},Me.BOTH),t}if(!e.id)throw Be.error("BuilderBotChat","No se proporcionó ID, creando ChatService sin WebSocket."),new Error("No se proporcionó ID, creando ChatService sin WebSocket.");return xi=(async()=>{try{Be.debug("BuilderBotChat","Creando instancia de ChatWidget");const n=new Yn(e,null),{webSocketService:i,webSocketUrl:s}=Si(e,n);let o;try{o=new dn,Be.info("BuilderBotChat","Repositorio de almacenamiento (IndexedDB) inicializado")}catch(t){Be.warn("BuilderBotChat","No se pudo inicializar IndexedDB, continuando sin almacenamiento local",t),o=void 0}const r=new hi(e.id,i,s,o);return n.updateChatService(r),Be.debug("BuilderBotChat","Montando chat en el DOM"),await n.mount(),ki=n,Be.info("BuilderBotChat","Chat inicializado y listo"),n}catch(t){throw xi=null,t}finally{xi=null}})(),await xi}catch(t){return xi=null,t instanceof Error?Be.fatal("BuilderBotChat",`Error crítico al inicializar el chat: ${t.message}`,t,{},Me.BOTH):Be.fatal("BuilderBotChat","Error crítico desconocido al inicializar el chat",void 0,{error:t},Me.BOTH),null}},Ti=e=>{document.body?e():setTimeout((()=>Ti(e)),50)},Ai=async()=>{Be.debug("BuilderBotChat:initChatWhenReady","Buscando script tag para inicialización automática");const e=document.querySelector(Zn);if(e){Be.debug("BuilderBotChat:initChatWhenReady","Script tag encontrado para inicialización automática");try{const t=pi(e);if(!t.id)throw new Error("ID no proporcionado");Be.debug("BuilderBotChat:initChatWhenReady","Opciones configuradas para inicialización automática",t),Be.info("BuilderBotChat:initChatWhenReady","Iniciando chat automáticamente"),await Ci(t)}catch(t){t instanceof Error?Be.error("BuilderBotChat:initChatWhenReady",`Error al inicializar el chat: ${t.message}`,t,{},Me.BOTH):Be.error("BuilderBotChat:initChatWhenReady","Error desconocido al inicializar el chat",void 0,{error:t},Me.BOTH)}}else Be.debug("BuilderBotChat:initChatWhenReady","No se encontró script tag para inicialización automática")};if(wi()){vi();const e=Hn();Vn.forEach(((t,n)=>{e.registerPreset(n,t),Be.debug("BuilderBotChat",`Preset de tema registrado: ${n}`)})),window.BuilderBotChat={init:Ci,ChatWidget:Yn,logger:Be,toast:yi(),utils:{normalizeSpecialChars:fe},Theme:Nn,ThemeManager:Dn,getThemeManager:Hn,_getThemeManager:Hn,debug:{enable:()=>{Be.setDebugMode(!0),ln.setDebugMode(!0)},disable:()=>{Be.setDebugMode(!1),ln.setDebugMode(!1)},status:()=>Be.getDebugMode()},_clearGlobalInstance:Ei},"loading"===document.readyState?(Be.debug("BuilderBotChat","DOM cargando, configurando listener para DOMContentLoaded"),document.addEventListener("DOMContentLoaded",(()=>Ti(Ai)))):(Be.debug("BuilderBotChat","DOM ya cargado, verificando disponibilidad de document.body"),Ti(Ai))}const Mi={init:Ci,ChatWidget:Yn,logger:Be,toast:yi(),utils:{normalizeSpecialChars:fe},debug:{enable:()=>{Be.setDebugMode(!0),ln.setDebugMode(!0)},disable:()=>{Be.setDebugMode(!1),ln.setDebugMode(!1)},status:()=>Be.getDebugMode()},_clearGlobalInstance:Ei};e.ChatService=hi,e.ChatWidget=Yn,e.IndexedDBRepository=dn,e.SocketIoRepository=hn,e.WebSocketService=di,e.default=Mi,e.initBuilderBotChat=Ci,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
